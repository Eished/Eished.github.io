<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Node.js搭建博客, Web,technology,CSS,HTML,JavaScript,Vue">
    <meta name="description" content="Web technology CSS HTML JavaScript Vue Node.js">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>Node.js搭建博客 | Eish&#39;s blog</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="Eish's blog" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Eish&#39;s blog</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Eish&#39;s blog</div>
        <div class="logo-desc">
            
            Web technology CSS HTML JavaScript Vue Node.js
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/Eished" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/Eished" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/6.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Node.js搭建博客</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        height: calc(100vh - 250px);
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/JavaScript/">
                                <span class="chip bg-color">JavaScript</span>
                            </a>
                        
                            <a href="/tags/Node-js/">
                                <span class="chip bg-color">Node.js</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Node-js/" class="post-category">
                                Node.js
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2020-06-03
                </div>
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    17.1k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    85 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="Node-js搭建博客"><a href="#Node-js搭建博客" class="headerlink" title="Node.js搭建博客"></a><a href="https://github.com/Eished/node_blog_notes" target="_blank" rel="noopener">Node.js搭建博客</a></h1><h2 id="开发接口（不用框架）"><a href="#开发接口（不用框架）" class="headerlink" title="开发接口（不用框架）"></a>开发接口（不用框架）</h2><h3 id="http请求概述"><a href="#http请求概述" class="headerlink" title="http请求概述"></a>http请求概述</h3><ul>
<li>DNS 解析，建立 TCP 连接，发送 http 请求</li>
<li>server 接收到 http 请求，处理并返回数据</li>
<li>客户端接收到返回数据，处理数据（例如渲染、执行JS）</li>
</ul>
<h3 id="Node-js-处理http-请求"><a href="#Node-js-处理http-请求" class="headerlink" title="Node.js 处理http 请求"></a>Node.js 处理http 请求</h3><ul>
<li>get 请求和 querystring</li>
<li>post 请求和 postdata</li>
<li>路由（接口、地址）</li>
</ul>
<pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span>res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'hello world!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//浏览器访问 http://localhost:8000/</span></code></pre>
<h4 id="Node-js-处理-get-请求"><a href="#Node-js-处理-get-请求" class="headerlink" title="Node.js 处理 get 请求"></a>Node.js 处理 get 请求</h4><ul>
<li>get  请求，客户端向 server 端获取数据，如查询博客列表</li>
<li>通过 querystring 来传递数据，如 a.html?a=100&amp;b=200</li>
<li>浏览器直接访问，发送 get 请求</li>
</ul>
<pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> querystring <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'querystring'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span>res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>method<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//GET</span>
    <span class="token keyword">const</span> url <span class="token operator">=</span> req<span class="token punctuation">.</span>url <span class="token comment" spellcheck="true">//获取请求的完整 URL</span>
    <span class="token comment" spellcheck="true">//关键解析[0]是'?'前的内容, [1]是'?'后内容</span>
    req<span class="token punctuation">.</span>query <span class="token operator">=</span> querystring<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>query<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//将 querystring 返回</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//浏览器访问 http://localhost:8000/</span></code></pre>
<h4 id="Node-js-处理-post-请求"><a href="#Node-js-处理-post-请求" class="headerlink" title="Node.js 处理 post 请求"></a>Node.js 处理 post 请求</h4><ul>
<li>post 请求，即客户端要像服务端传递数据，如新建博客</li>
<li>通过 post data 传递数据，后面解释</li>
<li>浏览器无法直接模拟，需要手写JS，或者使用 postman app</li>
</ul>
<pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">'POST'</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
        <span class="token comment" spellcheck="true">// POST 必须大写</span>
        <span class="token comment" spellcheck="true">//数据格式</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'content-type: '</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'content-type'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">//接收数据</span>
        <span class="token keyword">let</span> postData <span class="token operator">=</span> <span class="token string">''</span>
        <span class="token comment" spellcheck="true">//开始接收数据</span>
        req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> chunk <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
            postData <span class="token operator">+</span><span class="token operator">=</span> chunk<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">//结束数据接收</span>
        req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span>， <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'postData:'</span><span class="token punctuation">,</span> postData<span class="token punctuation">)</span>
            res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'hello world!'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//在这里返回，因为是异步</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span></code></pre>
<h4 id="Node-js-处理路由"><a href="#Node-js-处理路由" class="headerlink" title="Node.js 处理路由"></a>Node.js 处理路由</h4><ul>
<li><code>https://github.com/username/xxx</code> 每个斜线后面的唯一标识就是路由</li>
</ul>
<h4 id="Node-js-综合应用"><a href="#Node-js-综合应用" class="headerlink" title="Node.js 综合应用"></a>Node.js 综合应用</h4><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> querystring <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'querystring'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> method <span class="token operator">=</span> req<span class="token punctuation">.</span>method
    <span class="token keyword">const</span> url <span class="token operator">=</span> req<span class="token punctuation">.</span>url
    <span class="token keyword">const</span> path <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token comment" spellcheck="true">//重点：split('?'[0])语法弄清楚</span>
    <span class="token keyword">const</span> query <span class="token operator">=</span> querystring<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">//设置返回值格式为 JSON</span>
    res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-type'</span><span class="token punctuation">,</span> <span class="token string">'application/json'</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">//返回的数据</span>
    <span class="token keyword">const</span> resData <span class="token operator">=</span> <span class="token punctuation">{</span>
        method<span class="token punctuation">,</span>
        url<span class="token punctuation">,</span>
        path<span class="token punctuation">,</span>
        query
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//返回</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">===</span> <span class="token string">'GET'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>
            JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>query<span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">'POST'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">let</span> postData <span class="token operator">=</span> <span class="token string">''</span>
        <span class="token comment" spellcheck="true">//res.on('data')指每次发送的数据</span>
        <span class="token comment" spellcheck="true">//chunk 逐步接收数据 req绑定一个data方法 chunk是变量</span>
        req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> chunk <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
            postData <span class="token operator">+</span><span class="token operator">=</span> chunk<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">//req.on(end)数据发送完成；</span>
        req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'postData:'</span><span class="token punctuation">,</span> postData<span class="token punctuation">)</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'resData:'</span><span class="token punctuation">,</span> resData<span class="token punctuation">)</span>
            resData<span class="token punctuation">.</span>postData <span class="token operator">=</span> postData
            <span class="token comment" spellcheck="true">//返回</span>
            res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>
                JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>resData<span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'OK'</span><span class="token punctuation">)</span></code></pre>
<h3 id="搭建开发环境"><a href="#搭建开发环境" class="headerlink" title="搭建开发环境"></a>搭建开发环境</h3><ul>
<li>从零搭建，不使用框架</li>
<li>使用 nodemon 监测文件变化，自动重启 node</li>
<li>使用 cross-env 设置环境变量，兼容Mac Linux 和 Windows</li>
<li>配置完后使用 <code>$ npm run dev</code> 命令启动项目</li>
</ul>
<h4 id="开始搭建"><a href="#开始搭建" class="headerlink" title="开始搭建"></a>开始搭建</h4><p><strong>使用npm安装上述插件，设置npm镜像源</strong></p>
<ol>
<li><p>查看npm源地址<br> <code>npm config list</code></p>
</li>
<li><p>结果:<br> <code>metrics-registry = &quot;http://registry.npm.taobao.org/&quot;</code></p>
</li>
<li><p>修改registry地址，比如修改为淘宝镜像源。<br> <code>npm set registry https://registry.npm.taobao.org/</code><br> 如果有一天你肉身FQ到国外，用不上了，用rm命令删掉它<br> <code>npm config rm registry</code></p>
</li>
<li><p><code>npm install -g nodemon</code></p>
</li>
<li><p><code>npm install -g cross-env</code></p>
</li>
</ol>
<p><strong>新建文件夹blog_1，在里面新建bin文件夹和app.js，在bin里面新建<a href="http://www.js文件" target="_blank" rel="noopener">www.js文件</a></strong></p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// package.json 代码 注意： =不能有空格</span>
<span class="token punctuation">{</span>
  <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"blog_1"</span><span class="token punctuation">,</span>
  <span class="token string">"version"</span><span class="token punctuation">:</span> <span class="token string">"1.0.0"</span><span class="token punctuation">,</span>
  <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
  <span class="token string">"main"</span><span class="token punctuation">:</span> <span class="token string">"www.js"</span><span class="token punctuation">,</span>
  <span class="token string">"scripts"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">"test"</span><span class="token punctuation">:</span> <span class="token string">"echo \"Error: no test specified\" &amp;&amp; exit 1"</span><span class="token punctuation">,</span>
    <span class="token string">"dev"</span><span class="token punctuation">:</span> <span class="token string">"cross-env NODE_ENV=dev nodemon ./bin/www.js"</span><span class="token punctuation">,</span>
    <span class="token string">"prd"</span><span class="token punctuation">:</span> <span class="token string">"cross-env NODE_ENV=production nodemon ./bin/www.js"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">"author"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
  <span class="token string">"license"</span><span class="token punctuation">:</span> <span class="token string">"ISC"</span>
<span class="token punctuation">}</span></code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ./bin/www.js 代码</span>
<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> PORT <span class="token operator">=</span> <span class="token number">300</span>
<span class="token keyword">const</span> serverHandle <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../app'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span>serverHandle<span class="token punctuation">)</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>PORT<span class="token punctuation">)</span></code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// app.js 代码</span>
<span class="token keyword">const</span> handleBlogRouter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./src/router/blog'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> handleUserRouter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./src/router/user'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> serverHandle <span class="token operator">=</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//设置返回值格式 JSON</span>
    res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-type'</span><span class="token punctuation">,</span> <span class="token string">'application/json'</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// const resData = {</span>
    <span class="token comment" spellcheck="true">//     name: 'zhang',</span>
    <span class="token comment" spellcheck="true">//     site: 'imooc',</span>
    <span class="token comment" spellcheck="true">//     env: process.env.NODE_ENV</span>
    <span class="token comment" spellcheck="true">// }</span>

    <span class="token comment" spellcheck="true">// res.end(</span>
    <span class="token comment" spellcheck="true">//     JSON.stringify(resData)</span>
    <span class="token comment" spellcheck="true">// )</span>

    <span class="token comment" spellcheck="true">//处理 blog 路由</span>
    <span class="token keyword">const</span> blogData <span class="token operator">=</span> <span class="token function">handleBlogRouter</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>blogData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>
            JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>blogData<span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//处理 user 路由</span>
    <span class="token keyword">const</span> userData <span class="token operator">=</span> <span class="token function">handleUserRouter</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>userData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>
            JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>userData<span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//未命中路由，返回404</span>
    res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">"Content-type"</span><span class="token punctuation">:</span> <span class="token string">"text/plain"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"404 Not Found\n"</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> serverHandle</code></pre>
<h3 id="开发接口"><a href="#开发接口" class="headerlink" title="开发接口"></a>开发接口</h3><h4 id="初始化路由"><a href="#初始化路由" class="headerlink" title="初始化路由"></a>初始化路由</h4><ul>
<li>初始化路由：根据之前设计方案，做出路由</li>
<li>返回假数据：将路由和数据处理分离，以符合设计原则</li>
</ul>
<h4 id="接口设计方案"><a href="#接口设计方案" class="headerlink" title="接口设计方案"></a>接口设计方案</h4><table>
<thead>
<tr>
<th>描述</th>
<th>接口</th>
<th>方法</th>
<th>url参数</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>获取博客列表</td>
<td>/api/blog/list</td>
<td>get</td>
<td>author 作者，keyword 搜索关键字</td>
<td>参数为空则不进行查询过滤</td>
</tr>
<tr>
<td>获取一篇博客的内容</td>
<td>/api/blog/detail</td>
<td>get</td>
<td>id</td>
<td></td>
</tr>
<tr>
<td>新增一篇博客</td>
<td>/api/blog/new</td>
<td>post</td>
<td></td>
<td>post 中有新增的信息</td>
</tr>
<tr>
<td>更新一篇博客</td>
<td>/api/blog/update</td>
<td>post</td>
<td>id</td>
<td>postData 中有更新信息</td>
</tr>
<tr>
<td>删除一篇博客</td>
<td>/api/blog/del</td>
<td>post</td>
<td>id</td>
<td></td>
</tr>
<tr>
<td>登录</td>
<td>/api/user/login</td>
<td>post</td>
<td></td>
<td>postData 中有用户名和密码</td>
</tr>
</tbody></table>
<p>具体代码：</p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// ./src/router/user.js</span>
<span class="token keyword">const</span> handleUserRouter <span class="token operator">=</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> method <span class="token operator">=</span> req<span class="token punctuation">.</span>method <span class="token comment" spellcheck="true">//GET POST</span>

    <span class="token comment" spellcheck="true">//登录</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">===</span> <span class="token string">'POST'</span> <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">'/api/user/login'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            msg<span class="token punctuation">:</span> <span class="token string">'这是登录的接口'</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> handleUserRouter

<span class="token comment" spellcheck="true">// ./src/router/blog.js</span>
<span class="token keyword">const</span> handleUserRouter <span class="token operator">=</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> method <span class="token operator">=</span> req<span class="token punctuation">.</span>method <span class="token comment" spellcheck="true">//GET POST</span>

    <span class="token comment" spellcheck="true">//登录</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">===</span> <span class="token string">'POST'</span> <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">'/api/user/login'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            msg<span class="token punctuation">:</span> <span class="token string">'这是登录的接口'</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> handleUserRouter</code></pre>
<h4 id="开发路由-博客列表"><a href="#开发路由-博客列表" class="headerlink" title="开发路由 博客列表"></a>开发路由 博客列表</h4><ol>
<li><p>业务分层 拆分业务</p>
<ul>
<li>createServer 业务单独放在 <code>./bin/www.js</code></li>
<li>系统基本设置、基本信息 <code>app.js</code> 放在根目录</li>
<li>路由功能 <code>./src/router/xxx.js</code></li>
<li>数据管理 <code>./src/contoller/xxx.js</code></li>
<li>数据处理</li>
</ul>
</li>
<li><p>博客列表代码</p>
<pre class=" language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// ./app.js </span>
<span class="token keyword">const</span> handleBlogRouter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./src/router/blog'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> handleUserRouter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./src/router/user'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> querystring <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'querystring'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> serverHandle <span class="token operator">=</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//设置返回值格式 JSON</span>
    res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-type'</span><span class="token punctuation">,</span> <span class="token string">'application/json'</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// 获取 path</span>
    <span class="token keyword">const</span> url <span class="token operator">=</span> req<span class="token punctuation">.</span>url
    req<span class="token punctuation">.</span>path <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

    <span class="token comment" spellcheck="true">//解析 query</span>
    req<span class="token punctuation">.</span>query <span class="token operator">=</span> querystring<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// const resData = {</span>
    <span class="token comment" spellcheck="true">//     name: 'zhang',</span>
    <span class="token comment" spellcheck="true">//     site: 'imooc',</span>
    <span class="token comment" spellcheck="true">//     env: process.env.NODE_ENV</span>
    <span class="token comment" spellcheck="true">// }</span>

    <span class="token comment" spellcheck="true">// res.end(</span>
    <span class="token comment" spellcheck="true">//     JSON.stringify(resData)</span>
    <span class="token comment" spellcheck="true">// )</span>

    <span class="token comment" spellcheck="true">//处理 blog 路由</span>
    <span class="token keyword">const</span> blogData <span class="token operator">=</span> <span class="token function">handleBlogRouter</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>blogData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>
            JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>blogData<span class="token punctuation">)</span>
            <span class="token comment" spellcheck="true">// JSON.stringify({</span>
            <span class="token comment" spellcheck="true">//     errno: -1,</span>
            <span class="token comment" spellcheck="true">//     message: '传输失败'</span>
            <span class="token comment" spellcheck="true">// })</span>
        <span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//处理 user 路由</span>
    <span class="token keyword">const</span> userData <span class="token operator">=</span> <span class="token function">handleUserRouter</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>userData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>
            JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>userData<span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//未命中路由，返回404</span>
    res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">"Content-type"</span><span class="token punctuation">:</span> <span class="token string">"text/plain"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"404 Not Found\n"</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> serverHandle</code></pre>
<pre class=" language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// ./src/controller/blog.js</span>
<span class="token keyword">const</span> getList <span class="token operator">=</span> <span class="token punctuation">(</span>author<span class="token punctuation">,</span> keyword<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//先返回假数据(格式正确)</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            title<span class="token punctuation">:</span> <span class="token string">'标题A'</span><span class="token punctuation">,</span>
            content<span class="token punctuation">:</span> <span class="token string">'内容A'</span><span class="token punctuation">,</span>
            createTime<span class="token punctuation">:</span> <span class="token number">20191101</span><span class="token punctuation">,</span>
            author<span class="token punctuation">:</span> <span class="token string">'zhangsan'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            id<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
            title<span class="token punctuation">:</span> <span class="token string">'标题2'</span><span class="token punctuation">,</span>
            content<span class="token punctuation">:</span> <span class="token string">'内容2'</span><span class="token punctuation">,</span>
            createTime<span class="token punctuation">:</span> <span class="token number">20191102</span><span class="token punctuation">,</span>
            author<span class="token punctuation">:</span> <span class="token string">'zhangsan2'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            id<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
            title<span class="token punctuation">:</span> <span class="token string">'标题3'</span><span class="token punctuation">,</span>
            content<span class="token punctuation">:</span> <span class="token string">'内容3'</span><span class="token punctuation">,</span>
            createTime<span class="token punctuation">:</span> <span class="token number">20191103</span><span class="token punctuation">,</span>
            author<span class="token punctuation">:</span> <span class="token string">'zhangsan3'</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> getDetail <span class="token operator">=</span> <span class="token punctuation">(</span> id <span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//先返回假数据(格式正确)</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        id<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
        title<span class="token punctuation">:</span> <span class="token string">'标题3'</span><span class="token punctuation">,</span>
        content<span class="token punctuation">:</span> <span class="token string">'内容3'</span><span class="token punctuation">,</span>
        createTime<span class="token punctuation">:</span> <span class="token number">20191103</span><span class="token punctuation">,</span>
        author<span class="token punctuation">:</span> <span class="token string">'zhangsan3'</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    getList<span class="token punctuation">,</span>
    getDetail
<span class="token punctuation">}</span></code></pre>
<pre class=" language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// ./src/router/blog.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> getList<span class="token punctuation">,</span> getDetail <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../controller/blog'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> SuccessModel<span class="token punctuation">,</span> ErrorModel <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../model/resModel'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> handleBlogRouter <span class="token operator">=</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> method <span class="token operator">=</span> req<span class="token punctuation">.</span>method <span class="token comment" spellcheck="true">//GET POST</span>

    <span class="token comment" spellcheck="true">//获取博客列表</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">===</span> <span class="token string">'GET'</span> <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">'/api/blog/list'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> author <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>author <span class="token operator">||</span> <span class="token string">''</span>
        <span class="token keyword">const</span> keyword <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>keyword <span class="token operator">||</span> <span class="token string">''</span>
        <span class="token keyword">const</span> listData <span class="token operator">=</span> <span class="token function">getList</span><span class="token punctuation">(</span>author<span class="token punctuation">,</span> keyword<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SuccessModel</span><span class="token punctuation">(</span>listData<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// return {</span>
        <span class="token comment" spellcheck="true">//     msg: '这是博客列表的接口'</span>
        <span class="token comment" spellcheck="true">// }</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//获取博客详情</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">===</span> <span class="token string">'GET'</span> <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>path <span class="token operator">===</span><span class="token string">'/api/blog/detail'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> id <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>id
        <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token function">getDetail</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SuccessModel</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//新建博客</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">===</span> <span class="token string">'POST'</span> <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">'/api/blog/new'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            msg<span class="token punctuation">:</span> <span class="token string">'这是新建博客的接口'</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//更新博客</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">===</span> <span class="token string">'POST'</span> <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">'/api/blog/update'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            msg<span class="token punctuation">:</span> <span class="token string">'这是更新博客的接口'</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//删除博客</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">===</span> <span class="token string">'POST'</span> <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">'/api/blog/del'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            msg<span class="token punctuation">:</span> <span class="token string">'这是删除博客的接口'</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> handleBlogRouter</code></pre>
<pre class=" language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// ./src/model/resModel.js</span>
<span class="token keyword">class</span> <span class="token class-name">BaseModel</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> data <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>message <span class="token operator">=</span> data
            data <span class="token operator">=</span> <span class="token keyword">null</span>
            message <span class="token operator">=</span> <span class="token keyword">null</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>data <span class="token operator">=</span> data
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>message <span class="token operator">=</span> message
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">SuccessModel</span> <span class="token keyword">extends</span> <span class="token class-name">BaseModel</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> message<span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>errno <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">ErrorModel</span> <span class="token keyword">extends</span> <span class="token class-name">BaseModel</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> message<span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>errno <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    SuccessModel<span class="token punctuation">,</span>
    ErrorModel
<span class="token punctuation">}</span></code></pre>
</li>
</ol>
<h4 id="开发路由-博客详情"><a href="#开发路由-博客详情" class="headerlink" title="开发路由 博客详情"></a>开发路由 博客详情</h4><ul>
<li><p>博客代码同上一章</p>
</li>
<li><p>使用 promise 读取文件，避免 callback-hell</p>
</li>
</ul>
<pre class=" language-javascript"><code class="language-javascript">  <span class="token keyword">const</span> fs <span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
  <span class="token comment" spellcheck="true">/*
  // callback 方式获取一个文件的内容
  function getFileContent(fileName, callback) {
      //resolve 方法拼接文件目录，带引号的是字符串，不带的是变量 
      const fullFileName = path.resolve(__dirname, 'files', fileName) 
  fs.readFile(fullFileName, (err, data) => {
      if (err) {
          console.error(err)
          return
      }
      callback(
          JSON.parse(data.toString())
      )
  })

  }

  //测试 callback-hell
  getFileContent('a.json', aData => {
      console.log('a data', aData)
      getFileContent(aData.next, bData => {
          console.log('b data', bData)
          getFileContent(bData.next, cData => {
          console.log('c data', cData)
          })
      })
  })*/</span>

  <span class="token comment" spellcheck="true">//用 promise 获取文件内容</span>
  <span class="token keyword">function</span> <span class="token function">getFileContent</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> fullFileName <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'files'</span><span class="token punctuation">,</span> fileName<span class="token punctuation">)</span> 
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fullFileName：'</span><span class="token punctuation">,</span> fullFileName<span class="token punctuation">)</span>

          fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>fullFileName<span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> data<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
                  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'出错了'</span><span class="token punctuation">)</span>
                  <span class="token keyword">return</span>
              <span class="token punctuation">}</span>
              <span class="token function">resolve</span><span class="token punctuation">(</span>
                  JSON<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
              <span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> promise
  <span class="token punctuation">}</span>

  <span class="token function">getFileContent</span><span class="token punctuation">(</span><span class="token string">'a.json'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>aData <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'a data'</span><span class="token punctuation">,</span> aData<span class="token punctuation">)</span>
      <span class="token comment" spellcheck="true">//返回文件名 b.json</span>
      <span class="token keyword">return</span> <span class="token function">getFileContent</span><span class="token punctuation">(</span>aData<span class="token punctuation">.</span>next<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>bData <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'b Data'</span><span class="token punctuation">,</span> bData<span class="token punctuation">)</span>
      <span class="token comment" spellcheck="true">//返回文件名 c.json</span>
      <span class="token keyword">return</span> <span class="token function">getFileContent</span><span class="token punctuation">(</span>bData<span class="token punctuation">.</span>next<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>cData <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'c Data'</span><span class="token punctuation">,</span> cData<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment" spellcheck="true">// async await 获取内容</span>
  <span class="token comment" spellcheck="true">// koa2 获取内容</span></code></pre>
<h4 id="开发路由-（处理POSTData）"><a href="#开发路由-（处理POSTData）" class="headerlink" title="开发路由 （处理POSTData）"></a>开发路由 （处理POSTData）</h4><pre class=" language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// app.js 代码</span>
<span class="token keyword">const</span> handleBlogRouter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./src/router/blog'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> handleUserRouter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./src/router/user'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> querystring <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'querystring'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">//用于处理 post data</span>
<span class="token keyword">const</span> getPostData <span class="token operator">=</span> <span class="token punctuation">(</span>req<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">!==</span> <span class="token string">'POST'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'content-type'</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">'application/json'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">let</span> postData <span class="token operator">=</span> <span class="token string">''</span>
        <span class="token comment" spellcheck="true">//开始接收数据</span>
        req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> chunk <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
            postData <span class="token operator">+</span><span class="token operator">=</span> chunk<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">//结束接收数据</span>
        req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>postData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span>
                JSON<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>postData<span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> promise
<span class="token punctuation">}</span>

<span class="token keyword">const</span> serverHandle <span class="token operator">=</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//设置返回值格式 JSON</span>
    res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-type'</span><span class="token punctuation">,</span> <span class="token string">'application/json'</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// 获取 path</span>
    <span class="token keyword">const</span> url <span class="token operator">=</span> req<span class="token punctuation">.</span>url
    req<span class="token punctuation">.</span>path <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

    <span class="token comment" spellcheck="true">//解析 query</span>
    req<span class="token punctuation">.</span>query <span class="token operator">=</span> querystring<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">//处理 postData</span>
    <span class="token function">getPostData</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>postData <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        req<span class="token punctuation">.</span>body <span class="token operator">=</span> postData

        <span class="token comment" spellcheck="true">//处理 blog 路由</span>
        <span class="token keyword">const</span> blogData <span class="token operator">=</span> <span class="token function">handleBlogRouter</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>blogData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>
                JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>blogData<span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// JSON.stringify({</span>
                <span class="token comment" spellcheck="true">//     errno: -1,</span>
                <span class="token comment" spellcheck="true">//     message: '传输失败'</span>
                <span class="token comment" spellcheck="true">// })</span>
            <span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">//处理 user 路由</span>
        <span class="token keyword">const</span> userData <span class="token operator">=</span> <span class="token function">handleUserRouter</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>userData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>
                JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>userData<span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">//未命中路由，返回404</span>
        res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">"Content-type"</span><span class="token punctuation">:</span> <span class="token string">"text/plain"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        res<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"404 Not Found\n"</span><span class="token punctuation">)</span>
        res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> serverHandle</code></pre>
<h4 id="开发路由-（新建和更新博客路由）"><a href="#开发路由-（新建和更新博客路由）" class="headerlink" title="开发路由 （新建和更新博客路由）"></a>开发路由 （新建和更新博客路由）</h4><pre class=" language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// ./src/router/blog.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> 
    getList<span class="token punctuation">,</span> 
    getDetail<span class="token punctuation">,</span>
    newBlog<span class="token punctuation">,</span>
    updateBlog
<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../controller/blog'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> SuccessModel<span class="token punctuation">,</span> ErrorModel <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../model/resModel'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> handleBlogRouter <span class="token operator">=</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> method <span class="token operator">=</span> req<span class="token punctuation">.</span>method <span class="token comment" spellcheck="true">//GET POST</span>
    <span class="token keyword">const</span> id <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>id

    <span class="token comment" spellcheck="true">//获取博客列表</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">===</span> <span class="token string">'GET'</span> <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">'/api/blog/list'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> author <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>author <span class="token operator">||</span> <span class="token string">''</span>
        <span class="token keyword">const</span> keyword <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>keyword <span class="token operator">||</span> <span class="token string">''</span>
        <span class="token keyword">const</span> listData <span class="token operator">=</span> <span class="token function">getList</span><span class="token punctuation">(</span>author<span class="token punctuation">,</span> keyword<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SuccessModel</span><span class="token punctuation">(</span>listData<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// return {</span>
        <span class="token comment" spellcheck="true">//     msg: '这是博客列表的接口'</span>
        <span class="token comment" spellcheck="true">// }</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//获取博客详情</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">===</span> <span class="token string">'GET'</span> <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>path <span class="token operator">===</span><span class="token string">'/api/blog/detail'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token function">getDetail</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SuccessModel</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//新建博客</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">===</span> <span class="token string">'POST'</span> <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">'/api/blog/new'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token function">newBlog</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SuccessModel</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//更新博客</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">===</span> <span class="token string">'POST'</span> <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">'/api/blog/update'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">updateBlog</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> req<span class="token punctuation">.</span>body<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SuccessModel</span><span class="token punctuation">(</span><span class="token string">'Update Successed!'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ErrorModel</span><span class="token punctuation">(</span><span class="token string">'Update Failed!'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//删除博客</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">===</span> <span class="token string">'POST'</span> <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">'/api/blog/del'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            msg<span class="token punctuation">:</span> <span class="token string">'这是删除博客的接口'</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> handleBlogRouter</code></pre>
<pre class=" language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// ./src/controller/blog.js</span>
<span class="token comment" spellcheck="true">//博客列表</span>
<span class="token keyword">const</span> getList <span class="token operator">=</span> <span class="token punctuation">(</span>author<span class="token punctuation">,</span> keyword<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//先返回假数据(格式正确)</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            title<span class="token punctuation">:</span> <span class="token string">'标题A'</span><span class="token punctuation">,</span>
            content<span class="token punctuation">:</span> <span class="token string">'内容A'</span><span class="token punctuation">,</span>
            createTime<span class="token punctuation">:</span> <span class="token number">20191101</span><span class="token punctuation">,</span>
            author<span class="token punctuation">:</span> <span class="token string">'zhangsan'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            id<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
            title<span class="token punctuation">:</span> <span class="token string">'标题2'</span><span class="token punctuation">,</span>
            content<span class="token punctuation">:</span> <span class="token string">'内容2'</span><span class="token punctuation">,</span>
            createTime<span class="token punctuation">:</span> <span class="token number">20191102</span><span class="token punctuation">,</span>
            author<span class="token punctuation">:</span> <span class="token string">'zhangsan2'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            id<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
            title<span class="token punctuation">:</span> <span class="token string">'标题3'</span><span class="token punctuation">,</span>
            content<span class="token punctuation">:</span> <span class="token string">'内容3'</span><span class="token punctuation">,</span>
            createTime<span class="token punctuation">:</span> <span class="token number">20191103</span><span class="token punctuation">,</span>
            author<span class="token punctuation">:</span> <span class="token string">'zhangsan3'</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//博客详情</span>
<span class="token keyword">const</span> getDetail <span class="token operator">=</span> <span class="token punctuation">(</span> id <span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//先返回假数据(格式正确)</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        id<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
        title<span class="token punctuation">:</span> <span class="token string">'标题3'</span><span class="token punctuation">,</span>
        content<span class="token punctuation">:</span> <span class="token string">'内容3'</span><span class="token punctuation">,</span>
        createTime<span class="token punctuation">:</span> <span class="token number">20191103</span><span class="token punctuation">,</span>
        author<span class="token punctuation">:</span> <span class="token string">'zhangsan3'</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//新建博客</span>
<span class="token keyword">const</span> newBlog <span class="token operator">=</span> <span class="token punctuation">(</span>blogData <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// blogData 是一个博客对象，包含 title conten 属性</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        id<span class="token punctuation">:</span> <span class="token number">3</span> <span class="token comment" spellcheck="true">//表示新建博客，插入到数据表里面的 id</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//更新博客</span>
<span class="token keyword">const</span> updateBlog <span class="token operator">=</span> <span class="token punctuation">(</span>id<span class="token punctuation">,</span> blogData <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// id 就是要更新的 id</span>
    <span class="token comment" spellcheck="true">// blogData 是一个博客对象，包含 tiltle content 属性</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'updateBlog:'</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span> blogData<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    getList<span class="token punctuation">,</span>
    getDetail<span class="token punctuation">,</span>
    newBlog<span class="token punctuation">,</span>
    updateBlog

<span class="token punctuation">}</span></code></pre>
<h4 id="开发路由-（删除博客路由和登录博客路由）"><a href="#开发路由-（删除博客路由和登录博客路由）" class="headerlink" title="开发路由 （删除博客路由和登录博客路由）"></a>开发路由 （删除博客路由和登录博客路由）</h4><ul>
<li><strong>删除博客</strong></li>
</ul>
<pre class=" language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// ./src/controller/blog.js 里面增加下列代码</span>
<span class="token comment" spellcheck="true">//删除博客</span>
<span class="token keyword">const</span> delBlog <span class="token operator">=</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// id 就是要删除的博客的 id</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'delBlog:'</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    getList<span class="token punctuation">,</span>
    getDetail<span class="token punctuation">,</span>
    newBlog<span class="token punctuation">,</span>
    updateBlog<span class="token punctuation">,</span>
    delBlog
<span class="token punctuation">}</span></code></pre>
<pre class=" language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">//  ./src/router/blog.js 里面增加下列代码</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> 
    getList<span class="token punctuation">,</span> 
    getDetail<span class="token punctuation">,</span>
    newBlog<span class="token punctuation">,</span>
    updateBlog<span class="token punctuation">,</span>
    delBlog
    <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../controller/blog'</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">//删除博客</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">===</span> <span class="token string">'POST'</span> <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">'/api/blog/del'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">delBlog</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SuccessModel</span><span class="token punctuation">(</span><span class="token string">'Delete Successed!'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ErrorModel</span><span class="token punctuation">(</span><span class="token string">'Delete Failed!'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<ul>
<li><strong>登录博客</strong></li>
</ul>
<pre class=" language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// ./src/router/user.js 代码</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> loginCheck <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../controller/user'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//'路径里面不能有空格'</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> SuccessModel<span class="token punctuation">,</span> ErrorModel <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../model/resModel'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> handleUserRouter <span class="token operator">=</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> method <span class="token operator">=</span> req<span class="token punctuation">.</span>method <span class="token comment" spellcheck="true">//GET POST</span>

    <span class="token comment" spellcheck="true">//登录</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">===</span> <span class="token string">'POST'</span> <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">'/api/user/login'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span>username<span class="token punctuation">,</span> password <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body
        <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">loginCheck</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SuccessModel</span><span class="token punctuation">(</span><span class="token string">'login successed!'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ErrorModel</span><span class="token punctuation">(</span><span class="token string">'login failed!'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> handleUserRouter</code></pre>
<pre class=" language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// ./src/controller/user.js 代码</span>
<span class="token comment" spellcheck="true">//登录验证</span>
<span class="token keyword">const</span> loginCheck <span class="token operator">=</span> <span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'username:'</span><span class="token punctuation">,</span> username<span class="token punctuation">,</span> <span class="token string">'password:'</span><span class="token punctuation">,</span> password<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>username <span class="token operator">===</span> <span class="token string">'zhangsan'</span> <span class="token operator">&amp;&amp;</span> password <span class="token operator">===</span> <span class="token string">'123'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    loginCheck
<span class="token punctuation">}</span></code></pre>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><ul>
<li><p>node.js 处理 http 请求的常用技能，postman 的使用</p>
</li>
<li><p>node.js 开发博客项目的接口（未连接数据库，未登录使用）</p>
</li>
<li><p>为何要将 router 和 controller 分开？</p>
</li>
<li><p>路由和  API 区别：</p>
<ul>
<li>API ：前后端、不同端（子系统）之间对接的通用术语</li>
<li>路由：系统内部的接口定义，是 API 的一部分</li>
</ul>
</li>
</ul>
<h2 id="使用MySQL数据库"><a href="#使用MySQL数据库" class="headerlink" title="使用MySQL数据库"></a>使用MySQL数据库</h2><h3 id="MySQL安装"><a href="#MySQL安装" class="headerlink" title="MySQL安装"></a>MySQL安装</h3><p><strong>讲解步骤：</strong></p>
<ol>
<li><p>MySQL 的介绍、安装和使用</p>
</li>
<li><p>node.js 连接 MySQL</p>
</li>
<li><p>API 连接 MySQL</p>
</li>
</ol>
<p>为什么使用MySQL？</p>
<ul>
<li>MySQL 最常用，有专人运维</li>
<li>MySQL 有问题可以随时查到</li>
<li>MySQL 本身是复杂的，本课只讲使用</li>
</ul>
<h4 id="MySQL-介绍："><a href="#MySQL-介绍：" class="headerlink" title="MySQL 介绍："></a>MySQL 介绍：</h4><ul>
<li>web server 中最流行的关系型数据库</li>
<li>免费下载学习</li>
<li>轻量级，易学易用</li>
</ul>
<p>MySQL 下载： <a href="https://dev.mysql.com/downloads/mysql/" target="_blank" rel="noopener">https://dev.mysql.com/downloads/mysql/</a> </p>
<h4 id="MySQL-安装："><a href="#MySQL-安装：" class="headerlink" title="MySQL 安装："></a>MySQL 安装：</h4><ul>
<li>解压，打开根目录初始化<code>my.ini</code> 文件， 自行创建在安装根目录下创建<code>my.ini</code></li>
</ul>
<pre class=" language-ini"><code class="language-ini"><span class="token selector">  [mysqld]</span>
  # 设置3306端口
<span class="token constant">  port</span><span class="token attr-value"><span class="token punctuation">=</span>3306</span>
  # 设置mysql的安装目录
<span class="token constant">  basedir</span><span class="token attr-value"><span class="token punctuation">=</span>C:\Program Files\MySQL</span>
  # 设置mysql数据库的数据的存放目录
<span class="token constant">  datadir</span><span class="token attr-value"><span class="token punctuation">=</span>C:\Program Files\MySQL\Data</span>
  # 允许最大连接数
<span class="token constant">  max_connections</span><span class="token attr-value"><span class="token punctuation">=</span>200</span>
  # 允许连接失败的次数。
<span class="token constant">  max_connect_errors</span><span class="token attr-value"><span class="token punctuation">=</span>10</span>
  # 服务端使用的字符集默认为utf8mb4
<span class="token constant">  character-set-server</span><span class="token attr-value"><span class="token punctuation">=</span>utf8mb4</span>
  # 创建新表时将使用的默认存储引擎
<span class="token constant">  default-storage-engine</span><span class="token attr-value"><span class="token punctuation">=</span>INNODB</span>
  # 默认使用“mysql_native_password”插件认证
  #mysql_native_password
<span class="token constant">  default_authentication_plugin</span><span class="token attr-value"><span class="token punctuation">=</span>mysql_native_password</span>
<span class="token selector">  [mysql]</span>
  # 设置mysql客户端默认字符集
<span class="token constant">  default-character-set</span><span class="token attr-value"><span class="token punctuation">=</span>utf8mb4</span>
<span class="token selector">  [client]</span>
  # 设置mysql客户端连接服务端时默认使用的端口
<span class="token constant">  port</span><span class="token attr-value"><span class="token punctuation">=</span>3306</span>
<span class="token constant">  default-character-set</span><span class="token attr-value"><span class="token punctuation">=</span>utf8mb4</span></code></pre>
<p>   配置文件中的路径要和实际存放的路径一致（要手动创建Data文件夹） </p>
<ul>
<li><p>打开系统设置，配置环境变量 ` Path = ‘解压目录’\bin</p>
</li>
<li><p>初始化安装：<code>mysqld --initialize --console</code></p>
<p>注意输出信息：<code>root @ localhost：后面是初始密码（不含首位空格）</code>，后续登录需要用到，复制密码先保存起来</p>
</li>
<li><p>安装MySQL 服务：<code>mysqld --install[服务名]</code> 不填默认<code>mysql</code></p>
</li>
<li><p>启动MySQL：<code>net start mysql</code></p>
</li>
</ul>
<h4 id="使用官方客户端管理mysql"><a href="#使用官方客户端管理mysql" class="headerlink" title="使用官方客户端管理mysql"></a>使用官方客户端管理mysql</h4><ul>
<li><p>Wrokbench 下载地址：<a href="https://dev.mysql.com/downloads/" target="_blank" rel="noopener">https://dev.mysql.com/downloads/</a></p>
</li>
<li><p>默认安装，打开后输入之前保存的默认密码登录</p>
</li>
<li><p>弹出修改密码界面，修改密码再登录</p>
</li>
</ul>
<h3 id="MySQL基本使用"><a href="#MySQL基本使用" class="headerlink" title="MySQL基本使用"></a>MySQL基本使用</h3><h4 id="根据需求设计表"><a href="#根据需求设计表" class="headerlink" title="根据需求设计表"></a>根据需求设计表</h4><p>users：</p>
<table>
<thead>
<tr>
<th align="center">id</th>
<th align="center">username</th>
<th align="center">password</th>
<th align="center">realname</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td align="center">zhangsan</td>
<td align="center">123</td>
<td align="center">张三</td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">lisi</td>
<td align="center">1234</td>
<td align="center">李四</td>
</tr>
</tbody></table>
<p>blogs：</p>
<table>
<thead>
<tr>
<th align="center">id</th>
<th align="center">title</th>
<th align="center">content</th>
<th align="center">createtime</th>
<th align="center">author</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td align="center">标题A</td>
<td align="center">内容A</td>
<td align="center">1573989043149</td>
<td align="center">zhangsan</td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">标题B</td>
<td align="center">内容B</td>
<td align="center">1573989111301</td>
<td align="center">lisi</td>
</tr>
</tbody></table>
<h4 id="MySQL语法和操作"><a href="#MySQL语法和操作" class="headerlink" title="MySQL语法和操作"></a>MySQL语法和操作</h4><p>右键表 <code>Drop table</code> 删除</p>
<p>右键表 <code>Alter table</code> 修改</p>
<pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">-- 显示数据库</span>
 <span class="token keyword">show</span> <span class="token keyword">databases</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">-- 创建数据库</span>
 <span class="token keyword">CREATE</span> <span class="token keyword">SCHEMA</span> <span class="token punctuation">`</span>myblog<span class="token punctuation">`</span> <span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">-- 创建users数据表</span>
 <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>myblog<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token punctuation">`</span>users<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">INT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>username<span class="token punctuation">`</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>password<span class="token punctuation">`</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>realname<span class="token punctuation">`</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">-- 创建blogs数据表</span>
 <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>myblog<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token punctuation">`</span>blogs<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">INT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>title<span class="token punctuation">`</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>content<span class="token punctuation">`</span> <span class="token keyword">LONGTEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>createtime<span class="token punctuation">`</span> <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>author<span class="token punctuation">`</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">-- 使用myblog数据库</span>
 <span class="token keyword">use</span> myblog<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">-- 显示当前数据库中的表</span>
 <span class="token keyword">show</span> <span class="token keyword">tables</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">-- 增加数据到指定表内</span>
 <span class="token keyword">insert</span> <span class="token keyword">into</span> users <span class="token punctuation">(</span>username<span class="token punctuation">,</span><span class="token punctuation">`</span>password<span class="token punctuation">`</span><span class="token punctuation">,</span>realname<span class="token punctuation">)</span><span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">'zhangsan'</span><span class="token punctuation">,</span><span class="token string">'123'</span><span class="token punctuation">,</span><span class="token string">'张三'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
 <span class="token keyword">insert</span> <span class="token keyword">into</span> users <span class="token punctuation">(</span>username<span class="token punctuation">,</span><span class="token punctuation">`</span>password<span class="token punctuation">`</span><span class="token punctuation">,</span>realname<span class="token punctuation">)</span><span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">'lisi'</span><span class="token punctuation">,</span><span class="token string">'1234'</span><span class="token punctuation">,</span><span class="token string">'李四'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token comment" spellcheck="true">-- 从指定表内 查询数据 '*'代表所有 比较消耗性能</span>
  <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> users<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">-- 从指定表内 查询指定行列数据 </span>
 <span class="token keyword">select</span> id<span class="token punctuation">,</span>username <span class="token keyword">from</span> users<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">-- 从指定表内 根据条件查询并集或交集</span>
 <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> users <span class="token keyword">where</span> username<span class="token operator">=</span><span class="token string">'zhangsan'</span> <span class="token operator">and</span> <span class="token punctuation">`</span>password<span class="token punctuation">`</span><span class="token operator">=</span><span class="token string">'123'</span><span class="token punctuation">;</span>
 <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> users <span class="token keyword">where</span> username<span class="token operator">=</span><span class="token string">'zhangsan'</span> <span class="token operator">or</span> <span class="token punctuation">`</span>password<span class="token punctuation">`</span><span class="token operator">=</span><span class="token string">'123'</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">-- 从指定表内 根据条件模糊查询</span>
 <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> users <span class="token keyword">where</span> username <span class="token operator">like</span> <span class="token string">'%zhang%'</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">-- 从指定表内 根据条件模糊查询并根据条件倒序</span>
 <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> users <span class="token keyword">where</span> password <span class="token operator">like</span> <span class="token string">'%1%'</span> <span class="token keyword">order</span> <span class="token keyword">by</span> id <span class="token keyword">desc</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">-- Error Code: 1175. 先解除安全模式再更新或删除</span>
 <span class="token keyword">SET</span> SQL_SAFE_UPDATES<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">-- 从指定表内 更新数据表 </span>
 <span class="token keyword">update</span> users <span class="token keyword">set</span> realname<span class="token operator">=</span><span class="token string">'李四2'</span> <span class="token keyword">where</span> username<span class="token operator">=</span><span class="token string">'lisi'</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">-- 从指定表内 删除数据表</span>
 <span class="token keyword">delete</span> <span class="token keyword">from</span> users <span class="token keyword">where</span> username<span class="token operator">=</span><span class="token string">'lisi'</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">-- 软删除，给数据加上删除标记 state='0',通常不使用 delete 语句</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>myblog<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token punctuation">`</span>users<span class="token punctuation">`</span> 
<span class="token keyword">ADD</span> <span class="token keyword">COLUMN</span> <span class="token punctuation">`</span>stats<span class="token punctuation">`</span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AFTER</span> <span class="token punctuation">`</span>realname<span class="token punctuation">`</span><span class="token punctuation">;</span>
 <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> users <span class="token keyword">where</span> state<span class="token operator">=</span><span class="token string">'1'</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">-- 不等于号 &lt;></span>
 <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> users <span class="token keyword">where</span> state<span class="token operator">&lt;></span><span class="token string">'0'</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">-- 本教程使用真删除，删除 stats</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>myblog<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token punctuation">`</span>users<span class="token punctuation">`</span> 
<span class="token keyword">DROP</span> <span class="token keyword">COLUMN</span> <span class="token punctuation">`</span>stats<span class="token punctuation">`</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">-- 往 blogs 填充数据方便测试</span>
 <span class="token keyword">insert</span> <span class="token keyword">into</span> blogs <span class="token punctuation">(</span>title<span class="token punctuation">,</span>content<span class="token punctuation">,</span>createtime<span class="token punctuation">,</span>author<span class="token punctuation">)</span><span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">'标题A'</span><span class="token punctuation">,</span><span class="token string">'内容A'</span><span class="token punctuation">,</span><span class="token string">'1573989043149'</span><span class="token punctuation">,</span><span class="token string">'zhangsan'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">insert</span> <span class="token keyword">into</span> blogs <span class="token punctuation">(</span>title<span class="token punctuation">,</span>content<span class="token punctuation">,</span>createtime<span class="token punctuation">,</span>author<span class="token punctuation">)</span><span class="token keyword">values</span><span class="token punctuation">(</span><span class="token string">'标题B'</span><span class="token punctuation">,</span><span class="token string">'内容B'</span><span class="token punctuation">,</span><span class="token string">'1573989111301'</span><span class="token punctuation">,</span><span class="token string">'lisi'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">-- 查询 blogs 数据 条件查询 倒叙查询 模糊查询</span>
 <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> blogs<span class="token punctuation">;</span>
 <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> blogs <span class="token keyword">where</span> author<span class="token operator">=</span><span class="token string">'lisi'</span> <span class="token keyword">order</span> <span class="token keyword">by</span> createtime <span class="token keyword">desc</span><span class="token punctuation">;</span>
 <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> blogs <span class="token keyword">where</span> title <span class="token operator">like</span> <span class="token string">'%A%'</span> <span class="token keyword">order</span> <span class="token keyword">by</span> createtime <span class="token keyword">desc</span><span class="token punctuation">;</span></code></pre>
<h4 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h4><ul>
<li>如何建库、如何建表</li>
<li>建表时常用数据类型（ int bigint varchar longtext）</li>
<li>SQL 语句实现增删改查</li>
</ul>
<h3 id="Node-js-操作-MySQL"><a href="#Node-js-操作-MySQL" class="headerlink" title="Node.js 操作 MySQL"></a>Node.js 操作 MySQL</h3><ol>
<li><p>示例：用 demo 演示 Node.js 操作 MySQL</p>
</li>
<li><p>封装：将其封装为系统可用的工具</p>
</li>
<li><p>使用：让 API 直接操作 MySQL</p>
</li>
</ol>
<h4 id="Node-js-操作-MySQL-demo"><a href="#Node-js-操作-MySQL-demo" class="headerlink" title="Node.js 操作 MySQL demo"></a>Node.js 操作 MySQL demo</h4><p>安装MySQL模块到本目录： <code>npm install mysql</code> </p>
<pre class=" language-javaScript"><code class="language-javaScript">// 测试demo 文件
const mysql = require('mysql')

//创建连接对象
const con = mysql.createConnection({
    host: 'localhost',
    user: 'root',
    password: 'root2019',
    port: '3306',
    database: 'myblog'
})

//开始连接
con.connect()

// 执行 SQL 语句
const sql = `update users set realname='李四二' where username='lisi';`
// const sql = `select * from blogs;`
// const sql = `insert into blogs (title,content,createtime,author)values('标题A','内容A','1573989043149','zhangsan');`

con.query(sql, (err, result) => {
    if (err) {
        console.log(err)
        return
    }
    console.log(result)
})

//关闭连接
con.end()</code></pre>
<h4 id="MySQL封装成工具"><a href="#MySQL封装成工具" class="headerlink" title="MySQL封装成工具"></a>MySQL封装成工具</h4><pre class=" language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// ./src/conf/db.js</span>
<span class="token keyword">const</span> env <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token comment" spellcheck="true">//环境参数</span>

<span class="token comment" spellcheck="true">//配置</span>
<span class="token keyword">let</span> MYSQL_CONF

<span class="token keyword">if</span> <span class="token punctuation">(</span>env <span class="token operator">===</span> <span class="token string">'dev'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    MYSQL_CONF <span class="token operator">=</span> <span class="token punctuation">{</span>
    host<span class="token punctuation">:</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span>
    user<span class="token punctuation">:</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
    password<span class="token punctuation">:</span> <span class="token string">'root2019'</span><span class="token punctuation">,</span>
    port<span class="token punctuation">:</span> <span class="token string">'3306'</span><span class="token punctuation">,</span>
    database<span class="token punctuation">:</span> <span class="token string">'myblog'</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>env <span class="token operator">===</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    MYSQL_CONF <span class="token operator">=</span> <span class="token punctuation">{</span>
    host<span class="token punctuation">:</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span>
    user<span class="token punctuation">:</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
    password<span class="token punctuation">:</span> <span class="token string">'root2019'</span><span class="token punctuation">,</span>
    port<span class="token punctuation">:</span> <span class="token string">'3306'</span><span class="token punctuation">,</span>
    database<span class="token punctuation">:</span> <span class="token string">'myblog'</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    MYSQL_CONF
<span class="token punctuation">}</span></code></pre>
<pre class=" language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// ./src/db/mysql.js</span>
<span class="token keyword">const</span> mysql <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mysql'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> MYSQL_CONF <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../conf/db.js'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 创建链接对象</span>
<span class="token keyword">const</span> con <span class="token operator">=</span> mysql<span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span>MYSQL_CONF<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">//开始连接</span>
con<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 统一执行 sql 语句的函数</span>
<span class="token keyword">function</span> <span class="token function">exec</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        con<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> result<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> promise
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    exec
<span class="token punctuation">}</span></code></pre>
<h4 id="API-对接-MySQL"><a href="#API-对接-MySQL" class="headerlink" title="API 对接 MySQL"></a>API 对接 MySQL</h4><ul>
<li><code>api/blog/xxx</code> 对接 MySQL</li>
</ul>
<pre class=" language-javascript"><code class="language-javascript">  <span class="token comment" spellcheck="true">// app.js 代码</span>

  <span class="token keyword">const</span> handleBlogRouter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./src/router/blog'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> handleUserRouter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./src/router/user'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> querystring <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'querystring'</span><span class="token punctuation">)</span>

  <span class="token comment" spellcheck="true">//用于处理 post data</span>
  <span class="token keyword">const</span> getPostData <span class="token operator">=</span> <span class="token punctuation">(</span>req<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">!==</span> <span class="token string">'POST'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
              <span class="token keyword">return</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'content-type'</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">'application/json'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
              <span class="token keyword">return</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">let</span> postData <span class="token operator">=</span> <span class="token string">''</span>
          <span class="token comment" spellcheck="true">//开始接收数据</span>
          req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> chunk <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
              postData <span class="token operator">+</span><span class="token operator">=</span> chunk<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token comment" spellcheck="true">//结束接收数据</span>
          req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>postData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
                  <span class="token keyword">return</span>
              <span class="token punctuation">}</span>
              <span class="token function">resolve</span><span class="token punctuation">(</span>
                  JSON<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>postData<span class="token punctuation">)</span>
              <span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> promise
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> serverHandle <span class="token operator">=</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">//设置返回值格式 JSON</span>
      res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-type'</span><span class="token punctuation">,</span> <span class="token string">'application/json'</span><span class="token punctuation">)</span>

      <span class="token comment" spellcheck="true">// 获取 path</span>
      <span class="token keyword">const</span> url <span class="token operator">=</span> req<span class="token punctuation">.</span>url
      req<span class="token punctuation">.</span>path <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

      <span class="token comment" spellcheck="true">//解析 query</span>
      req<span class="token punctuation">.</span>query <span class="token operator">=</span> querystring<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

      <span class="token comment" spellcheck="true">//处理 postData</span>
      <span class="token function">getPostData</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>postData <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
          req<span class="token punctuation">.</span>body <span class="token operator">=</span> postData

          <span class="token comment" spellcheck="true">//处理 blog 路由</span>
          <span class="token keyword">const</span> blogResult <span class="token operator">=</span> <span class="token function">handleBlogRouter</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>blogResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  blogResult<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>blogData <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
                  res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>
                      JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>blogData<span class="token punctuation">)</span>
                  <span class="token punctuation">)</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span>
              <span class="token keyword">return</span>
          <span class="token punctuation">}</span>

          <span class="token comment" spellcheck="true">//处理 user 路由</span>
          <span class="token keyword">const</span> userResult <span class="token operator">=</span> <span class="token function">handleUserRouter</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>userResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              userResult<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>userData <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
                  res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>
                      JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>userData<span class="token punctuation">)</span>
                  <span class="token punctuation">)</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span>
              <span class="token keyword">return</span>
          <span class="token punctuation">}</span>
          <span class="token comment" spellcheck="true">//未命中路由，返回404</span>
          res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">"Content-type"</span><span class="token punctuation">:</span> <span class="token string">"text/plain"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
          res<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"404 Not Found\n"</span><span class="token punctuation">)</span>
          res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  module<span class="token punctuation">.</span>exports <span class="token operator">=</span> serverHandle


  <span class="token comment" spellcheck="true">// ./src/controller/blog.js</span>


  <span class="token keyword">const</span> <span class="token punctuation">{</span> exec <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../db/mysql'</span><span class="token punctuation">)</span>

  <span class="token comment" spellcheck="true">//博客列表</span>
  <span class="token keyword">const</span> getList <span class="token operator">=</span> <span class="token punctuation">(</span>author<span class="token punctuation">,</span> keyword<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token string">`select * from blogs where 1=1 `</span></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>author<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          sql <span class="token operator">+</span><span class="token operator">=</span> <span class="token template-string"><span class="token string">`and author='</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>author<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">' `</span></span>
      <span class="token punctuation">}</span> 
      <span class="token keyword">if</span> <span class="token punctuation">(</span>keyword<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          sql <span class="token operator">+</span><span class="token operator">=</span> <span class="token template-string"><span class="token string">`and title like '%</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>keyword<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">%' `</span></span>
      <span class="token punctuation">}</span>
      sql <span class="token operator">+</span><span class="token operator">=</span> <span class="token template-string"><span class="token string">`order by createtime desc;`</span></span>

      <span class="token comment" spellcheck="true">//返回 promise</span>
      <span class="token keyword">return</span> <span class="token function">exec</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">//博客详情</span>
  <span class="token keyword">const</span> getDetail <span class="token operator">=</span> <span class="token punctuation">(</span> id <span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token string">`select * from blogs where id='</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">'`</span></span>
      <span class="token keyword">return</span> <span class="token function">exec</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>rows <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> rows<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">//新建博客</span>
  <span class="token keyword">const</span> newBlog <span class="token operator">=</span> <span class="token punctuation">(</span>blogData <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// blogData 是一个博客对象，包含 title conten 属性</span>
      <span class="token keyword">const</span> title <span class="token operator">=</span> blogData<span class="token punctuation">.</span>title
      <span class="token keyword">const</span> content <span class="token operator">=</span> blogData<span class="token punctuation">.</span>content
      <span class="token keyword">const</span> author <span class="token operator">=</span> blogData<span class="token punctuation">.</span>author
      <span class="token keyword">const</span> createtime <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token string">`
      insert into blogs (title, content, createtime, author)
      values('</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>title<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">', '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>content<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">', '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>createtime<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">', '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>author<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">')
      `</span></span>

      <span class="token keyword">return</span> <span class="token function">exec</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>insertData <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token punctuation">{</span>
              id<span class="token punctuation">:</span> insertData<span class="token punctuation">.</span>insertId
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">//更新博客</span>
  <span class="token keyword">const</span> updateBlog <span class="token operator">=</span> <span class="token punctuation">(</span>id<span class="token punctuation">,</span> blogData <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// id 就是要更新的 id</span>
      <span class="token comment" spellcheck="true">// blogData 是一个博客对象，包含 title content 属性</span>
      <span class="token keyword">const</span> title <span class="token operator">=</span> blogData<span class="token punctuation">.</span>title
      <span class="token keyword">const</span> content <span class="token operator">=</span> blogData<span class="token punctuation">.</span>content

      <span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token string">`
          update blogs set title='</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>title<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">', content='</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>content<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">' where id=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
      `</span></span>

      <span class="token keyword">return</span> <span class="token function">exec</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>updateData <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>updateData<span class="token punctuation">.</span>affectedRows <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">return</span> <span class="token boolean">true</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">return</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">//删除博客</span>
  <span class="token keyword">const</span> delBlog <span class="token operator">=</span> <span class="token punctuation">(</span>id<span class="token punctuation">,</span> author<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// id 就是要删除的博客的 id</span>
      <span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token string">`delete from blogs where id=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> and author='</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>author<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">'`</span></span>

      <span class="token keyword">return</span> <span class="token function">exec</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>delData <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>delData<span class="token punctuation">.</span>affectedRows <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">return</span> <span class="token boolean">true</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">return</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
      getList<span class="token punctuation">,</span>
      getDetail<span class="token punctuation">,</span>
      newBlog<span class="token punctuation">,</span>
      updateBlog<span class="token punctuation">,</span>
      delBlog
  <span class="token punctuation">}</span>




  <span class="token comment" spellcheck="true">// ./src/router/blog.js //</span>

  <span class="token keyword">const</span> <span class="token punctuation">{</span> 
      getList<span class="token punctuation">,</span> 
      getDetail<span class="token punctuation">,</span>
      newBlog<span class="token punctuation">,</span>
      updateBlog<span class="token punctuation">,</span>
      delBlog
  <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../controller/blog'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> SuccessModel<span class="token punctuation">,</span> ErrorModel <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../model/resModel'</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> handleBlogRouter <span class="token operator">=</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> method <span class="token operator">=</span> req<span class="token punctuation">.</span>method <span class="token comment" spellcheck="true">//GET POST</span>
      <span class="token keyword">const</span> id <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>id

      <span class="token comment" spellcheck="true">//获取博客列表</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">===</span> <span class="token string">'GET'</span> <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">'/api/blog/list'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> author <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>author <span class="token operator">||</span> <span class="token string">''</span>
          <span class="token keyword">const</span> keyword <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>keyword <span class="token operator">||</span> <span class="token string">''</span>
          <span class="token comment" spellcheck="true">// const listData = getList(author, keyword)</span>
          <span class="token comment" spellcheck="true">// return new SuccessModel(listData)</span>
          <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">getList</span><span class="token punctuation">(</span>author<span class="token punctuation">,</span> keyword<span class="token punctuation">)</span>
          <span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>listData <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
              <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SuccessModel</span><span class="token punctuation">(</span>listData<span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      <span class="token comment" spellcheck="true">//获取博客详情</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">===</span> <span class="token string">'GET'</span> <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>path <span class="token operator">===</span><span class="token string">'/api/blog/detail'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">getDetail</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
          <span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>detailData <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
              <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SuccessModel</span><span class="token punctuation">(</span>detailData<span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      <span class="token comment" spellcheck="true">//新建博客</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">===</span> <span class="token string">'POST'</span> <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">'/api/blog/new'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

          <span class="token keyword">const</span> author <span class="token operator">=</span><span class="token string">'zhangsan'</span> <span class="token comment" spellcheck="true">//作者假数据，等待登录</span>
          req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>author <span class="token operator">=</span> author

          <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">newBlog</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">)</span>
          <span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>data <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
              <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SuccessModel</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      <span class="token comment" spellcheck="true">//更新博客</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">===</span> <span class="token string">'POST'</span> <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">'/api/blog/update'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">updateBlog</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> req<span class="token punctuation">.</span>body<span class="token punctuation">)</span>
          <span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>value <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SuccessModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
              <span class="token punctuation">}</span> 
              <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ErrorModel</span><span class="token punctuation">(</span><span class="token string">'Failed!'</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>


      <span class="token comment" spellcheck="true">//删除博客</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">===</span> <span class="token string">'POST'</span> <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">'/api/blog/del'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> author <span class="token operator">=</span><span class="token string">'zhangsan'</span> <span class="token comment" spellcheck="true">//作者假数据，等待登录</span>
          req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>author <span class="token operator">=</span> author

          <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">delBlog</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> author<span class="token punctuation">)</span>
          <span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>value <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SuccessModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
              <span class="token punctuation">}</span>
              <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ErrorModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  module<span class="token punctuation">.</span>exports <span class="token operator">=</span> handleBlogRouter</code></pre>
<ul>
<li><code>api/user/xxx</code> 对接MySQL</li>
</ul>
<pre class=" language-javascript"><code class="language-javascript">  <span class="token comment" spellcheck="true">// ./src/controller/user.js //</span>

  <span class="token keyword">const</span> <span class="token punctuation">{</span> exec <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../db/mysql.js'</span><span class="token punctuation">)</span>

  <span class="token comment" spellcheck="true">//登录验证</span>
  <span class="token keyword">const</span> loginCheck <span class="token operator">=</span> <span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token string">`
          select username from users where username='</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>username<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">' and password='</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>password<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">'
      `</span></span>
      <span class="token keyword">return</span> <span class="token function">exec</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>rows <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> rows<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
      loginCheck
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">// ./src/router/user.js //</span>

  <span class="token keyword">const</span> <span class="token punctuation">{</span> loginCheck <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../controller/user'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//'路径里面不能有空格'</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> SuccessModel<span class="token punctuation">,</span> ErrorModel <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../model/resModel'</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> handleUserRouter <span class="token operator">=</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> method <span class="token operator">=</span> req<span class="token punctuation">.</span>method <span class="token comment" spellcheck="true">//GET POST</span>

      <span class="token comment" spellcheck="true">//登录</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">===</span> <span class="token string">'POST'</span> <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">'/api/user/login'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> <span class="token punctuation">{</span>username<span class="token punctuation">,</span> password <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body
          <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">loginCheck</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">)</span>
          <span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>data <span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>username<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SuccessModel</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span>
              <span class="token punctuation">}</span>
              <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ErrorModel</span><span class="token punctuation">(</span><span class="token string">'login failed!'</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>

      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  module<span class="token punctuation">.</span>exports <span class="token operator">=</span> handleUserRouter</code></pre>
<h4 id="总结-2"><a href="#总结-2" class="headerlink" title="总结"></a>总结</h4><ul>
<li>Node.js 连接 MySQL，如何执行 sql 语句</li>
<li>根据 NODE_ENV 区分设置</li>
<li>封装 exec 函数，API 使用 exec 操作数据库</li>
</ul>
<h2 id="用户登录"><a href="#用户登录" class="headerlink" title="用户登录"></a>用户登录</h2><ul>
<li>核心：登录校验 &amp; 登录信息存储</li>
<li>为何只讲登录，不讲注册？<ul>
<li>注册复杂程度低，涉及内容少</li>
<li>登录有统一解决方案</li>
</ul>
</li>
</ul>
<h3 id="Cookie"><a href="#Cookie" class="headerlink" title="Cookie"></a>Cookie</h3><ul>
<li><p>什么是 Cookie</p>
<ul>
<li>存储在浏览器的字符串（最大5KB）</li>
<li>跨域不共享</li>
<li>格式如 K1=V1;K2=V3;K3=V3; 因此可以存储结构化数据</li>
<li>每次发送 Http 请求，会将请求域的 Cookie 一起发送给 Server</li>
<li>Server 可以修改 Cookie 并返回给浏览器</li>
<li>浏览器也可以通过 JavaScript 修改 Cookie （有限制）</li>
</ul>
</li>
<li><p>JavaScript 操作Cookie，在浏览器中查看 Cookie</p>
<ul>
<li><code>document.cookie = &#39;k1=100;&#39;</code> 实现 Cookie 累加</li>
<li>F12 打开控制台 选择 Application，Storage，Cookie，选择指定 Cookie 按上方的X或delete键删除</li>
</ul>
</li>
<li><p>Server 端操作 Cookie，实现登录验证</p>
<ul>
<li>查看 Cookie</li>
<li>修改 Cookie</li>
<li>实现登录验证</li>
</ul>
</li>
</ul>
<pre class=" language-javascript"><code class="language-javascript">  <span class="token comment" spellcheck="true">// ./src/router/user.js</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> login <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../controller/user'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 路径里面不能有空格</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> SuccessModel<span class="token punctuation">,</span> ErrorModel <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../model/resModel'</span><span class="token punctuation">)</span>

  <span class="token comment" spellcheck="true">//获取 cookie 过期时间</span>
  <span class="token keyword">const</span> getCookieExpires <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> d <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      d<span class="token punctuation">.</span><span class="token function">setTime</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">24</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'d.toGMTString() is '</span><span class="token punctuation">,</span> d<span class="token punctuation">.</span><span class="token function">toGMTString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> d<span class="token punctuation">.</span><span class="token function">toGMTString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> handleUserRouter <span class="token operator">=</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> method <span class="token operator">=</span> req<span class="token punctuation">.</span>method <span class="token comment" spellcheck="true">//GET POST</span>

      <span class="token comment" spellcheck="true">// 登录</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">===</span> <span class="token string">'GET'</span> <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">'/api/user/login'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment" spellcheck="true">// const {username, password } = req.body</span>
          <span class="token keyword">const</span> <span class="token punctuation">{</span> username<span class="token punctuation">,</span> password <span class="token punctuation">}</span> <span class="token operator">=</span>req<span class="token punctuation">.</span>query
          <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">login</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">)</span>
          <span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>data <span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>username<span class="token punctuation">)</span> <span class="token punctuation">{</span>

              <span class="token comment" spellcheck="true">// 操作 cookie</span>
              res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Set-Cookie'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`username=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>username<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">; path=/; httpOnly; expires=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">getCookieExpires</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>

                  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SuccessModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
              <span class="token punctuation">}</span>
              <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ErrorModel</span><span class="token punctuation">(</span><span class="token string">'login failed!'</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>

      <span class="token punctuation">}</span>

      <span class="token comment" spellcheck="true">// 登录验证测试</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">===</span> <span class="token string">'GET'</span> <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">'/api/user/login-test'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment" spellcheck="true">// console.log(req.cookie.username)</span>
          <span class="token comment" spellcheck="true">// 只能按顺序读取</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>cookie<span class="token punctuation">.</span>username<span class="token punctuation">)</span> <span class="token punctuation">{</span>

              <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span> <span class="token keyword">new</span> <span class="token class-name">SuccessModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
          <span class="token punctuation">}</span>
          <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span> <span class="token keyword">new</span> <span class="token class-name">ErrorModel</span><span class="token punctuation">(</span><span class="token string">'未登录'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

  <span class="token punctuation">}</span>


  module<span class="token punctuation">.</span>exports <span class="token operator">=</span> handleUserRouter</code></pre>
<pre class=" language-javascript"><code class="language-javascript">  <span class="token comment" spellcheck="true">// app.js 代码</span>
  <span class="token keyword">const</span> handleBlogRouter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./src/router/blog'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> handleUserRouter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./src/router/user'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> querystring <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'querystring'</span><span class="token punctuation">)</span>

  <span class="token comment" spellcheck="true">// 用于处理 post data</span>
  <span class="token keyword">const</span> getPostData <span class="token operator">=</span> <span class="token punctuation">(</span>req<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">!==</span> <span class="token string">'POST'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
              <span class="token keyword">return</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'content-type'</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">'application/json'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
              <span class="token keyword">return</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">let</span> postData <span class="token operator">=</span> <span class="token string">''</span>
          <span class="token comment" spellcheck="true">// 开始接收数据</span>
          req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> chunk <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
              postData <span class="token operator">+</span><span class="token operator">=</span> chunk<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token comment" spellcheck="true">// 结束接收数据</span>
          req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>postData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
                  <span class="token keyword">return</span>
              <span class="token punctuation">}</span>
              <span class="token function">resolve</span><span class="token punctuation">(</span>
                  JSON<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>postData<span class="token punctuation">)</span>
              <span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>


      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> promise
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> serverHandle <span class="token operator">=</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// 设置返回值格式 JSON</span>
      res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-type'</span><span class="token punctuation">,</span> <span class="token string">'application/json'</span><span class="token punctuation">)</span>

      <span class="token comment" spellcheck="true">// 获取 path</span>
      <span class="token keyword">const</span> url <span class="token operator">=</span> req<span class="token punctuation">.</span>url
      req<span class="token punctuation">.</span>path <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

      <span class="token comment" spellcheck="true">// 解析 query</span>
      req<span class="token punctuation">.</span>query <span class="token operator">=</span> querystring<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

      <span class="token comment" spellcheck="true">// 解析 Cookie</span>
      req<span class="token punctuation">.</span>cookie <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token keyword">const</span> cookieStr <span class="token operator">=</span> req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>cookie <span class="token operator">||</span> <span class="token string">''</span> <span class="token comment" spellcheck="true">// k1=v1;k2=v2</span>
      cookieStr<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">';'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>item <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>item<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">return</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">const</span> arr <span class="token operator">=</span> item<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'='</span><span class="token punctuation">)</span>
          <span class="token keyword">const</span> key <span class="token operator">=</span> arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token keyword">const</span> val <span class="token operator">=</span> arr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          req<span class="token punctuation">.</span>cookie<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> val
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'req.cookie:'</span><span class="token punctuation">,</span>req<span class="token punctuation">.</span>cookie<span class="token punctuation">)</span>

      <span class="token comment" spellcheck="true">// 处理 postData</span>
      <span class="token function">getPostData</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>postData <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
          req<span class="token punctuation">.</span>body <span class="token operator">=</span> postData

          <span class="token comment" spellcheck="true">// 处理 blog 路由</span>
          <span class="token keyword">const</span> blogResult <span class="token operator">=</span> <span class="token function">handleBlogRouter</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>blogResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  blogResult<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>blogData <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
                  res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>
                      JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>blogData<span class="token punctuation">)</span>
                  <span class="token punctuation">)</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span>
              <span class="token keyword">return</span>
          <span class="token punctuation">}</span>


          <span class="token comment" spellcheck="true">// 处理 user 路由</span>
          <span class="token keyword">const</span> userResult <span class="token operator">=</span> <span class="token function">handleUserRouter</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>userResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              userResult<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>userData <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
                  res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>
                      JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>userData<span class="token punctuation">)</span>
                  <span class="token punctuation">)</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span>
              <span class="token keyword">return</span>
          <span class="token punctuation">}</span>
          <span class="token comment" spellcheck="true">// 未命中路由，返回404</span>
          res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">"Content-type"</span><span class="token punctuation">:</span> <span class="token string">"text/plain"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
          res<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"404 Not Found\n"</span><span class="token punctuation">)</span>
          res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

      <span class="token punctuation">}</span><span class="token punctuation">)</span>



  <span class="token punctuation">}</span>

  module<span class="token punctuation">.</span>exports <span class="token operator">=</span> serverHandle</code></pre>
<h3 id="Session"><a href="#Session" class="headerlink" title="Session"></a>Session</h3><ul>
<li>Cookie 存放信息非常危险</li>
<li>如何解决：cookie 中存储 userId， server 端对应 username</li>
<li>解决方案：session ，即 server 端储存用户信息</li>
</ul>
<pre class=" language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// ./src/router/user.js</span>
<span class="token comment" spellcheck="true">// ./src/router/user.js</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> login <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../controller/user'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//'路径里面不能有空格'</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> SuccessModel<span class="token punctuation">,</span> ErrorModel <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../model/resModel'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">//获取 cookie 过期时间</span>
<span class="token keyword">const</span> getCookieExpires <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> d <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    d<span class="token punctuation">.</span><span class="token function">setTime</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">24</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'d.toGMTString() is '</span><span class="token punctuation">,</span> d<span class="token punctuation">.</span><span class="token function">toGMTString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> d<span class="token punctuation">.</span><span class="token function">toGMTString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> handleUserRouter <span class="token operator">=</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> method <span class="token operator">=</span> req<span class="token punctuation">.</span>method <span class="token comment" spellcheck="true">//GET POST</span>

    <span class="token comment" spellcheck="true">// 登录</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">===</span> <span class="token string">'GET'</span> <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">'/api/user/login'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// const {username, password } = req.body</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> username<span class="token punctuation">,</span> password <span class="token punctuation">}</span> <span class="token operator">=</span>req<span class="token punctuation">.</span>query
        <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">login</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">)</span>
        <span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>data <span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>username<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// // 操作 cookie</span>
            <span class="token comment" spellcheck="true">// res.setHeader('Set-Cookie', `username=${data.username}; path=/; httpOnly; expires=${getCookieExpires()}`)</span>
                req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>username <span class="token operator">=</span> data<span class="token punctuation">.</span>username
                req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>realname <span class="token operator">=</span> data<span class="token punctuation">.</span>realname
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'session:'</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>session<span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SuccessModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ErrorModel</span><span class="token punctuation">(</span><span class="token string">'login failed!'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 登录验证测试</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">===</span> <span class="token string">'GET'</span> <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">'/api/user/login-test'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// console.log(req.cookie.username)</span>
        <span class="token comment" spellcheck="true">// 只能按顺序读取</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>username<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span> <span class="token keyword">new</span> <span class="token class-name">SuccessModel</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                session<span class="token punctuation">:</span> req<span class="token punctuation">.</span>session
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span> <span class="token keyword">new</span> <span class="token class-name">ErrorModel</span><span class="token punctuation">(</span><span class="token string">'未登录'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>


module<span class="token punctuation">.</span>exports <span class="token operator">=</span> handleUserRouter</code></pre>
<pre class=" language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// app.js 代码</span>

<span class="token keyword">const</span> handleBlogRouter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./src/router/blog'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> handleUserRouter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./src/router/user'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> querystring <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'querystring'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">//获取 cookie 过期时间</span>
<span class="token keyword">const</span> getCookieExpires <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> d <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    d<span class="token punctuation">.</span><span class="token function">setTime</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">24</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'d.toGMTString() is '</span><span class="token punctuation">,</span> d<span class="token punctuation">.</span><span class="token function">toGMTString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> d<span class="token punctuation">.</span><span class="token function">toGMTString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>


<span class="token comment" spellcheck="true">// session 数据</span>
<span class="token keyword">const</span> SESSION_DATA <span class="token operator">=</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 用于处理 post data</span>
<span class="token keyword">const</span> getPostData <span class="token operator">=</span> <span class="token punctuation">(</span>req<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">!==</span> <span class="token string">'POST'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'content-type'</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">'application/json'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">let</span> postData <span class="token operator">=</span> <span class="token string">''</span>
        <span class="token comment" spellcheck="true">// 开始接收数据</span>
        req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> chunk <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
            postData <span class="token operator">+</span><span class="token operator">=</span> chunk<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// 结束接收数据</span>
        req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>postData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span>
                JSON<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>postData<span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>


    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> promise
<span class="token punctuation">}</span>

<span class="token keyword">const</span> serverHandle <span class="token operator">=</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 设置返回值格式 JSON</span>
    res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-type'</span><span class="token punctuation">,</span> <span class="token string">'application/json'</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// 获取 path</span>
    <span class="token keyword">const</span> url <span class="token operator">=</span> req<span class="token punctuation">.</span>url
    req<span class="token punctuation">.</span>path <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

    <span class="token comment" spellcheck="true">// 解析 query</span>
    req<span class="token punctuation">.</span>query <span class="token operator">=</span> querystring<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// 解析 Cookie</span>
    req<span class="token punctuation">.</span>cookie <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">const</span> cookieStr <span class="token operator">=</span> req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>cookie <span class="token operator">||</span> <span class="token string">''</span> <span class="token comment" spellcheck="true">// k1=v1;k2=v2</span>
    cookieStr<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">';'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>item <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>item<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">const</span> arr <span class="token operator">=</span> item<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'='</span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> key <span class="token operator">=</span> arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> val <span class="token operator">=</span> arr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        req<span class="token punctuation">.</span>cookie<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> val
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// 解析 session </span>
    <span class="token keyword">let</span> needSetCookie <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token keyword">let</span> userId <span class="token operator">=</span> req<span class="token punctuation">.</span>cookie<span class="token punctuation">.</span>userid
    <span class="token keyword">if</span> <span class="token punctuation">(</span>userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>SESSION_DATA<span class="token punctuation">[</span>userId<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            SESSION_DATA<span class="token punctuation">[</span>userId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        needSetCookie <span class="token operator">=</span> <span class="token boolean">true</span>
        userId <span class="token operator">=</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>
        SESSION_DATA<span class="token punctuation">[</span>userId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    req<span class="token punctuation">.</span>session <span class="token operator">=</span> SESSION_DATA<span class="token punctuation">[</span>userId<span class="token punctuation">]</span>


    <span class="token comment" spellcheck="true">// 处理 postData</span>
    <span class="token function">getPostData</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>postData <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        req<span class="token punctuation">.</span>body <span class="token operator">=</span> postData

        <span class="token comment" spellcheck="true">// 处理 blog 路由</span>
        <span class="token keyword">const</span> blogResult <span class="token operator">=</span> <span class="token function">handleBlogRouter</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>blogResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                blogResult<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>blogData <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>needSetCookie<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 操作 cookie</span>
                        res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Set-Cookie'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`userid=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>userId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">; path=/; httpOnly; expires=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">getCookieExpires</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>
                res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>
                    JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>blogData<span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>


        <span class="token comment" spellcheck="true">// 处理 user 路由</span>
        <span class="token keyword">const</span> userResult <span class="token operator">=</span> <span class="token function">handleUserRouter</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>userResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            userResult<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>userData <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>needSetCookie<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 操作 cookie</span>
                    res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Set-Cookie'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`userid=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>userId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">; path=/; httpOnly; expires=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">getCookieExpires</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>

                <span class="token punctuation">}</span>
                res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>
                    JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>userData<span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 未命中路由，返回404</span>
        res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">"Content-type"</span><span class="token punctuation">:</span> <span class="token string">"text/plain"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        res<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"404 Not Found\n"</span><span class="token punctuation">)</span>
        res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token punctuation">}</span><span class="token punctuation">)</span>



<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> serverHandle</code></pre>
<p><strong>当前代码 session 代码的问题</strong></p>
<ul>
<li>session 是 JS 变量，放在 Node.js 进程内存中</li>
<li>进程内存有限，访问量过大，内存暴增怎么办？</li>
<li>正式上线是多进程，进程之间内存无法共享</li>
</ul>
<h3 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h3><h4 id="Redis-特点"><a href="#Redis-特点" class="headerlink" title="Redis 特点"></a>Redis 特点</h4><ul>
<li>Web Server 最常用的缓存数据库，数据储存在内存中</li>
<li>相比于 MySQL ，访问速度极快</li>
<li>成本更高，储存空间小</li>
<li>将 Web Server 和 Redis 拆分为两个单独服务</li>
<li>双方独立，可扩展</li>
<li>像 MySQL 一样</li>
</ul>
<h4 id="安装-Redis"><a href="#安装-Redis" class="headerlink" title="安装 Redis"></a>安装 Redis</h4><ul>
<li>Windows <a href="http://www.runoob.com/redis/redis-install.html" target="_blank" rel="noopener">http://www.runoob.com/redis/redis-install.html</a></li>
<li>Mac 使用 brew install redis</li>
</ul>
<p>打开系统设置，配置环境变量  <code>Path = C:\Program Files\Redis</code></p>
<h4 id="Redis-语法和操作："><a href="#Redis-语法和操作：" class="headerlink" title="Redis 语法和操作："></a>Redis 语法和操作：</h4><ul>
<li>启动 Redis：</li>
</ul>
<pre class=" language-dos"><code class="language-dos">redis-server.exe redis.windows.conf</code></pre>
<p>​    注意：这时候另启一个 cmd 窗口，原来的不要关闭，不然就无法访问服务端了。</p>
<ul>
<li>连接数据库:</li>
</ul>
<pre><code>redis-cli.exe -h 127.0.0.1 -p 6379</code></pre><ul>
<li>设置键值对:</li>
</ul>
<pre><code>set myKey abc</code></pre><ul>
<li>取出键值对:</li>
</ul>
<pre><code>get myKey</code></pre><ul>
<li>查看所有键值对:</li>
</ul>
<pre><code>keys *</code></pre><ul>
<li>标准语法 - 连接数据库并等待执行命令 ：</li>
</ul>
<pre><code>$ redis-cli -h host -p port -a password</code></pre><ul>
<li>停止 Redis：</li>
</ul>
<pre><code>redis-cli -h 127.0.0.1 -p 6379 shutdown </code></pre><ul>
<li>将该程序放到Windows服务中：</li>
</ul>
<pre><code>redis-server.exe --service-install redis.conf --loglevel verbose</code></pre><ul>
<li>卸载Windows服务中的Redis服务：</li>
</ul>
<pre><code>redis-server --service-uninstall</code></pre><p><strong>Redis keys 命令</strong></p>
<p>下表给出了与 Redis 键相关的基本命令：</p>
<table>
<thead>
<tr>
<th align="left">序号</th>
<th align="left">命令及描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1</td>
<td align="left"><a href="https://www.runoob.com/redis/keys-del.html" target="_blank" rel="noopener">DEL key</a> 该命令用于在 key 存在时删除 key。</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left"><a href="https://www.runoob.com/redis/keys-dump.html" target="_blank" rel="noopener">DUMP key</a> 序列化给定 key ，并返回被序列化的值。</td>
</tr>
<tr>
<td align="left">3</td>
<td align="left"><a href="https://www.runoob.com/redis/keys-exists.html" target="_blank" rel="noopener">EXISTS key</a> 检查给定 key 是否存在。</td>
</tr>
<tr>
<td align="left">4</td>
<td align="left"><a href="https://www.runoob.com/redis/keys-expire.html" target="_blank" rel="noopener">EXPIRE key</a> seconds 为给定 key 设置过期时间，以秒计。</td>
</tr>
<tr>
<td align="left">5</td>
<td align="left"><a href="https://www.runoob.com/redis/keys-expireat.html" target="_blank" rel="noopener">EXPIREAT key timestamp</a> EXPIREAT 的作用和 EXPIRE 类似，都用于为 key 设置过期时间。 不同在于 EXPIREAT 命令接受的时间参数是 UNIX 时间戳(unix timestamp)。</td>
</tr>
<tr>
<td align="left">6</td>
<td align="left"><a href="https://www.runoob.com/redis/keys-pexpire.html" target="_blank" rel="noopener">PEXPIRE key milliseconds</a> 设置 key 的过期时间以毫秒计。</td>
</tr>
<tr>
<td align="left">7</td>
<td align="left"><a href="https://www.runoob.com/redis/keys-pexpireat.html" target="_blank" rel="noopener">PEXPIREAT key milliseconds-timestamp</a> 设置 key 过期时间的时间戳(unix timestamp) 以毫秒计</td>
</tr>
<tr>
<td align="left">8</td>
<td align="left"><a href="https://www.runoob.com/redis/keys-keys.html" target="_blank" rel="noopener">KEYS pattern</a> 查找所有符合给定模式( pattern)的 key 。</td>
</tr>
<tr>
<td align="left">9</td>
<td align="left"><a href="https://www.runoob.com/redis/keys-move.html" target="_blank" rel="noopener">MOVE key db</a> 将当前数据库的 key 移动到给定的数据库 db 当中。</td>
</tr>
<tr>
<td align="left">10</td>
<td align="left"><a href="https://www.runoob.com/redis/keys-persist.html" target="_blank" rel="noopener">PERSIST key</a> 移除 key 的过期时间，key 将持久保持。</td>
</tr>
<tr>
<td align="left">11</td>
<td align="left"><a href="https://www.runoob.com/redis/keys-pttl.html" target="_blank" rel="noopener">PTTL key</a> 以毫秒为单位返回 key 的剩余的过期时间。</td>
</tr>
<tr>
<td align="left">12</td>
<td align="left"><a href="https://www.runoob.com/redis/keys-ttl.html" target="_blank" rel="noopener">TTL key</a> 以秒为单位，返回给定 key 的剩余生存时间(TTL, time to live)。</td>
</tr>
<tr>
<td align="left">13</td>
<td align="left"><a href="https://www.runoob.com/redis/keys-randomkey.html" target="_blank" rel="noopener">RANDOMKEY</a> 从当前数据库中随机返回一个 key 。</td>
</tr>
<tr>
<td align="left">14</td>
<td align="left"><a href="https://www.runoob.com/redis/keys-rename.html" target="_blank" rel="noopener">RENAME key newkey</a> 修改 key 的名称</td>
</tr>
<tr>
<td align="left">15</td>
<td align="left"><a href="https://www.runoob.com/redis/keys-renamenx.html" target="_blank" rel="noopener">RENAMENX key newkey</a> 仅当 newkey 不存在时，将 key 改名为 newkey 。</td>
</tr>
<tr>
<td align="left">16</td>
<td align="left"><a href="https://www.runoob.com/redis/keys-type.html" target="_blank" rel="noopener">TYPE key</a> 返回 key 所储存的值的类型。</td>
</tr>
</tbody></table>
<h4 id="Redis-数据持久化"><a href="#Redis-数据持久化" class="headerlink" title="Redis 数据持久化"></a>Redis 数据持久化</h4><pre><code>1. Rdb：快照形式，定期把内存中当前时刻的数据保存到磁盘。Redis默认支持的持久化方案。
2. aof形式：append only file。把所有对redis数据库操作的命令，增删改操作的命令，保存到文件中。
   如果redis宕机：数据库恢复时把启动命令执行一遍即可。（其实就是直接启动）</code></pre><p>持久化方案在redis.conf 配置文件中配置：</p>
<p> aof方式（这里直接修改就好）</p>
<pre><code>appendonly no              -- 默认关闭aof持久化方案， 如果要开启要把 no 修改为 yes

appendfilename &quot;appendonly.aof&quot;        -- 设置aof持久化的文件名</code></pre><p>  Rdb方式（默认，这里可以自己修改）： </p>
<pre><code>save 900 1            -- 900秒存入1条数据，开始持久化数据
save 300 10           -- 300秒存入10条数据，开始持久化数据
save 60 10000         -- 60秒存入10000条数据，开始持久化数据</code></pre><p><strong>手动输入命令存储到本地： <code>redis-cli bgsave</code></strong></p>
<p>可能出现的问题：强制关闭Redis快照导致不能持久化。</p>
<pre><code>TypeError:MISCONF Redis is configured to save RDB snapshots, but is currently not     able to persist on disk. Commands that may modify the data set are disabled. Please check Redis logs for details about the error.</code></pre><pre><code>解决方案： 将 stop-writes-on-bgsave-error 设置为 no 
输入命令： 127.0.0.1:6379&gt; config set stop-writes-on-bgsave-error no</code></pre><h4 id="Node-js-连接-Redis"><a href="#Node-js-连接-Redis" class="headerlink" title="Node.js 连接 Redis"></a>Node.js 连接 Redis</h4><pre><code> **demo 代码：**</code></pre><pre class=" language-javascript"><code class="language-javascript"><span class="token keyword">const</span> redis <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'redis'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 创建客户端</span>
<span class="token keyword">const</span> redisClient <span class="token operator">=</span> redis<span class="token punctuation">.</span><span class="token function">createClient</span><span class="token punctuation">(</span><span class="token number">6379</span><span class="token punctuation">,</span> <span class="token string">'127.0.0.1'</span><span class="token punctuation">)</span>
redisClient<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> err <span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 测试</span>
redisClient<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token string">'myname2'</span><span class="token punctuation">,</span> <span class="token string">'zhangsan张三'</span><span class="token punctuation">,</span> redis<span class="token punctuation">.</span>print<span class="token punctuation">)</span>
redisClient<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'myname2'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> val<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'val'</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// 退出</span>
    redisClient<span class="token punctuation">.</span><span class="token function">quit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<h4 id="Session-存入-Redis"><a href="#Session-存入-Redis" class="headerlink" title="Session 存入 Redis"></a>Session 存入 Redis</h4><pre class=" language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// 仅展示有改动的函数</span>
<span class="token comment" spellcheck="true">// app.js 代码</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">,</span> <span class="token keyword">set</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./src/db/redis'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> serverHandle <span class="token operator">=</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 设置返回值格式 JSON</span>
    res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-type'</span><span class="token punctuation">,</span> <span class="token string">'application/json'</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// 获取 path</span>
    <span class="token keyword">const</span> url <span class="token operator">=</span> req<span class="token punctuation">.</span>url
    req<span class="token punctuation">.</span>path <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

    <span class="token comment" spellcheck="true">// 解析 query</span>
    req<span class="token punctuation">.</span>query <span class="token operator">=</span> querystring<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// 解析 Cookie</span>
    req<span class="token punctuation">.</span>cookie <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">const</span> cookieStr <span class="token operator">=</span> req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>cookie <span class="token operator">||</span> <span class="token string">''</span> <span class="token comment" spellcheck="true">// k1=v1;k2=v2</span>
    cookieStr<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">';'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>item <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>item<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">const</span> arr <span class="token operator">=</span> item<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'='</span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> key <span class="token operator">=</span> arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> val <span class="token operator">=</span> arr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        req<span class="token punctuation">.</span>cookie<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> val
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// 解析 session </span>
    <span class="token comment" spellcheck="true">// let needSetCookie = false</span>
    <span class="token comment" spellcheck="true">// let userId = req.cookie.userid</span>
    <span class="token comment" spellcheck="true">// if (userId) {</span>
    <span class="token comment" spellcheck="true">//     if (!SESSION_DATA[userId]) {</span>
    <span class="token comment" spellcheck="true">//         SESSION_DATA[userId] = {}</span>
    <span class="token comment" spellcheck="true">//     }</span>
    <span class="token comment" spellcheck="true">// } else {</span>
    <span class="token comment" spellcheck="true">//     needSetCookie = true</span>
    <span class="token comment" spellcheck="true">//     userId = `${Date.now()}_${Math.random()}`</span>
    <span class="token comment" spellcheck="true">//     SESSION_DATA[userId] = {}</span>
    <span class="token comment" spellcheck="true">// }</span>
    <span class="token comment" spellcheck="true">// req.session = SESSION_DATA[userId]</span>

    <span class="token comment" spellcheck="true">// 解析 session </span>
    <span class="token keyword">let</span> needSetCookie <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token keyword">let</span> userId <span class="token operator">=</span> req<span class="token punctuation">.</span>cookie<span class="token punctuation">.</span>userid
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        needSetCookie <span class="token operator">=</span> <span class="token boolean">true</span>
        userId <span class="token operator">=</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>
        <span class="token keyword">set</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'userId:'</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// 获取session</span>
    req<span class="token punctuation">.</span>sessionId <span class="token operator">=</span> userId
    <span class="token keyword">get</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>sessionId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>sessionData <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sessionData <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 初始化 redis 中的 session 值</span>
            <span class="token keyword">set</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>sessionId<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token comment" spellcheck="true">//初始化 session</span>
            req<span class="token punctuation">.</span>session <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 设置 session</span>
            req<span class="token punctuation">.</span>session <span class="token operator">=</span> sessionData
        <span class="token punctuation">}</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'req.session:'</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>session<span class="token punctuation">)</span>

        <span class="token comment" spellcheck="true">// 处理 postData</span>
        <span class="token keyword">return</span> <span class="token function">getPostData</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>postData <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        req<span class="token punctuation">.</span>body <span class="token operator">=</span> postData

        <span class="token keyword">const</span> blogResult <span class="token operator">=</span> <span class="token function">handleBlogRouter</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>blogResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                blogResult<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>blogData <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>needSetCookie<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 操作 cookie</span>
                        res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Set-Cookie'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`userid=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>userId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">; path=/; httpOnly; expires=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">getCookieExpires</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>
                res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>
                    JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>blogData<span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>


        <span class="token comment" spellcheck="true">// 处理 user 路由</span>
        <span class="token keyword">const</span> userResult <span class="token operator">=</span> <span class="token function">handleUserRouter</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>userResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            userResult<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>userData <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>needSetCookie<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 操作 cookie</span>
                    res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Set-Cookie'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`userid=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>userId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">; path=/; httpOnly; expires=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">getCookieExpires</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>

                <span class="token punctuation">}</span>
                res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>
                    JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>userData<span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 未命中路由，返回404</span>
        res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">"Content-type"</span><span class="token punctuation">:</span> <span class="token string">"text/plain"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        res<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"404 Not Found\n"</span><span class="token punctuation">)</span>
        res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// 仅展示有改动的函数</span>
<span class="token comment" spellcheck="true">// ../src/router/user.js</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token keyword">get</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../db/redis'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> handleUserRouter <span class="token operator">=</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> method <span class="token operator">=</span> req<span class="token punctuation">.</span>method <span class="token comment" spellcheck="true">//GET POST</span>

    <span class="token comment" spellcheck="true">// 登录</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">===</span> <span class="token string">'POST'</span> <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">'/api/user/login'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// const {username, password } = req.body</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> username<span class="token punctuation">,</span> password <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body
        <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">login</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">)</span>
        <span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>data <span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>username<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// // 操作 cookie</span>
            <span class="token comment" spellcheck="true">// res.setHeader('Set-Cookie', `username=${data.username}; path=/; httpOnly; expires=${getCookieExpires()}`)</span>
                req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>username <span class="token operator">=</span> data<span class="token punctuation">.</span>username
                req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>realname <span class="token operator">=</span> data<span class="token punctuation">.</span>realname
                <span class="token keyword">set</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>sessionId<span class="token punctuation">,</span> req<span class="token punctuation">.</span>session<span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SuccessModel</span><span class="token punctuation">(</span><span class="token string">'登录成功！'</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ErrorModel</span><span class="token punctuation">(</span><span class="token string">'login failed!'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span></code></pre>
<h4 id="完成-Server-端登录代码"><a href="#完成-Server-端登录代码" class="headerlink" title="完成 Server 端登录代码"></a>完成 Server 端登录代码</h4><pre class=" language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// ../src/router/user.js</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> login <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../controller/user'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//'路径里面不能有空格'</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> SuccessModel<span class="token punctuation">,</span> ErrorModel <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../model/resModel'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token keyword">get</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../db/redis'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> handleUserRouter <span class="token operator">=</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> method <span class="token operator">=</span> req<span class="token punctuation">.</span>method <span class="token comment" spellcheck="true">//GET POST</span>

    <span class="token comment" spellcheck="true">// 登录</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">===</span> <span class="token string">'POST'</span> <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">'/api/user/login'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// const {username, password } = req.body</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> username<span class="token punctuation">,</span> password <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body
        <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">login</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">)</span>
        <span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>data <span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>username<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// // 操作 cookie</span>
            <span class="token comment" spellcheck="true">// res.setHeader('Set-Cookie', `username=${data.username}; path=/; httpOnly; expires=${getCookieExpires()}`)</span>
                req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>username <span class="token operator">=</span> data<span class="token punctuation">.</span>username
                req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>realname <span class="token operator">=</span> data<span class="token punctuation">.</span>realname
                <span class="token keyword">set</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>sessionId<span class="token punctuation">,</span> req<span class="token punctuation">.</span>session<span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SuccessModel</span><span class="token punctuation">(</span><span class="token string">'登录成功！'</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ErrorModel</span><span class="token punctuation">(</span><span class="token string">'login failed!'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/*// 登录验证测试
    if (method === 'GET' &amp;&amp; req.path === '/api/user/login-test') {
        // console.log(req.cookie.username)
        // 只能按顺序读取
        if (req.session.username) {

            return Promise.resolve( new SuccessModel({
                session: req.session
            })) 
        }
        return Promise.resolve( new ErrorModel('未登录'))
    }*/</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> handleUserRouter</code></pre>
<pre class=" language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// ./src/router/blog.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> 
    getList<span class="token punctuation">,</span> 
    getDetail<span class="token punctuation">,</span>
    newBlog<span class="token punctuation">,</span>
    updateBlog<span class="token punctuation">,</span>
    delBlog
<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../controller/blog'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> SuccessModel<span class="token punctuation">,</span> ErrorModel <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../model/resModel'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 统一的登录验证函数</span>
<span class="token keyword">const</span> loginCheck <span class="token operator">=</span> <span class="token punctuation">(</span>req<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>username<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span> 
            <span class="token keyword">new</span> <span class="token class-name">ErrorModel</span><span class="token punctuation">(</span><span class="token string">'未登录'</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> handleBlogRouter <span class="token operator">=</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> method <span class="token operator">=</span> req<span class="token punctuation">.</span>method <span class="token comment" spellcheck="true">//GET POST</span>
    <span class="token keyword">const</span> id <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>id

    <span class="token comment" spellcheck="true">//获取博客列表</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">===</span> <span class="token string">'GET'</span> <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">'/api/blog/list'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> author <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>author <span class="token operator">||</span> <span class="token string">''</span>
        <span class="token keyword">const</span> keyword <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>keyword <span class="token operator">||</span> <span class="token string">''</span>
        <span class="token comment" spellcheck="true">// const listData = getList(author, keyword)</span>
        <span class="token comment" spellcheck="true">// return new SuccessModel(listData)</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>isadmin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 管理员界面</span>
            <span class="token keyword">const</span> loginCheckResult <span class="token operator">=</span> <span class="token function">loginCheck</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>loginCheckResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 未登录</span>
                <span class="token keyword">return</span> loginCheckResult
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 强制查询自己的博客</span>
            author <span class="token operator">=</span> req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>username

        <span class="token punctuation">}</span>

        <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">getList</span><span class="token punctuation">(</span>author<span class="token punctuation">,</span> keyword<span class="token punctuation">)</span>
        <span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>listData <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SuccessModel</span><span class="token punctuation">(</span>listData<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//获取博客详情</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">===</span> <span class="token string">'GET'</span> <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>path <span class="token operator">===</span><span class="token string">'/api/blog/detail'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">getDetail</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
        <span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>detailData <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SuccessModel</span><span class="token punctuation">(</span>detailData<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//新建博客</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">===</span> <span class="token string">'POST'</span> <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">'/api/blog/new'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> loginCheckResult <span class="token operator">=</span> <span class="token function">loginCheck</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>loginCheckResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 未登录</span>
            <span class="token keyword">return</span> loginCheckResult
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// const author ='zhangsan' //作者假数据，等待登录</span>
        req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>author <span class="token operator">=</span> req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>username
        <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">newBlog</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">)</span>
        <span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>data <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SuccessModel</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//更新博客</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">===</span> <span class="token string">'POST'</span> <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">'/api/blog/update'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// const author ='zhangsan' //作者假数据，等待登录</span>
        <span class="token keyword">const</span> loginCheckResult <span class="token operator">=</span> <span class="token function">loginCheck</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>loginCheckResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 未登录</span>
            <span class="token keyword">return</span> loginCheckResult
        <span class="token punctuation">}</span>

        <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">updateBlog</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> req<span class="token punctuation">.</span>body<span class="token punctuation">)</span>
        <span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>value <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SuccessModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> 
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ErrorModel</span><span class="token punctuation">(</span><span class="token string">'Failed!'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>


    <span class="token comment" spellcheck="true">//删除博客</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">===</span> <span class="token string">'POST'</span> <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">'/api/blog/del'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// const author ='zhangsan' //作者假数据，等待登录</span>
        <span class="token keyword">const</span> loginCheckResult <span class="token operator">=</span> <span class="token function">loginCheck</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>loginCheckResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 未登录</span>
            <span class="token keyword">return</span> loginCheckResult
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// const author ='zhangsan' //作者假数据，等待登录</span>

        req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>author <span class="token operator">=</span> req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>username

        <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">delBlog</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> author<span class="token punctuation">)</span>
        <span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>value <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SuccessModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ErrorModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> handleBlogRouter</code></pre>
<h3 id="开发登录-前端联调"><a href="#开发登录-前端联调" class="headerlink" title="开发登录 前端联调"></a>开发登录 前端联调</h3><ul>
<li>登录依赖 Cookie，必须用浏览器</li>
<li>Cookie 跨域不共享，前端和 server 端必须同域</li>
<li>需要用到 Nginx 做代理，让前后端共域</li>
</ul>
<h4 id="启动-http-server"><a href="#启动-http-server" class="headerlink" title="启动 http-server"></a>启动 http-server</h4><ul>
<li><code>npm -install http-server</code></li>
<li><code>http-server -p 301</code></li>
</ul>
<h4 id="Nginx-反向代理"><a href="#Nginx-反向代理" class="headerlink" title="Nginx 反向代理"></a>Nginx 反向代理</h4><ul>
<li>高性能的 Web 服务器，开源免费</li>
<li>一般用于静态服务、负载平衡（本课用不到）</li>
<li>反向代理（本课用到）</li>
</ul>
<p>下载地址：</p>
<ul>
<li>Windows: <a href="http://nginx.org/en/download.html" target="_blank" rel="noopener">http://nginx.org/en/download.html</a></li>
<li>brew install nginx</li>
</ul>
<pre><code>Windows 启动 Nginx 的方法：

1.进入Nginx文件夹，打开PowerSheel

2.输入：start nginx

停止Nginx的方法：

nginx -s stop 或 nginx -s quit</code></pre><p><strong>配置方法：</strong> </p>
<p>修改文件：  <code>..\nginx-1.17.5\conf\nginx.conf</code> </p>
<pre><code>worker_processes  2;
 listen       8080;

        #location / {
        #   root   html;
        #    index  index.html index.htm;
        #}

        location / {
        proxy_pass http://localhost:301;
        }

        location /api/ {
        proxy_pass http://localhost:300;
        proxy_set_header Host $host;
        }</code></pre><p>注意：变更设置后要重启 Nginx ！</p>
<h4 id="联调测试各个功能"><a href="#联调测试各个功能" class="headerlink" title="联调测试各个功能"></a>联调测试各个功能</h4><p>增加管理页面权限</p>
<ul>
<li><code>admin.html</code> 增加一个<code>isadmin=1</code> 参数，使用登录者的用户名，后端也需要修改 </li>
</ul>
<pre class=" language-javascript"><code class="language-javascript">  <span class="token comment" spellcheck="true">// 只展示改动代码</span>
  <span class="token comment" spellcheck="true">// ../src/router/blog.js</span>
      <span class="token comment" spellcheck="true">//获取博客列表</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">===</span> <span class="token string">'GET'</span> <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">'/api/blog/list'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">let</span> author <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>author <span class="token operator">||</span> <span class="token string">''</span>
          <span class="token keyword">const</span> keyword <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>keyword <span class="token operator">||</span> <span class="token string">''</span>
          <span class="token comment" spellcheck="true">// const listData = getList(author, keyword)</span>
          <span class="token comment" spellcheck="true">// return new SuccessModel(listData)</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>isadmin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment" spellcheck="true">// 管理员界面</span>
              <span class="token keyword">const</span> loginCheckResult <span class="token operator">=</span> <span class="token function">loginCheck</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>loginCheckResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token comment" spellcheck="true">// 未登录</span>
                  <span class="token keyword">return</span> loginCheckResult
              <span class="token punctuation">}</span>
              <span class="token comment" spellcheck="true">// 强制查询自己的博客</span>
              author <span class="token operator">=</span> req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>username

          <span class="token punctuation">}</span>

          <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">getList</span><span class="token punctuation">(</span>author<span class="token punctuation">,</span> keyword<span class="token punctuation">)</span>
          <span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>listData <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
              <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SuccessModel</span><span class="token punctuation">(</span>listData<span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      <span class="token comment" spellcheck="true">//删除博客</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">===</span> <span class="token string">'POST'</span> <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">'/api/blog/del'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment" spellcheck="true">// const author ='zhangsan' //作者假数据，等待登录</span>
          <span class="token keyword">const</span> loginCheckResult <span class="token operator">=</span> <span class="token function">loginCheck</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>loginCheckResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment" spellcheck="true">// 未登录</span>
              <span class="token keyword">return</span> loginCheckResult
          <span class="token punctuation">}</span>
          <span class="token comment" spellcheck="true">// const author ='zhangsan' //作者假数据，等待登录</span>
          <span class="token comment" spellcheck="true">// req.body.author = req.session.username</span>
          <span class="token keyword">const</span> author <span class="token operator">=</span> req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>username
          <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">delBlog</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> author<span class="token punctuation">)</span>
          <span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>value <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SuccessModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
              <span class="token punctuation">}</span>
              <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ErrorModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span></code></pre>
<pre><code>


#### 总结

- Cookie 是什么？Session 是什么？如何实现登录？
- Redis 扮演什么角色？有什么核心价值？
- Nginx 的反向代理配置，联调过程中的作用



## 日志

- 系统日志记录系统状态
  1. 访问日志 access log（ server 端最重要的日志）
  2. 自定义日志（包括自定义时间，错误记录等）
- Node.js 文件操作，Node.js stream
  - 日志储存到文件中成本低方便
  - 日志文件文件大，文件单一
- 日志功能的开发和使用
- 日志文件拆分，日志内容分析

### Node.js 操作文件

#### 代码演示

​```javascript
const fs = require(&#39;fs&#39;)
const path = require(&#39;path&#39;)

const fileName = path.resolve(__dirname, &#39;data.txt&#39;)

// 读取文件内容
fs.readFile(fileName, (err, data) =&gt; {
    if (err) {
        console.error(err)
        return
    }
    console.log(data.toString())
    return 
})

const content = &#39;这是新的内容\n&#39;
const opt = {
    flag: &#39;a&#39; // 追加写入，覆盖用 W
}
fs.writeFile(fileName, content, opt, (err) =&gt; {
    if (err) {
        console.log(err)
    }
})
</code></pre><h3 id="Stream"><a href="#Stream" class="headerlink" title="Stream"></a>Stream</h3><ul>
<li>IO 操作的性能瓶颈<ul>
<li>IO 包括 “网络 IO” 和 “文件 IO”</li>
<li>相对于 CPU 计算和内存读写， IO 的突出特点就是：慢</li>
<li>如何在有限的硬件资源下提高 IO 的操作效率</li>
</ul>
</li>
</ul>
<h4 id="代码演示"><a href="#代码演示" class="headerlink" title="代码演示"></a>代码演示</h4><pre class=" language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// 标准输入输出</span>
<span class="token comment" spellcheck="true">// process.stdin.pipe(process.stdout)</span>

<span class="token comment" spellcheck="true">// const http = require('http')</span>
<span class="token comment" spellcheck="true">// const server = http.createServer((req, res) => {</span>
<span class="token comment" spellcheck="true">//     if (req.method === 'POST') {</span>
<span class="token comment" spellcheck="true">//         req.pipe(res)</span>
<span class="token comment" spellcheck="true">//     }</span>
<span class="token comment" spellcheck="true">// })</span>

<span class="token comment" spellcheck="true">// server.listen(8000)</span>


<span class="token comment" spellcheck="true">// 复制文件</span>
<span class="token comment" spellcheck="true">// const fs = require('fs')</span>
<span class="token comment" spellcheck="true">// const path = require('path')</span>

<span class="token comment" spellcheck="true">// const fileName1 = path.resolve(__dirname, 'data.txt')</span>
<span class="token comment" spellcheck="true">// const fileName2 = path.resolve(__dirname, 'data-back.txt')</span>

<span class="token comment" spellcheck="true">// const readStream = fs.createReadStream(fileName1)</span>
<span class="token comment" spellcheck="true">// const writeStream = fs.createWriteStream(fileName2)</span>

<span class="token comment" spellcheck="true">// readStream.pipe(writeStream)</span>
<span class="token comment" spellcheck="true">// readStream.on('data', chunk => {</span>
<span class="token comment" spellcheck="true">//     console.log(chunk.toString())</span>
<span class="token comment" spellcheck="true">// })</span>
<span class="token comment" spellcheck="true">// readStream.on('end', () => {</span>
<span class="token comment" spellcheck="true">//     console.log('done!')</span>
<span class="token comment" spellcheck="true">// })</span>


<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> fileName1 <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'data.txt'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">'GET'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> readStream <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span>fileName1<span class="token punctuation">)</span>
        readStream<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">)</span></code></pre>
<h3 id="写日志"><a href="#写日志" class="headerlink" title="写日志"></a>写日志</h3><pre class=" language-javascript"><code class="language-javascript"><span class="token comment" spellcheck="true">// ../src/utils/log.js</span>

<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 写日志</span>
<span class="token keyword">function</span> <span class="token function">writeLog</span><span class="token punctuation">(</span>writeStream<span class="token punctuation">,</span> log<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    writeStream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>log <span class="token operator">+</span> <span class="token string">'\n'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//关键代码</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 生成 write Stream</span>
<span class="token keyword">function</span> <span class="token function">createWriteStream</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> fullFileName <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../'</span><span class="token punctuation">,</span> <span class="token string">'../'</span><span class="token punctuation">,</span> <span class="token string">'logs'</span><span class="token punctuation">,</span> fileName<span class="token punctuation">)</span>
    <span class="token keyword">const</span> writeStream <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span>fullFileName<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        flags<span class="token punctuation">:</span> <span class="token string">'a'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> writeStream
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 写访问日志</span>
<span class="token keyword">const</span> accessWriteStream <span class="token operator">=</span> <span class="token function">createWriteStream</span><span class="token punctuation">(</span><span class="token string">'access.log'</span><span class="token punctuation">)</span>
<span class="token keyword">function</span> <span class="token function">access</span><span class="token punctuation">(</span>log<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">writeLog</span><span class="token punctuation">(</span>accessWriteStream<span class="token punctuation">,</span> log<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span><span class="token punctuation">{</span>
    access
<span class="token punctuation">}</span></code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// app.js 代码</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> access <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./src/utils/log'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> serverHandle <span class="token operator">=</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 写访问日志</span>
    <span class="token function">access</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">--</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>method<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">--</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">--</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'user-agent'</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// 设置返回值格式 JSON</span>
    res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-type'</span><span class="token punctuation">,</span> <span class="token string">'application/json'</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// 获取 path</span>
    <span class="token keyword">const</span> url <span class="token operator">=</span> req<span class="token punctuation">.</span>url
    req<span class="token punctuation">.</span>path <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

    <span class="token comment" spellcheck="true">// 解析 query</span>
    req<span class="token punctuation">.</span>query <span class="token operator">=</span> querystring<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// 解析 Cookie</span>
    req<span class="token punctuation">.</span>cookie <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">const</span> cookieStr <span class="token operator">=</span> req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>cookie <span class="token operator">||</span> <span class="token string">''</span> <span class="token comment" spellcheck="true">// k1=v1;k2=v2</span>
    cookieStr<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">';'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>item <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>item<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">const</span> arr <span class="token operator">=</span> item<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'='</span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> key <span class="token operator">=</span> arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> val <span class="token operator">=</span> arr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        req<span class="token punctuation">.</span>cookie<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> val
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// 解析 session </span>
    <span class="token keyword">let</span> needSetCookie <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token keyword">let</span> userId <span class="token operator">=</span> req<span class="token punctuation">.</span>cookie<span class="token punctuation">.</span>userid
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        needSetCookie <span class="token operator">=</span> <span class="token boolean">true</span>
        userId <span class="token operator">=</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>
        <span class="token keyword">set</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// console.log('userId:', userId)</span>

    <span class="token comment" spellcheck="true">// 获取session</span>
    req<span class="token punctuation">.</span>sessionId <span class="token operator">=</span> userId
    <span class="token keyword">get</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>sessionId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>sessionData <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sessionData <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 初始化 redis 中的 session 值</span>
            <span class="token keyword">set</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>sessionId<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token comment" spellcheck="true">//初始化 session</span>
            req<span class="token punctuation">.</span>session <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 设置 session</span>
            req<span class="token punctuation">.</span>session <span class="token operator">=</span> sessionData
        <span class="token punctuation">}</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'req.session:'</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>session<span class="token punctuation">)</span>

        <span class="token comment" spellcheck="true">// 处理 postData</span>
        <span class="token keyword">return</span> <span class="token function">getPostData</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>postData <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        req<span class="token punctuation">.</span>body <span class="token operator">=</span> postData

        <span class="token keyword">const</span> blogResult <span class="token operator">=</span> <span class="token function">handleBlogRouter</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>blogResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                blogResult<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>blogData <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>needSetCookie<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 操作 cookie</span>
                        res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Set-Cookie'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`userid=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>userId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">; path=/; httpOnly; expires=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">getCookieExpires</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>
                res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>
                    JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>blogData<span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>


        <span class="token comment" spellcheck="true">// 处理 user 路由</span>
        <span class="token keyword">const</span> userResult <span class="token operator">=</span> <span class="token function">handleUserRouter</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>userResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            userResult<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>userData <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>needSetCookie<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 操作 cookie</span>
                    res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Set-Cookie'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`userid=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>userId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">; path=/; httpOnly; expires=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">getCookieExpires</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>

                <span class="token punctuation">}</span>
                res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>
                    JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>userData<span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 未命中路由，返回404</span>
        res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">"Content-type"</span><span class="token punctuation">:</span> <span class="token string">"text/plain"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        res<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"404 Not Found\n"</span><span class="token punctuation">)</span>
        res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> serverHandle</code></pre>
<h3 id="日志拆分"><a href="#日志拆分" class="headerlink" title="日志拆分"></a>日志拆分</h3><ul>
<li>日志内容会慢慢积累，放在一个文件中不好处理</li>
<li>按时间划分日志文件，如 2019-02-10.access.log</li>
<li>实现方式：Linux 的 crontab 命令，即定时任务</li>
</ul>
<h4 id="Crontab"><a href="#Crontab" class="headerlink" title="Crontab"></a>Crontab</h4><ul>
<li><p>设置定时任务，格式：<code>***** command</code> </p>
<pre><code>  *分钟*小时*天*月*星期 command脚本命令</code></pre><pre><code></code></pre></li>
<li><p>将 access.log 拷贝并重命名为 2019-02-10.access.log </p>
<ul>
<li>清空 access.log 文件，继续积累日志<pre><code></code></pre></li>
</ul>
</li>
</ul>
<h4 id="代码演示-1"><a href="#代码演示-1" class="headerlink" title="代码演示"></a>代码演示</h4><pre class=" language-sh"><code class="language-sh"># blog-1/src/utils/copy.sh

#!/bin/sh
cd /Users/wfp/Project/video-tutorial/node-tutorial/code-demo/blog-1
cp access.log $(date +%Y-%m-%d).access.log
echo "" > access.log</code></pre>
<pre class=" language-sh"><code class="language-sh">命令行输入：crontab -e 
输入： *0*** sh /Users/wfp/Project/video-tutorial/node-tutorial/code-demo/blog-1/src/utils/copy.sh

输入：crontab -l 查看所有任务</code></pre>
<h3 id="日志分析"><a href="#日志分析" class="headerlink" title="日志分析"></a>日志分析</h3><ul>
<li>如针对 access.log 日志，分析 chrome 的占比</li>
<li>日志是按行储存的，一行就是一条日志</li>
<li>使用 node.js 的 readline （基于 stream ，按行读取，效率高）</li>
</ul>
<pre class=" language-js"><code class="language-js"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> readline <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'readline'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 解析文件名</span>
<span class="token keyword">const</span> fileName <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../'</span><span class="token punctuation">,</span> <span class="token string">'../'</span><span class="token punctuation">,</span><span class="token string">'logs'</span><span class="token punctuation">,</span> <span class="token string">'access.log'</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">// 创建 readStream </span>
<span class="token keyword">const</span> readStream <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 创建 readline 对象</span>
<span class="token keyword">const</span> rl <span class="token operator">=</span> readline<span class="token punctuation">.</span><span class="token function">createInterface</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    input<span class="token punctuation">:</span> readStream
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> chromeNum <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">let</span> sum <span class="token operator">=</span> <span class="token number">0</span>

<span class="token comment" spellcheck="true">// 逐行读取</span>
rl<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'line'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>lineData<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>lineData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    sum<span class="token operator">++</span>

    <span class="token keyword">const</span> arr <span class="token operator">=</span> lineData<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'--'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>arr<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> arr<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'Chrome'</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 累加 chrome 数量</span>
        chromeNum<span class="token operator">++</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 监听读取完成</span>
rl<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'close'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'访问总数: '</span><span class="token punctuation">,</span> sum<span class="token punctuation">,</span> <span class="token string">'\nchrome 数量：'</span><span class="token punctuation">,</span> chromeNum<span class="token punctuation">,</span> <span class="token string">'\nchrome 占比：'</span><span class="token punctuation">,</span> chromeNum <span class="token operator">/</span> sum<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<h3 id="总结-3"><a href="#总结-3" class="headerlink" title="总结"></a>总结</h3><ul>
<li>日志对 server 的重要性</li>
<li>IO 性能瓶颈，使用 stream 提高性能， node.js 中如何操作</li>
<li>使用 Crontab 拆分日志，使用 readline 分析日志内容</li>
</ul>
<h2 id="Web-安全"><a href="#Web-安全" class="headerlink" title="Web 安全"></a>Web 安全</h2><h3 id="常见安全问题和解决方案"><a href="#常见安全问题和解决方案" class="headerlink" title="常见安全问题和解决方案"></a>常见安全问题和解决方案</h3><ul>
<li>SQL 注入：窃取数据库内容</li>
<li>XSS攻击：窃取前端的 Cookie 内容</li>
<li>密码加密：保障用户信息安全（重要）</li>
<li>Server 端攻击方式非常多，预防手段也非常多</li>
<li>本科只讲常见的、能通过 Web Server ( Node.js ) 层面预防的</li>
<li>有些攻击需要<strong>硬件和服务</strong>来支持（需要 OP 支持），如 DDOS</li>
</ul>
<h4 id="SQL-注入"><a href="#SQL-注入" class="headerlink" title="SQL 注入"></a>SQL 注入</h4><ul>
<li>最原始、最简单的攻击，从有了 Web2.0 就有了 SQL 注入攻击</li>
<li>攻击方式：输入一个 SQL 片段，最终拼接成一段攻击代码</li>
<li>预防措施：使用 MySQL　的 escape 函数处理输入数据内容即可</li>
</ul>
<p>代码演示：</p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 在login用户名输入：' --  或 ‘；delete from users</span>
<span class="token comment" spellcheck="true">// 就可以注释掉后续语句或者删掉这个表</span>
<span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token string">`
        select username, realname from users where username='</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>username<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">' and password='</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>password<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">'
    `</span></span>
<span class="token comment" spellcheck="true">// 解决方法</span>
<span class="token comment" spellcheck="true">// 使用 mysql.escape 函数转义所有数据库输入</span>

<span class="token comment" spellcheck="true">// ../src/controller/user.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> exec<span class="token punctuation">,</span> escape <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../db/mysql.js'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 登录验证</span>
<span class="token keyword">const</span> login <span class="token operator">=</span> <span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    username <span class="token operator">=</span> <span class="token function">escape</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span>
    password <span class="token operator">=</span> <span class="token function">escape</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span>

    <span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token string">`
        select username, realname from users where username=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>username<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> and password=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>password<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
    `</span></span>
    <span class="token keyword">return</span> <span class="token function">exec</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>rows <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> rows<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    login
<span class="token punctuation">}</span></code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">//../src/controller/blog.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> exec<span class="token punctuation">,</span> escape <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../db/mysql'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">//博客列表</span>
<span class="token keyword">const</span> getList <span class="token operator">=</span> <span class="token punctuation">(</span>author<span class="token punctuation">,</span> keyword<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token string">`select * from blogs where 1=1 `</span></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>author<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        author <span class="token operator">=</span> <span class="token function">escape</span><span class="token punctuation">(</span>author<span class="token punctuation">)</span>
        sql <span class="token operator">+</span><span class="token operator">=</span> <span class="token template-string"><span class="token string">`and author=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>author<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> `</span></span>
    <span class="token punctuation">}</span> 
    <span class="token keyword">if</span> <span class="token punctuation">(</span>keyword<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        keyword <span class="token operator">=</span> <span class="token function">escape</span><span class="token punctuation">(</span><span class="token string">'%'</span> <span class="token operator">+</span> keyword <span class="token operator">+</span> <span class="token string">'%'</span><span class="token punctuation">)</span>
        sql <span class="token operator">+</span><span class="token operator">=</span> <span class="token template-string"><span class="token string">`and title like </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>keyword<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> `</span></span>
    <span class="token punctuation">}</span>
    sql <span class="token operator">+</span><span class="token operator">=</span> <span class="token template-string"><span class="token string">`order by createtime desc;`</span></span>

    <span class="token comment" spellcheck="true">// console.log(sql)</span>
    <span class="token comment" spellcheck="true">//返回 promise</span>
    <span class="token keyword">return</span> <span class="token function">exec</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//博客详情</span>
<span class="token keyword">const</span> getDetail <span class="token operator">=</span> <span class="token punctuation">(</span> id <span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token string">`select * from blogs where id=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>
    <span class="token keyword">return</span> <span class="token function">exec</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>rows <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> rows<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//新建博客</span>
<span class="token keyword">const</span> newBlog <span class="token operator">=</span> <span class="token punctuation">(</span>blogData <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// blogData 是一个博客对象，包含 title conten 属性</span>
    <span class="token keyword">const</span> title <span class="token operator">=</span> <span class="token function">escape</span><span class="token punctuation">(</span>blogData<span class="token punctuation">.</span>title<span class="token punctuation">)</span>
    <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token function">escape</span><span class="token punctuation">(</span>blogData<span class="token punctuation">.</span>content<span class="token punctuation">)</span>
    <span class="token keyword">const</span> author <span class="token operator">=</span> <span class="token function">escape</span><span class="token punctuation">(</span>blogData<span class="token punctuation">.</span>author<span class="token punctuation">)</span>
    <span class="token keyword">const</span> createtime <span class="token operator">=</span> <span class="token function">escape</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token string">`
    insert into blogs (title, content, createtime, author)
    values(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>title<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>content<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>createtime<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>author<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)
    `</span></span>

    <span class="token keyword">return</span> <span class="token function">exec</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>insertData <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            id<span class="token punctuation">:</span> insertData<span class="token punctuation">.</span>insertId
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//更新博客</span>
<span class="token keyword">const</span> updateBlog <span class="token operator">=</span> <span class="token punctuation">(</span>id<span class="token punctuation">,</span> blogData <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// id 就是要更新的 id</span>
    <span class="token comment" spellcheck="true">// blogData 是一个博客对象，包含 title content 属性</span>
    <span class="token keyword">const</span> title <span class="token operator">=</span> <span class="token function">escape</span><span class="token punctuation">(</span>blogData<span class="token punctuation">.</span>title<span class="token punctuation">)</span>
    <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token function">escape</span><span class="token punctuation">(</span>blogData<span class="token punctuation">.</span>content<span class="token punctuation">)</span>

    <span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token string">`
        update blogs set title=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>title<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, content=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>content<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> where id=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
    `</span></span>

    <span class="token keyword">return</span> <span class="token function">exec</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>updateData <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>updateData<span class="token punctuation">.</span>affectedRows <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//删除博客</span>
<span class="token keyword">const</span> delBlog <span class="token operator">=</span> <span class="token punctuation">(</span>id<span class="token punctuation">,</span> author<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// author 是 session 中的 username 无需转义 但为了保持SQL语句一致也转义</span>
    author <span class="token operator">=</span> <span class="token function">escape</span><span class="token punctuation">(</span>author<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// id 就是要删除的博客的 idauthor = escape(author)</span>
    <span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token string">`delete from blogs where id=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> and author=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>author<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>

    <span class="token keyword">return</span> <span class="token function">exec</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>delData <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>delData<span class="token punctuation">.</span>affectedRows <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    getList<span class="token punctuation">,</span>
    getDetail<span class="token punctuation">,</span>
    newBlog<span class="token punctuation">,</span>
    updateBlog<span class="token punctuation">,</span>
    delBlog
<span class="token punctuation">}</span></code></pre>
<h4 id="XSS-攻击"><a href="#XSS-攻击" class="headerlink" title="XSS 攻击"></a>XSS 攻击</h4><ul>
<li>前端同学熟知的攻击方式，但 Server 端更应该掌握</li>
<li>攻击方式：在页面展示内容中参杂 JS 代码，以获取网页信息</li>
<li>预防措施：转换生成 JS 的特殊字符 </li>
</ul>
<p>代码演示：</p>
<pre class=" language-html"><code class="language-html">// 在新建博客 title 或 content 中输入：
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script language-javascript"><span class="token function">alert</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code></pre>
<p>解决方案：引入 xss 库</p>
<ul>
<li><p>在文件夹 blog-1 中安装 xss： <code>npm i xss</code></p>
</li>
<li><p>代码演示：</p>
</li>
</ul>
<pre class=" language-js"><code class="language-js">  <span class="token comment" spellcheck="true">//../src/controller/blog.js</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> exec<span class="token punctuation">,</span> escape <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../db/mysql'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> xss <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'xss'</span><span class="token punctuation">)</span>

  <span class="token comment" spellcheck="true">//博客列表</span>
  <span class="token keyword">const</span> getList <span class="token operator">=</span> <span class="token punctuation">(</span>author<span class="token punctuation">,</span> keyword<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token string">`select * from blogs where 1=1 `</span></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>author<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          author <span class="token operator">=</span> <span class="token function">escape</span><span class="token punctuation">(</span>author<span class="token punctuation">)</span>
          sql <span class="token operator">+</span><span class="token operator">=</span> <span class="token template-string"><span class="token string">`and author=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>author<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> `</span></span>
      <span class="token punctuation">}</span> 
      <span class="token keyword">if</span> <span class="token punctuation">(</span>keyword<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          keyword <span class="token operator">=</span> <span class="token function">escape</span><span class="token punctuation">(</span><span class="token string">'%'</span> <span class="token operator">+</span> <span class="token function">xss</span><span class="token punctuation">(</span>keyword<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'%'</span><span class="token punctuation">)</span>
          sql <span class="token operator">+</span><span class="token operator">=</span> <span class="token template-string"><span class="token string">`and title like </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>keyword<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> `</span></span>
      <span class="token punctuation">}</span>
      sql <span class="token operator">+</span><span class="token operator">=</span> <span class="token template-string"><span class="token string">`order by createtime desc;`</span></span>

      <span class="token comment" spellcheck="true">// console.log(sql)</span>
      <span class="token comment" spellcheck="true">//返回 promise</span>
      <span class="token keyword">return</span> <span class="token function">exec</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">//博客详情</span>
  <span class="token keyword">const</span> getDetail <span class="token operator">=</span> <span class="token punctuation">(</span> id <span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token string">`select * from blogs where id=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>
      <span class="token keyword">return</span> <span class="token function">exec</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>rows <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> rows<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">//新建博客</span>
  <span class="token keyword">const</span> newBlog <span class="token operator">=</span> <span class="token punctuation">(</span>blogData <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// blogData 是一个博客对象，包含 title conten 属性</span>
      <span class="token keyword">const</span> title <span class="token operator">=</span> <span class="token function">escape</span><span class="token punctuation">(</span><span class="token function">xss</span><span class="token punctuation">(</span>blogData<span class="token punctuation">.</span>title<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token function">escape</span><span class="token punctuation">(</span><span class="token function">xss</span><span class="token punctuation">(</span>blogData<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> author <span class="token operator">=</span> <span class="token function">escape</span><span class="token punctuation">(</span>blogData<span class="token punctuation">.</span>author<span class="token punctuation">)</span>
      <span class="token keyword">const</span> createtime <span class="token operator">=</span> <span class="token function">escape</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token string">`
      insert into blogs (title, content, createtime, author)
      values(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>title<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>content<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>createtime<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>author<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)
      `</span></span>

      <span class="token keyword">return</span> <span class="token function">exec</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>insertData <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token punctuation">{</span>
              id<span class="token punctuation">:</span> insertData<span class="token punctuation">.</span>insertId
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">//更新博客</span>
  <span class="token keyword">const</span> updateBlog <span class="token operator">=</span> <span class="token punctuation">(</span>id<span class="token punctuation">,</span> blogData <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// id 就是要更新的 id</span>
      <span class="token comment" spellcheck="true">// blogData 是一个博客对象，包含 title content 属性</span>
      <span class="token keyword">const</span> title <span class="token operator">=</span> <span class="token function">escape</span><span class="token punctuation">(</span><span class="token function">xss</span><span class="token punctuation">(</span>blogData<span class="token punctuation">.</span>title<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token function">escape</span><span class="token punctuation">(</span><span class="token function">xss</span><span class="token punctuation">(</span>blogData<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token string">`
          update blogs set title=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>title<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, content=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>content<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> where id=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
      `</span></span>

      <span class="token keyword">return</span> <span class="token function">exec</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>updateData <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>updateData<span class="token punctuation">.</span>affectedRows <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">return</span> <span class="token boolean">true</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">return</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">//删除博客</span>
  <span class="token keyword">const</span> delBlog <span class="token operator">=</span> <span class="token punctuation">(</span>id<span class="token punctuation">,</span> author<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
      author <span class="token operator">=</span> <span class="token function">escape</span><span class="token punctuation">(</span>author<span class="token punctuation">)</span>
      <span class="token comment" spellcheck="true">// id 就是要删除的博客的 id </span>
      <span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token string">`delete from blogs where id=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> and author=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>author<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token function">exec</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>delData <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>delData<span class="token punctuation">.</span>affectedRows <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">return</span> <span class="token boolean">true</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">return</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
      getList<span class="token punctuation">,</span>
      getDetail<span class="token punctuation">,</span>
      newBlog<span class="token punctuation">,</span>
      updateBlog<span class="token punctuation">,</span>
      delBlog
  <span class="token punctuation">}</span></code></pre>
<h4 id="密码加密"><a href="#密码加密" class="headerlink" title="密码加密"></a>密码加密</h4><ul>
<li>万一数据库被攻破，避免泄露用户信息</li>
<li>攻击方式：获取用户名和密码，再去尝试登录其它系统</li>
<li>预防措施：密码加密，密文储存</li>
</ul>
<p>代码演示：</p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ./src/utils/cryp.js</span>

<span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 密钥</span>
<span class="token keyword">const</span> SECRT_KEY <span class="token operator">=</span> <span class="token string">'ZWiep-2947@.?'</span>

<span class="token comment" spellcheck="true">// md5 加密</span>
<span class="token keyword">function</span> <span class="token function">md5</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> md5 <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createHash</span><span class="token punctuation">(</span><span class="token string">'md5'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> md5<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 加密函数</span>
<span class="token keyword">function</span> <span class="token function">genPassword</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> str <span class="token operator">=</span> <span class="token template-string"><span class="token string">`password=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>password<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;key=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>SECRT_KEY<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>
    <span class="token keyword">return</span> <span class="token function">md5</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">// const result = genPassword('1234')</span>
<span class="token comment" spellcheck="true">// console.log(result)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    genPassword
<span class="token punctuation">}</span></code></pre>
<h3 id="不用框架开发博客总结"><a href="#不用框架开发博客总结" class="headerlink" title="不用框架开发博客总结"></a>不用框架开发博客总结</h3><h4 id="主要课程"><a href="#主要课程" class="headerlink" title="主要课程"></a>主要课程</h4><ol>
<li>处理 Http 接口</li>
<li>连接数据库</li>
<li>实现登录</li>
<li>安全</li>
<li>日志</li>
<li>上线（最后一起讲）</li>
</ol>
<h4 id="Server-和前端区别"><a href="#Server-和前端区别" class="headerlink" title="Server 和前端区别"></a>Server 和前端区别</h4><ul>
<li>服务稳定性（zui后讲）</li>
<li>内存 CPU （优化 扩展）</li>
<li>日志记录</li>
<li>安全（包括登录验证）</li>
<li>集群和服务拆分</li>
</ul>
<h4 id="下一步要怎么做"><a href="#下一步要怎么做" class="headerlink" title="下一步要怎么做"></a>下一步要怎么做</h4><ul>
<li>不使用框架开发，从零开始，关注底层 API</li>
<li>很琐碎、复杂，没有标准，很容易写乱</li>
<li>适合学习，但不适合应用，接下来开始 Express 和 Koa2</li>
</ul>
<h2 id="Express-框架"><a href="#Express-框架" class="headerlink" title="Express 框架"></a>Express 框架</h2><h3 id="Express-介绍"><a href="#Express-介绍" class="headerlink" title="Express 介绍"></a>Express 介绍</h3><ul>
<li>Express 是 Node.js 最常用的 Web Server 框架</li>
<li>什么是框架？</li>
<li>不要以为 Express 框架过时了</li>
</ul>
<p>目录</p>
<ul>
<li>Express 下载、安装和使用，了解 Express 中间件机制</li>
<li>开发接口、连接数据库、实现登录、记录日志</li>
<li>分析 Express 中间件原理</li>
</ul>
<p>介绍 Express </p>
<ul>
<li>安装（使用脚手架 Express-grnerator）</li>
<li>初始化代码介绍，处理路由</li>
<li>使用中间件</li>
</ul>
<h4 id="安装-Express"><a href="#安装-Express" class="headerlink" title="安装 Express"></a>安装 Express</h4><ul>
<li><code>npm install express-generator -g</code></li>
<li><code>express express-test</code></li>
<li><code>npm install &amp; npm start</code></li>
</ul>
<pre><code>npm install   //默认安装package.json中的所有模块。</code></pre><pre><code>如果只想安装dependencies中的内容，可以使用--dependencies字段：
npm install --dependencies  </code></pre><pre><code>同样只想安装devDependencies中的内容，可以使用--devDependencies字段：
npm install --devDependencies</code></pre><pre><code>这里安装的package.json中所有依赖的模块，都是package.json中指定的版本。如果需要安装最新的版本则要：
npm update &lt;package_name&gt;  //要安装的模块的名字</code></pre><pre><code>npm install -save-dev moduleName 命令:
安装模块到项目node_modules目录下。
会将模块依赖写入devDependencies 节点。
运行 npm install 初始化项目时，会将模块下载到项目目录下。
运行npm install --production或者注明NODE_ENV变量值为production时，不会自动下载模块到node_modules目录中。

devDependencies 节点下的模块是我们在开发时需要用的，比如项目中使用的 gulp ，压缩css、js的模块。这些模块在我们的项目部署后是不需要的，所以我们可以使用 -save-dev 的形式安装。像 express 这些模块是项目运行必备的，应该安装在 dependencies 节点下，所以我们应该使用 -save 的形式安装。</code></pre><h4 id="Express-的入口代码"><a href="#Express-的入口代码" class="headerlink" title="Express 的入口代码"></a>Express 的入口代码</h4><ul>
<li>介绍 app.js<ul>
<li>各个插件的作用</li>
<li>思考各个插件的实现原理（结合之前学过的知识）</li>
<li>处理 GET 和 POST 请求</li>
</ul>
</li>
</ul>
<pre class=" language-js"><code class="language-js"><span class="token keyword">var</span> createError <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http-errors'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 处理404 生成错误页 </span>
<span class="token keyword">var</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 路径</span>
<span class="token keyword">var</span> cookieParser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cookie-parser'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 解析 Cookie</span>
<span class="token keyword">var</span> logger <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'morgan'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 记录日志</span>

<span class="token keyword">var</span> indexRouter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./routes/index'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 引用路由</span>
<span class="token keyword">var</span> usersRouter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./routes/users'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 引用路由</span>

<span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 生成实例</span>

<span class="token comment" spellcheck="true">// view engine setup</span>
app<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token string">'views'</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'views'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 前端</span>
app<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token string">'view engine'</span><span class="token punctuation">,</span> <span class="token string">'jade'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 前端</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">logger</span><span class="token punctuation">(</span><span class="token string">'dev'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 记录日志</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 等于 getPostData()</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">{</span> extended<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 等于 getPostData() 解析其它格式数据</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cookieParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//解析 Cookie</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token keyword">static</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'public'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 注册静态文件</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> indexRouter<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 注册路由</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/users'</span><span class="token punctuation">,</span> usersRouter<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 注册路由</span>

<span class="token comment" spellcheck="true">// catch 404 and forward to error handler 获取404</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token function">createError</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// error handler 处理报错</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// set locals, only providing error in development</span>
  res<span class="token punctuation">.</span>locals<span class="token punctuation">.</span>message <span class="token operator">=</span> err<span class="token punctuation">.</span>message<span class="token punctuation">;</span>
  res<span class="token punctuation">.</span>locals<span class="token punctuation">.</span>error <span class="token operator">=</span> req<span class="token punctuation">.</span>app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'env'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'dev'</span> <span class="token operator">?</span> err <span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// render the error page</span>
  res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>status <span class="token operator">||</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> app<span class="token punctuation">;</span>
</code></pre>
<h4 id="Express-如何处理路由"><a href="#Express-如何处理路由" class="headerlink" title="Express 如何处理路由"></a>Express 如何处理路由</h4><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// app.js</span>
<span class="token keyword">const</span> blogRouter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./routes/blog'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> userRouter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./routes/user'</span><span class="token punctuation">)</span>；

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/api/blog'</span><span class="token punctuation">,</span> blogRouter<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/api/user'</span><span class="token punctuation">,</span> userRouter<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ./routes/blog.js</span>
<span class="token keyword">var</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/list'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      error<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      data<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/detail'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      error<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      data<span class="token punctuation">:</span> <span class="token string">'ok!'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router<span class="token punctuation">;</span>
</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ./routes/user.js</span>
<span class="token keyword">var</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>username<span class="token punctuation">,</span> password <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      error<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
          username<span class="token punctuation">,</span>
          password
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router<span class="token punctuation">;</span>
</code></pre>
<h4 id="Express-中间件"><a href="#Express-中间件" class="headerlink" title="Express 中间件"></a>Express 中间件</h4><ul>
<li>有很多 app.use</li>
<li>代码中的 next 参数是什么？</li>
</ul>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// express-test/app.js</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 本次 http 请求实例</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'请求开始...'</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>method<span class="token punctuation">,</span> req<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 假设在处理 Cookie</span>
    req<span class="token punctuation">.</span>cookie <span class="token operator">=</span> <span class="token punctuation">{</span>
        userId<span class="token punctuation">:</span> <span class="token string">'asd123'</span>
    <span class="token punctuation">}</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 假设处理 postData</span>
    <span class="token comment" spellcheck="true">// 异步</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        req<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
            a<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
            b<span class="token punctuation">:</span> <span class="token number">200</span>
        <span class="token punctuation">}</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/api'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'处理 api 路由'</span><span class="token punctuation">)</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/api'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'get api 路由'</span><span class="token punctuation">)</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'post api 路由'</span><span class="token punctuation">)</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 模拟登录验证</span>
<span class="token keyword">function</span> <span class="token function">loginCheck</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'模拟登陆失败'</span><span class="token punctuation">)</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            error<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
            msg<span class="token punctuation">:</span> <span class="token string">'登陆失败'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// next()</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/api/get-cookie'</span><span class="token punctuation">,</span> loginCheck<span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'get /api/get-cookie'</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        error<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        data<span class="token punctuation">:</span> req<span class="token punctuation">.</span>cookie
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/get-post-data'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'post /api/get-poat-data'</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        error<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        data<span class="token punctuation">:</span> req<span class="token punctuation">.</span>body
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'处理 404'</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        error<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
        msg<span class="token punctuation">:</span> <span class="token string">'404'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'server is running on port 8000...'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<h4 id="总结-4"><a href="#总结-4" class="headerlink" title="总结"></a>总结</h4><ul>
<li>初始化代码中，各个插件的作用</li>
<li>Express 如何处理路由</li>
<li>Express 中间件</li>
</ul>
<h3 id="Express-开发博客项目"><a href="#Express-开发博客项目" class="headerlink" title="Express 开发博客项目"></a>Express 开发博客项目</h3><ul>
<li>初始化项目，之前的部分代码可以复用</li>
<li>开发路由，并实现登录</li>
<li>记录日志</li>
</ul>
<h4 id="初始化开发环境"><a href="#初始化开发环境" class="headerlink" title="初始化开发环境"></a>初始化开发环境</h4><ul>
<li>安装插件 mysql xss</li>
<li>controller reModel utils conf db 相关代码可以拷贝过来</li>
<li>初始化路由</li>
</ul>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ./routes/blog.js</span>
<span class="token keyword">var</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> 
    getList<span class="token punctuation">,</span> 
    getDetail<span class="token punctuation">,</span>
    newBlog<span class="token punctuation">,</span>
    updateBlog<span class="token punctuation">,</span>
    delBlog
<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../controller/blog'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> SuccessModel<span class="token punctuation">,</span> ErrorModel <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../model/resModel'</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/list'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> author <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>author <span class="token operator">||</span> <span class="token string">''</span>
    <span class="token keyword">const</span> keyword <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>keyword <span class="token operator">||</span> <span class="token string">''</span>
    <span class="token comment" spellcheck="true">// const listData = getList(author, keyword)</span>
    <span class="token comment" spellcheck="true">// return new SuccessModel(listData)</span>

    <span class="token comment" spellcheck="true">// if (req.query.isadmin) {</span>
    <span class="token comment" spellcheck="true">//     // 管理员界面</span>
    <span class="token comment" spellcheck="true">//     const loginCheckResult = loginCheck(req)</span>
    <span class="token comment" spellcheck="true">//     if (loginCheckResult) {</span>
    <span class="token comment" spellcheck="true">//         // 未登录</span>
    <span class="token comment" spellcheck="true">//         return loginCheckResult</span>
    <span class="token comment" spellcheck="true">//     }</span>
    <span class="token comment" spellcheck="true">//     // 强制查询自己的博客</span>
    <span class="token comment" spellcheck="true">//     author = req.session.username</span>
    <span class="token comment" spellcheck="true">// }</span>

    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">getList</span><span class="token punctuation">(</span>author<span class="token punctuation">,</span> keyword<span class="token punctuation">)</span>
    <span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>listData <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token class-name">SuccessModel</span><span class="token punctuation">(</span>listData<span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/detail'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      error<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      data<span class="token punctuation">:</span> <span class="token string">'ok!'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router<span class="token punctuation">;</span>
</code></pre>
<h4 id="登录-Express-处理-Session"><a href="#登录-Express-处理-Session" class="headerlink" title="登录 Express 处理 Session"></a>登录 Express 处理 Session</h4><ul>
<li>使用 express-session 和 connect-redis ，简单方便</li>
<li>req.session 保存登录信息，登录检验做成 express 中间件</li>
</ul>
<p>安装 session 插件： <code>npm i express-session</code></p>
<h4 id="登录-Session-连接-Redis"><a href="#登录-Session-连接-Redis" class="headerlink" title="登录 Session 连接 Redis"></a>登录 Session 连接 Redis</h4><p>安装 redis 插件： <code>npm i connect-redis</code></p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// app.js</span>
<span class="token keyword">const</span> RedisStore <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'connect-redis'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span>

<span class="token keyword">const</span> redisClient <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./db/redis'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> sessionStore <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisStore</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    client<span class="token punctuation">:</span> redisClient
<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">session</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    secret<span class="token punctuation">:</span><span class="token string">'QZlp#31_59!'</span><span class="token punctuation">,</span>
    cookie<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// path: '', //默认配置</span>
        <span class="token comment" spellcheck="true">// httpOnly: true, //默认配置</span>
        maxAge<span class="token punctuation">:</span> <span class="token number">24</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">1000</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    store<span class="token punctuation">:</span> sessionStore
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// redis.js</span>
<span class="token keyword">const</span> redis <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'redis'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> REDIS_CONF <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../conf/db'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 创建客户端</span>
<span class="token keyword">const</span> redisClient <span class="token operator">=</span> redis<span class="token punctuation">.</span><span class="token function">createClient</span><span class="token punctuation">(</span>REDIS_CONF<span class="token punctuation">.</span>port<span class="token punctuation">,</span> REDIS_CONF<span class="token punctuation">.</span>host<span class="token punctuation">)</span>
redisClient<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> err <span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> redisClient</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ./routes/blog.js</span>
<span class="token keyword">var</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> 
    getList<span class="token punctuation">,</span> 
    getDetail<span class="token punctuation">,</span>
    newBlog<span class="token punctuation">,</span>
    updateBlog<span class="token punctuation">,</span>
    delBlog
<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../controller/blog'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> SuccessModel<span class="token punctuation">,</span> ErrorModel <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../model/resModel'</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/list'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> author <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>author <span class="token operator">||</span> <span class="token string">''</span>
    <span class="token keyword">const</span> keyword <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>keyword <span class="token operator">||</span> <span class="token string">''</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>isadmin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//     // 管理员界面</span>
    <span class="token comment" spellcheck="true">//     const loginCheckResult = loginCheck(req)</span>
    <span class="token comment" spellcheck="true">//     if (loginCheckResult) {</span>
    <span class="token comment" spellcheck="true">//         // 未登录</span>
    <span class="token comment" spellcheck="true">//         return loginCheckResult</span>
    <span class="token comment" spellcheck="true">//     }</span>
    <span class="token comment" spellcheck="true">//     // 强制查询自己的博客</span>
        author <span class="token operator">=</span> req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>username
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">getList</span><span class="token punctuation">(</span>author<span class="token punctuation">,</span> keyword<span class="token punctuation">)</span>
    <span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>listData <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token class-name">SuccessModel</span><span class="token punctuation">(</span>listData<span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/detail'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      error<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      data<span class="token punctuation">:</span> <span class="token string">'ok!'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router<span class="token punctuation">;</span>
</code></pre>
<h4 id="登录中间件"><a href="#登录中间件" class="headerlink" title="登录中间件"></a>登录中间件</h4><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ./middleware/loginCheck.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> ErrorModel <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../model/resModel'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>username<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>
        <span class="token keyword">new</span> <span class="token class-name">ErrorModel</span><span class="token punctuation">(</span><span class="token string">'未登录'</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<h4 id="开发路由"><a href="#开发路由" class="headerlink" title="开发路由"></a>开发路由</h4><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ./routes/blog.js</span>
<span class="token keyword">var</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> 
    getList<span class="token punctuation">,</span> 
    getDetail<span class="token punctuation">,</span>
    newBlog<span class="token punctuation">,</span>
    updateBlog<span class="token punctuation">,</span>
    delBlog
<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../controller/blog'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> SuccessModel<span class="token punctuation">,</span> ErrorModel <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../model/resModel'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> loginCheck <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../middleware/loginCheck.js'</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/list'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> author <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>author <span class="token operator">||</span> <span class="token string">''</span>
    <span class="token keyword">const</span> keyword <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>keyword <span class="token operator">||</span> <span class="token string">''</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>isadmin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 管理员界面</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>username <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 未登录</span>
            res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token class-name">ErrorModel</span><span class="token punctuation">(</span><span class="token string">'未登录'</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 强制查询自己的博客</span>
        author <span class="token operator">=</span> req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>username
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">getList</span><span class="token punctuation">(</span>author<span class="token punctuation">,</span> keyword<span class="token punctuation">)</span>
    <span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>listData <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token class-name">SuccessModel</span><span class="token punctuation">(</span>listData<span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/detail'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">getDetail</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
    <span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>detailData <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token class-name">SuccessModel</span><span class="token punctuation">(</span>detailData<span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/new'</span><span class="token punctuation">,</span> loginCheck<span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>author <span class="token operator">=</span> req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>username
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">newBlog</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">)</span>
    <span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>data <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token class-name">SuccessModel</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/update'</span><span class="token punctuation">,</span> loginCheck<span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">updateBlog</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>id<span class="token punctuation">,</span> req<span class="token punctuation">.</span>body<span class="token punctuation">)</span>
    <span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>value <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token class-name">SuccessModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">}</span> 
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token class-name">ErrorModel</span><span class="token punctuation">(</span><span class="token string">'更新博客失败!'</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span> 
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/del'</span><span class="token punctuation">,</span> loginCheck<span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> author <span class="token operator">=</span> req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>username
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">delBlog</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>id<span class="token punctuation">,</span> author<span class="token punctuation">)</span>
    <span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>value <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token class-name">SuccessModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span> 
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token class-name">ErrorModel</span><span class="token punctuation">(</span><span class="token string">'删除失败！'</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span> 
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router<span class="token punctuation">;</span>
</code></pre>
<h4 id="使用-Morgan-写日志"><a href="#使用-Morgan-写日志" class="headerlink" title="使用 Morgan 写日志"></a>使用 Morgan 写日志</h4><ul>
<li>access log 记录，直接使用脚手架推荐的 Morgan</li>
<li>自定义日志使用 console.log 和 console.error 即可</li>
<li>日志拆分、日志内容分析，之前讲过，不再赘述</li>
</ul>
<p>项目地址： <a href="https://github.com/expressjs/morgan" target="_blank" rel="noopener">https://github.com/expressjs/morgan</a> </p>
<p>搜索：Predefined Formats</p>
<p>访问日志 代码演示：</p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">//  app.js</span>
<span class="token keyword">var</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 路径</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> ENV <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV
<span class="token keyword">if</span> <span class="token punctuation">(</span>ENV <span class="token operator">!=</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 开发环境</span>
    app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">logger</span><span class="token punctuation">(</span><span class="token string">'dev'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> logFileName <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'logs'</span><span class="token punctuation">,</span> <span class="token string">'access.log'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> writeStream <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span>logFileName<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        flags<span class="token punctuation">:</span> <span class="token string">'a'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">logger</span><span class="token punctuation">(</span><span class="token string">'combined'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        stream<span class="token punctuation">:</span> writeStream
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">// app.use(logger('dev',{</span>
<span class="token comment" spellcheck="true">//     stream: process.stdout</span>
<span class="token comment" spellcheck="true">// })); // 记录日志</span></code></pre>
<h4 id="总结-5"><a href="#总结-5" class="headerlink" title="总结"></a>总结</h4><ul>
<li>写法上的改变，如 req.query, res.json</li>
<li>使用 express-session， connect-redis，登录中间件</li>
<li>使用 Morgan</li>
</ul>
<h3 id="中间件原理介绍"><a href="#中间件原理介绍" class="headerlink" title="中间件原理介绍"></a>中间件原理介绍</h3><ul>
<li>回顾中间件使用</li>
<li>分析如何实现<ul>
<li>app.use 用来注册中间件，先收集起来</li>
<li>遇到 http 请求，根据 path 和 method 判断触发哪些</li>
<li>实现 next 机制，即上一个通过 next 触发下一个</li>
</ul>
</li>
<li>代码演示</li>
</ul>
<h3 id="中间件代码实现"><a href="#中间件代码实现" class="headerlink" title="中间件代码实现"></a>中间件代码实现</h3><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ./lib/express/like-express.js</span>
<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> slice <span class="token operator">=</span> Array<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>slice

<span class="token keyword">class</span> <span class="token class-name">LikeExpress</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 存放中间件列表</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>routes <span class="token operator">=</span> <span class="token punctuation">{</span>
            all<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// app.use(...)</span>
            <span class="token keyword">get</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// app.get(...)</span>
            post<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token comment" spellcheck="true">// app.post(...)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">register</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> info <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> path <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            info<span class="token punctuation">.</span>path <span class="token operator">=</span> path
            <span class="token comment" spellcheck="true">// 从第二个参数开始，转为数组，存入 stack</span>
            info<span class="token punctuation">.</span>stack <span class="token operator">=</span> slice<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            info<span class="token punctuation">.</span>path <span class="token operator">=</span> <span class="token string">'/'</span>
            <span class="token comment" spellcheck="true">// 从第一个参数开始，转换为数组，存入 stack</span>
            info<span class="token punctuation">.</span>stack <span class="token operator">=</span> slice<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> info
    <span class="token punctuation">}</span>

    <span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> info <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>register<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span>arguments<span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>routes<span class="token punctuation">.</span>all<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> info <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>register<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span>arguments<span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>routes<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">post</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> info <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>register<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span>arguments<span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>routes<span class="token punctuation">.</span>post<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">match</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> stack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>url <span class="token operator">===</span> <span class="token string">'/favicon.ico'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> stack
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// 获取 routes</span>
        <span class="token keyword">let</span> curRoutes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        curRoutes <span class="token operator">=</span> curRoutes<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>routes<span class="token punctuation">.</span>all<span class="token punctuation">)</span>
        curRoutes <span class="token operator">=</span> curRoutes<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>routes<span class="token punctuation">[</span>method<span class="token punctuation">]</span><span class="token punctuation">)</span>

        curRoutes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>routeInfo <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>routeInfo<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// url === '/api/get-cookie' 且 routeInfo.path === '/'</span>
                <span class="token comment" spellcheck="true">// url === '/api/get-cookie' 且 routeInfo.path === '/api'</span>
                <span class="token comment" spellcheck="true">// url === '/api/get-cookie' 且 routeInfo.path === '/api/get-cookie'</span>
                stack <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>routeInfo<span class="token punctuation">.</span>stack<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> stack
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 核心的 next 机制</span>
    <span class="token function">handle</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> stack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> next <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 拿到第一个匹配的中间件</span>
            <span class="token keyword">const</span> middleware <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>middleware<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 执行中间件函数</span>
                <span class="token function">middleware</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
            res<span class="token punctuation">.</span>json <span class="token operator">=</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
                res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-type'</span><span class="token punctuation">,</span> <span class="token string">'application/json'</span><span class="token punctuation">)</span>
                res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>
                    JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">const</span> url <span class="token operator">=</span> req<span class="token punctuation">.</span>url
            <span class="token keyword">const</span> method <span class="token operator">=</span> req<span class="token punctuation">.</span>method<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token keyword">const</span> resultList <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> url<span class="token punctuation">)</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> resultList<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">listen</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 工厂函数</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">LikeExpress</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 测试代码 ./lib/express/test.js</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./like-express.js'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 本次 http 请求的实例</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'请求开始...'</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>method<span class="token punctuation">,</span> req<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span>next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 假设在处理 cookie</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'处理coookie...'</span><span class="token punctuation">)</span>
    req<span class="token punctuation">.</span>cookie <span class="token operator">=</span> <span class="token punctuation">{</span>
        uerId<span class="token punctuation">:</span> <span class="token string">'abc123'</span>
    <span class="token punctuation">}</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/api'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'处理 /api 路由'</span><span class="token punctuation">)</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/api'</span><span class="token punctuation">,</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'get /api 路由'</span><span class="token punctuation">)</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 模拟登录验证</span>
<span class="token keyword">function</span> <span class="token function">loginCheck</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'模拟登录成功'</span><span class="token punctuation">)</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/api/get-cookie'</span><span class="token punctuation">,</span> loginCheck<span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'get /api/get-cookie'</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        errno<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        data<span class="token punctuation">:</span> req<span class="token punctuation">.</span>cookie
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">800</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'server is running on port 800'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<h3 id="总结-6"><a href="#总结-6" class="headerlink" title="总结"></a>总结</h3><ul>
<li>使用框架开发的好处（相比之前不使用框架）</li>
<li>express 的使用和路由处理，以及操作 session redis 日志等</li>
<li>express 中间件的使用和原理</li>
</ul>
<h4 id="下一步"><a href="#下一步" class="headerlink" title="下一步"></a>下一步</h4><ul>
<li>JS 的异步回调带来了很多问题，Promise 也不能解决所有</li>
<li>Node.js 已经支持 async/await 语法，要用起来</li>
<li>Ko2 也已经原生支持 async/await 语法，接下来讲解</li>
</ul>
<h2 id="Koa2-框架"><a href="#Koa2-框架" class="headerlink" title="Koa2 框架"></a>Koa2 框架</h2><ul>
<li>Express 中间件是异步回调，Koa2 原生支持 async/await</li>
<li>新开发的框架和系统，都是开始基于 Koa2，例如 egg.js</li>
<li>Express 虽然未过时，但是 Koa2 肯定是未来的趋势</li>
</ul>
<p>目录</p>
<ul>
<li>async/await 语法介绍，安装和使用 Koa2</li>
<li>开发接口，连接数据库，实现登录，记录日志</li>
<li>分析 Koa2 中间件原理</li>
</ul>
<h3 id="async-await-语法介绍"><a href="#async-await-语法介绍" class="headerlink" title="async await 语法介绍"></a>async await 语法介绍</h3><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// async await 获取内容</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">readFileData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 同步写法</span>
    <span class="token keyword">try</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> aData <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getFileContent</span><span class="token punctuation">(</span><span class="token string">'a.json'</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'aData:'</span><span class="token punctuation">,</span> aData<span class="token punctuation">)</span>
    <span class="token keyword">const</span> bData <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getFileContent</span><span class="token punctuation">(</span>aData<span class="token punctuation">.</span>next<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'bData:'</span><span class="token punctuation">,</span> bData<span class="token punctuation">)</span>
    <span class="token keyword">const</span> cData <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getFileContent</span><span class="token punctuation">(</span>bData<span class="token punctuation">.</span>next<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'cData:'</span><span class="token punctuation">,</span> cData<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">readFileData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">readAData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> aData <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getFileContent</span><span class="token punctuation">(</span><span class="token string">'a.json'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> aData
<span class="token punctuation">}</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> aData <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">readAData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'aData:'</span><span class="token punctuation">,</span> aData<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 要点 async await</span>
<span class="token comment" spellcheck="true">// 1. await 后面可以追加 promise 对象，获取 resolve 的值</span>
<span class="token comment" spellcheck="true">// 2. await 必须包裹在 async 函数内</span>
<span class="token comment" spellcheck="true">// 3. async 函数执行返回的也是一个 promise 对象</span>
<span class="token comment" spellcheck="true">// 4. try-catch 截获 promise 中 reject 的值</span>
</code></pre>
<h3 id="介绍-Koa2"><a href="#介绍-Koa2" class="headerlink" title="介绍 Koa2"></a>介绍 Koa2</h3><h4 id="安装-Koa2"><a href="#安装-Koa2" class="headerlink" title="安装 Koa2"></a>安装 Koa2</h4><ul>
<li><code>npm install koa-generator -g</code></li>
<li><code>Koa2 koa2-test(初始化目录名)</code></li>
<li><code>npm install &amp; npm run dev</code></li>
</ul>
<h4 id="介绍-app-js"><a href="#介绍-app-js" class="headerlink" title="介绍 app.js"></a>介绍 app.js</h4><ul>
<li>介绍各个插件的作用</li>
<li>思考各个插件的实现原理（结合之前学过的知识）</li>
<li>处理 get 请求和 post 请求</li>
</ul>
<p>代码演示</p>
<h4 id="介绍路由"><a href="#介绍路由" class="headerlink" title="介绍路由"></a>介绍路由</h4><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ./blog-koa2/routes/blog.js</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-router'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">prefix</span><span class="token punctuation">(</span><span class="token string">'/api/blog'</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/list'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> qurey <span class="token operator">=</span> ctx<span class="token punctuation">.</span>qurey
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
        errno<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        qurey<span class="token punctuation">,</span>
        data<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'这是博客列表'</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/bar'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'this is a users/bar response'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router
</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ./blog-koa2/routes/users.js</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-router'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">prefix</span><span class="token punctuation">(</span><span class="token string">'/api/users'</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>username<span class="token punctuation">,</span> password<span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
        errno<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        username<span class="token punctuation">,</span>
        password
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/bar'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'this is a users/bar response'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router
</code></pre>
<h4 id="介绍中间件机制"><a href="#介绍中间件机制" class="headerlink" title="介绍中间件机制"></a>介绍中间件机制</h4><ul>
<li>app.use 和 express 一样</li>
<li>next 返回 promise ，其它和 express 一样</li>
</ul>
<h3 id="开发接口-1"><a href="#开发接口-1" class="headerlink" title="开发接口"></a>开发接口</h3><h4 id="实现-Session"><a href="#实现-Session" class="headerlink" title="实现 Session"></a>实现 Session</h4><ul>
<li>和 express 类似</li>
<li>基于 koa-generic-session 和 koa-redis<ul>
<li><code>npm i koa-generic-session koa-redis redis --save</code></li>
</ul>
</li>
</ul>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ./blog-koa2/app.js </span>
<span class="token comment" spellcheck="true">// session 配置</span>
<span class="token comment" spellcheck="true">// 密匙</span>
app<span class="token punctuation">.</span>keys <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'Il34*fs24'</span><span class="token punctuation">]</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">session</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 配置 cookie</span>
    cookie<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        path<span class="token punctuation">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span>
        httpOnly<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        maxAge<span class="token punctuation">:</span> <span class="token number">24</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">1000</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment" spellcheck="true">// 配置 redis</span>
    store<span class="token punctuation">:</span> <span class="token function">redisStore</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        all<span class="token punctuation">:</span> <span class="token string">'127.0.0.1：6379'</span> <span class="token comment" spellcheck="true">// 暂时写死</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ./blog-koa2/routes/users.js </span>
<span class="token comment" spellcheck="true">// 测试 session </span>
router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/session-test'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>session<span class="token punctuation">.</span>viewCount <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span>session<span class="token punctuation">.</span>viewCount <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token punctuation">}</span>
    ctx<span class="token punctuation">.</span>session<span class="token punctuation">.</span>viewCount<span class="token operator">++</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
        errno<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        viewCount<span class="token punctuation">:</span> ctx<span class="token punctuation">.</span>session<span class="token punctuation">.</span>viewCount
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<h4 id="开发路由-1"><a href="#开发路由-1" class="headerlink" title="开发路由"></a>开发路由</h4><ul>
<li>复用之前代码， 如 mysql、 登录中间件 、controller、model 等</li>
<li>初始化路由，并开发接口</li>
<li>联调测试</li>
</ul>
<h5 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h5><ul>
<li><code>npm i mysql</code></li>
<li><code>npm i xss</code></li>
</ul>
<h5 id="代码演示-2"><a href="#代码演示-2" class="headerlink" title="代码演示"></a>代码演示</h5><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ./blog-koa2/app.js</span>
<span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> views <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-views'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> json <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-json'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> onerror <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-onerror'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> bodyparser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-bodyparser'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> logger <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-logger'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> session <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-generic-session'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> redisStore <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-redis'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> REDIS_CONF <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./conf/db.js'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> index <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./routes/index'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./routes/user.js'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> blog <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./routes/blog.js'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// error handler</span>
<span class="token function">onerror</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// middlewares</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">bodyparser</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  enableTypes<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">'json'</span><span class="token punctuation">,</span> <span class="token string">'form'</span><span class="token punctuation">,</span> <span class="token string">'text'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">logger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-static'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>__dirname <span class="token operator">+</span> <span class="token string">'/public'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">views</span><span class="token punctuation">(</span>__dirname <span class="token operator">+</span> <span class="token string">'/views'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  extension<span class="token punctuation">:</span> <span class="token string">'pug'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// logger</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> start <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> ms <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>method<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> - </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ms<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">ms`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// session 配置</span>
app<span class="token punctuation">.</span>keys <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'Il34*fs24'</span><span class="token punctuation">]</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">session</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 配置 cookie</span>
    cookie<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        path<span class="token punctuation">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span>
        httpOnly<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        maxAge<span class="token punctuation">:</span> <span class="token number">24</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">1000</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment" spellcheck="true">// 配置 redis</span>
    store<span class="token punctuation">:</span> <span class="token function">redisStore</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// all: '127.0.0.1：6379' // 暂时写死</span>
        all<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>REDIS_CONF<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>REDIS_CONF<span class="token punctuation">.</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// routes</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>index<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> index<span class="token punctuation">.</span><span class="token function">allowedMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">allowedMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>blog<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> blog<span class="token punctuation">.</span><span class="token function">allowedMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// error-handling</span>
app<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> ctx<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'server error'</span><span class="token punctuation">,</span> err<span class="token punctuation">,</span> ctx<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> app
</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-router'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> 
    getList<span class="token punctuation">,</span> 
    getDetail<span class="token punctuation">,</span>
    newBlog<span class="token punctuation">,</span>
    updateBlog<span class="token punctuation">,</span>
    delBlog
<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../controller/blog'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> SuccessModel<span class="token punctuation">,</span> ErrorModel <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../model/resModel'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> loginCheck <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../middleware/loginCheck.js'</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">prefix</span><span class="token punctuation">(</span><span class="token string">'/api/blog'</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/list'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> author <span class="token operator">=</span> ctx<span class="token punctuation">.</span>query<span class="token punctuation">.</span>author <span class="token operator">||</span> <span class="token string">''</span>
    <span class="token keyword">const</span> keyword <span class="token operator">=</span> ctx<span class="token punctuation">.</span>query<span class="token punctuation">.</span>keyword <span class="token operator">||</span> <span class="token string">''</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>query<span class="token punctuation">.</span>isadmin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 管理员界面</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'is admin'</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>session<span class="token punctuation">.</span>username <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 未登录</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'is admin but not login'</span><span class="token punctuation">)</span>
            ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ErrorModel</span><span class="token punctuation">(</span><span class="token string">'未登录'</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 强制查询自己的博客</span>
        author <span class="token operator">=</span> ctx<span class="token punctuation">.</span>session<span class="token punctuation">.</span>username
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> listData <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getList</span><span class="token punctuation">(</span>author<span class="token punctuation">,</span> keyword<span class="token punctuation">)</span> 
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SuccessModel</span><span class="token punctuation">(</span>listData<span class="token punctuation">)</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/detail'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> detailData <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getDetail</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>query<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SuccessModel</span><span class="token punctuation">(</span>detailData<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/new'</span><span class="token punctuation">,</span> loginCheck<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> body <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body
    body<span class="token punctuation">.</span>author <span class="token operator">=</span> ctx<span class="token punctuation">.</span>session<span class="token punctuation">.</span>username
    <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">newBlog</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SuccessModel</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/update'</span><span class="token punctuation">,</span> loginCheck<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">updateBlog</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>query<span class="token punctuation">.</span>id<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SuccessModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ErrorModel</span><span class="token punctuation">(</span><span class="token string">'更新博客失败!'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/del'</span><span class="token punctuation">,</span> loginCheck<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> author <span class="token operator">=</span> ctx<span class="token punctuation">.</span>session<span class="token punctuation">.</span>username
    <span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">delBlog</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>query<span class="token punctuation">.</span>id<span class="token punctuation">,</span> author<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SuccessModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ErrorModel</span><span class="token punctuation">(</span><span class="token string">'删除失败！'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router
</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ./blog-koa2/routes/users.js</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-router'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> login <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../controller/user.js'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> SuccessModel<span class="token punctuation">,</span> ErrorModel <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../model/resModel'</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">prefix</span><span class="token punctuation">(</span><span class="token string">'/api/user'</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>username<span class="token punctuation">,</span> password<span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body
    <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">login</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>username<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// // 操作 cookie</span>
    <span class="token comment" spellcheck="true">// res.setHeader('Set-Cookie', `username=${data.username}; path=/; httpOnly; expires=${getCookieExpires()}`)</span>
        ctx<span class="token punctuation">.</span>session<span class="token punctuation">.</span>username <span class="token operator">=</span> data<span class="token punctuation">.</span>username
        ctx<span class="token punctuation">.</span>session<span class="token punctuation">.</span>realname <span class="token operator">=</span> data<span class="token punctuation">.</span>realname
        ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SuccessModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ErrorModel</span><span class="token punctuation">(</span><span class="token string">'登录失败!'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// router.get('/session-test', async function (ctx, next) {</span>
<span class="token comment" spellcheck="true">//     if (ctx.session.viewCount == null) {</span>
<span class="token comment" spellcheck="true">//         ctx.session.viewCount = 0</span>
<span class="token comment" spellcheck="true">//     }</span>
<span class="token comment" spellcheck="true">//     ctx.session.viewCount++</span>
<span class="token comment" spellcheck="true">//     ctx.body = {</span>
<span class="token comment" spellcheck="true">//         errno: 0,</span>
<span class="token comment" spellcheck="true">//         viewCount: ctx.session.viewCount</span>
<span class="token comment" spellcheck="true">//     }</span>
<span class="token comment" spellcheck="true">// })</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router
</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ./blog-koa2/controller/users.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> exec<span class="token punctuation">,</span> escape <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../db/mysql.js'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> genPassword <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../utils/cryp.js'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> xss <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'xss'</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">// 登录验证</span>
<span class="token keyword">const</span> login <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    username <span class="token operator">=</span> <span class="token function">escape</span><span class="token punctuation">(</span><span class="token function">xss</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">)</span>

    password <span class="token operator">=</span> <span class="token function">genPassword</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span>
    password <span class="token operator">=</span> <span class="token function">escape</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span>

    <span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token string">`
        select username, realname from users where username=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>username<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> and password=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>password<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
    `</span></span>
    <span class="token keyword">const</span> rows <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">exec</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span>
    <span class="token keyword">return</span> rows<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    login
<span class="token punctuation">}</span></code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">//../blog-koa2/controller/blog.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> exec<span class="token punctuation">,</span> escape <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../db/mysql'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> xss <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'xss'</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">//../blog-koa2/controller/blog.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> exec<span class="token punctuation">,</span> escape <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../db/mysql'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> xss <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'xss'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">//博客列表</span>
<span class="token keyword">const</span> getList <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>author<span class="token punctuation">,</span> keyword<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token string">`select * from blogs where 1=1 `</span></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>author<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        author <span class="token operator">=</span> <span class="token function">escape</span><span class="token punctuation">(</span>author<span class="token punctuation">)</span>
        sql <span class="token operator">+</span><span class="token operator">=</span> <span class="token template-string"><span class="token string">`and author=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>author<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> `</span></span>
    <span class="token punctuation">}</span> 
    <span class="token keyword">if</span> <span class="token punctuation">(</span>keyword<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        keyword <span class="token operator">=</span> <span class="token function">escape</span><span class="token punctuation">(</span><span class="token string">'%'</span> <span class="token operator">+</span> <span class="token function">xss</span><span class="token punctuation">(</span>keyword<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'%'</span><span class="token punctuation">)</span>
        sql <span class="token operator">+</span><span class="token operator">=</span> <span class="token template-string"><span class="token string">`and title like </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>keyword<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> `</span></span>
    <span class="token punctuation">}</span>
    sql <span class="token operator">+</span><span class="token operator">=</span> <span class="token template-string"><span class="token string">`order by createtime desc;`</span></span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">exec</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//博客详情</span>
<span class="token keyword">const</span> getDetail <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span> id <span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token string">`select * from blogs where id=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>
    <span class="token keyword">const</span> rows <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">exec</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span>
    <span class="token keyword">return</span> rows<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//新建博客</span>
<span class="token keyword">const</span> newBlog <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>blogData <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// blogData 是一个博客对象，包含 title conten 属性</span>
    <span class="token keyword">const</span> title <span class="token operator">=</span> <span class="token function">escape</span><span class="token punctuation">(</span><span class="token function">xss</span><span class="token punctuation">(</span>blogData<span class="token punctuation">.</span>title<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token function">escape</span><span class="token punctuation">(</span><span class="token function">xss</span><span class="token punctuation">(</span>blogData<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> author <span class="token operator">=</span> <span class="token function">escape</span><span class="token punctuation">(</span>blogData<span class="token punctuation">.</span>author<span class="token punctuation">)</span>
    <span class="token keyword">const</span> createtime <span class="token operator">=</span> <span class="token function">escape</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token string">`
    insert into blogs (title, content, createtime, author)
    values(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>title<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>content<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>createtime<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>author<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)
    `</span></span>
    <span class="token keyword">const</span> insertData <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">exec</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        id<span class="token punctuation">:</span> insertData<span class="token punctuation">.</span>insertId
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//更新博客</span>
<span class="token keyword">const</span> updateBlog <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>id<span class="token punctuation">,</span> blogData <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// id 就是要更新的 id</span>
    <span class="token comment" spellcheck="true">// blogData 是一个博客对象，包含 title content 属性</span>
    <span class="token keyword">const</span> title <span class="token operator">=</span> <span class="token function">escape</span><span class="token punctuation">(</span><span class="token function">xss</span><span class="token punctuation">(</span>blogData<span class="token punctuation">.</span>title<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token function">escape</span><span class="token punctuation">(</span><span class="token function">xss</span><span class="token punctuation">(</span>blogData<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token string">`
        update blogs set title=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>title<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, content=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>content<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> where id=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
    `</span></span>
    <span class="token keyword">const</span> updateData <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">exec</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>updateData<span class="token punctuation">.</span>affectedRows <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//删除博客</span>
<span class="token keyword">const</span> delBlog <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>id<span class="token punctuation">,</span> author<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    author <span class="token operator">=</span> <span class="token function">escape</span><span class="token punctuation">(</span>author<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// id 就是要删除的博客的 id </span>
    <span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token string">`delete from blogs where id=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> and author=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>author<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>
    <span class="token comment" spellcheck="true">// console.log(sql)</span>
    <span class="token keyword">const</span> delData <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">exec</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>delData<span class="token punctuation">.</span>affectedRows <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    getList<span class="token punctuation">,</span>
    getDetail<span class="token punctuation">,</span>
    newBlog<span class="token punctuation">,</span>
    updateBlog<span class="token punctuation">,</span>
    delBlog
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//博客列表</span>
<span class="token keyword">const</span> getList <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>author<span class="token punctuation">,</span> keyword<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token string">`select * from blogs where 1=1 `</span></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>author<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        author <span class="token operator">=</span> <span class="token function">escape</span><span class="token punctuation">(</span>author<span class="token punctuation">)</span>
        sql <span class="token operator">+</span><span class="token operator">=</span> <span class="token template-string"><span class="token string">`and author=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>author<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> `</span></span>
    <span class="token punctuation">}</span> 
    <span class="token keyword">if</span> <span class="token punctuation">(</span>keyword<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        keyword <span class="token operator">=</span> <span class="token function">escape</span><span class="token punctuation">(</span><span class="token string">'%'</span> <span class="token operator">+</span> <span class="token function">xss</span><span class="token punctuation">(</span>keyword<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'%'</span><span class="token punctuation">)</span>
        sql <span class="token operator">+</span><span class="token operator">=</span> <span class="token template-string"><span class="token string">`and title like </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>keyword<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> `</span></span>
    <span class="token punctuation">}</span>
    sql <span class="token operator">+</span><span class="token operator">=</span> <span class="token template-string"><span class="token string">`order by createtime desc;`</span></span>

    <span class="token comment" spellcheck="true">// console.log(sql)</span>
    <span class="token comment" spellcheck="true">//返回 promise</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">exec</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//博客详情</span>
<span class="token keyword">const</span> getDetail <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span> id <span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token string">`select * from blogs where id=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>
    <span class="token keyword">const</span> rows <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">exec</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span>
    <span class="token keyword">return</span> rows<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//新建博客</span>
<span class="token keyword">const</span> newBlog <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>blogData <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// blogData 是一个博客对象，包含 title conten 属性</span>
    <span class="token keyword">const</span> title <span class="token operator">=</span> <span class="token function">escape</span><span class="token punctuation">(</span><span class="token function">xss</span><span class="token punctuation">(</span>blogData<span class="token punctuation">.</span>title<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token function">escape</span><span class="token punctuation">(</span><span class="token function">xss</span><span class="token punctuation">(</span>blogData<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> author <span class="token operator">=</span> <span class="token function">escape</span><span class="token punctuation">(</span>blogData<span class="token punctuation">.</span>author<span class="token punctuation">)</span>
    <span class="token keyword">const</span> createtime <span class="token operator">=</span> <span class="token function">escape</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token string">`
    insert into blogs (title, content, createtime, author)
    values(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>title<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>content<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>createtime<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>author<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)
    `</span></span>
    <span class="token keyword">const</span> insertData <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">exec</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        id<span class="token punctuation">:</span> insertData<span class="token punctuation">.</span>insertId
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//更新博客</span>
<span class="token keyword">const</span> updateBlog <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>id<span class="token punctuation">,</span> blogData <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// id 就是要更新的 id</span>
    <span class="token comment" spellcheck="true">// blogData 是一个博客对象，包含 title content 属性</span>
    <span class="token keyword">const</span> title <span class="token operator">=</span> <span class="token function">escape</span><span class="token punctuation">(</span><span class="token function">xss</span><span class="token punctuation">(</span>blogData<span class="token punctuation">.</span>title<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token function">escape</span><span class="token punctuation">(</span><span class="token function">xss</span><span class="token punctuation">(</span>blogData<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token string">`
        update blogs set title=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>title<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, content=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>content<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> where id=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
    `</span></span>
    <span class="token keyword">const</span> updateData <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">exec</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>updateData<span class="token punctuation">.</span>affectedRows <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//删除博客</span>
<span class="token keyword">const</span> delBlog <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>id<span class="token punctuation">,</span> author<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    author <span class="token operator">=</span> <span class="token function">escape</span><span class="token punctuation">(</span>author<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// id 就是要删除的博客的 id </span>
    <span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token template-string"><span class="token string">`delete from blogs where id=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> and author=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>author<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>
    <span class="token comment" spellcheck="true">// console.log(sql)</span>
    <span class="token keyword">const</span> delData <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">exec</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>delData<span class="token punctuation">.</span>affectedRows <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    getList<span class="token punctuation">,</span>
    getDetail<span class="token punctuation">,</span>
    newBlog<span class="token punctuation">,</span>
    updateBlog<span class="token punctuation">,</span>
    delBlog
<span class="token punctuation">}</span></code></pre>
<h4 id="联调"><a href="#联调" class="headerlink" title="联调"></a>联调</h4><h4 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h4><ul>
<li>access log 记录，使用 morgan</li>
<li>自定义日志使用 console.log 和 console.error</li>
<li>日志文件拆分、日志内存分析，之前讲过，不再赘述</li>
</ul>
<p>代码演示：</p>
<ul>
<li><code>npm i koa-morgan</code></li>
</ul>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// app.js</span>
<span class="token comment" spellcheck="true">// 记录日志</span>
<span class="token keyword">const</span> ENV <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV
<span class="token keyword">if</span> <span class="token punctuation">(</span>ENV <span class="token operator">!=</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 开发环境</span>
    app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">morgan</span><span class="token punctuation">(</span><span class="token string">'dev'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 线上环境</span>
    <span class="token keyword">const</span> logFileName <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'logs'</span><span class="token punctuation">,</span> <span class="token string">'access.log'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> writeStream <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span>logFileName<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        flags<span class="token punctuation">:</span> <span class="token string">'a'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">morgan</span><span class="token punctuation">(</span><span class="token string">'combined'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        stream<span class="token punctuation">:</span> writeStream
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="中间件原理分析"><a href="#中间件原理分析" class="headerlink" title="中间件原理分析"></a>中间件原理分析</h3><ul>
<li>回顾中间件使用</li>
<li>分析如何实现<ul>
<li>app.use 用来注册中间件，先收集起来</li>
<li>实现 next 机制，即上一个通过 next 触发下一个</li>
<li>不涉及 method 和 path 的判断</li>
</ul>
</li>
<li>代码演示</li>
</ul>
<p>洋葱模型：</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// logger</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'第一层洋葱-开始'</span><span class="token punctuation">)</span>
  <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> rt <span class="token operator">=</span> ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'X-Response-Time'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>method<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> - </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>rt<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'第一层洋葱-结束'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// x-response-time</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'第二层洋葱-开始'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> start <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> ms <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token string">'X-Response-Time'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ms<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">ms`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'第二层洋葱-结束'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// response</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> ctx <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'第三层洋葱-开始'</span><span class="token punctuation">)</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'Hello World'</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'第三层洋葱-结束'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h4 id="中间件代码演示"><a href="#中间件代码演示" class="headerlink" title="中间件代码演示"></a>中间件代码演示</h4><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ./lib/koa2/like-koa2.js</span>
<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 组合中间件</span>
<span class="token keyword">function</span> <span class="token function">compose</span><span class="token punctuation">(</span>middlewareList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">function</span> <span class="token function">dispatch</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> fn <span class="token operator">=</span> middlewareList<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>
                    <span class="token function">fn</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> dispatch<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// promise</span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">LikeKoa2</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>middlewareList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>

    <span class="token function">use</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>middlewareList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span>
    <span class="token punctuation">}</span>

    <span class="token function">createContext</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> ctx <span class="token operator">=</span> <span class="token punctuation">{</span>
            req<span class="token punctuation">,</span>
            res
        <span class="token punctuation">}</span>
        ctx<span class="token punctuation">.</span>query <span class="token operator">=</span> req<span class="token punctuation">.</span>query
        <span class="token keyword">return</span> ctx
    <span class="token punctuation">}</span>

    <span class="token function">handleRequest</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> fn <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>middlewareList<span class="token punctuation">)</span> 
        <span class="token keyword">return</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> ctx <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createContext</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleRequest</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> fn<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">listen</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> LikeKoa2</code></pre>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ./lib/koa2/test.js</span>
<span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./like-koa2.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// logger</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'第一层洋葱-开始'</span><span class="token punctuation">)</span>
  <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> rt <span class="token operator">=</span> ctx<span class="token punctuation">[</span><span class="token string">'X-Response-Time'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>req<span class="token punctuation">.</span>method<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>req<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> - </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>rt<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'第一层洋葱-结束'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// x-response-time</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'第二层洋葱-开始'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> start <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> ms <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">;</span>
  ctx<span class="token punctuation">[</span><span class="token string">'X-Response-Time'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ms<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">ms`</span></span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'第二层洋葱-结束'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// response</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> ctx <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'第三层洋葱-开始'</span><span class="token punctuation">)</span>
  ctx<span class="token punctuation">.</span>res<span class="token punctuation">.</span>end <span class="token punctuation">(</span><span class="token string">'Hello World'</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'第三层洋葱-结束'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h4 id="总结-7"><a href="#总结-7" class="headerlink" title="总结"></a>总结</h4><ul>
<li>使用 async/await 的好处</li>
<li>koa2 的使用，以及如何操作 session redis 日志</li>
<li>koa2 中间件的使用和原理</li>
</ul>
<p>下一步：</p>
<ul>
<li>一直处于开发环境，和前端联调过，但从未上线</li>
<li>如何实现线上服务稳定性？PM2 是什么？</li>
<li>nginx 在线上环境扮演了什么重要作用？</li>
</ul>
<h2 id="线上环境"><a href="#线上环境" class="headerlink" title="线上环境"></a>线上环境</h2><ul>
<li>服务器稳定性</li>
<li>充分利用服务器硬件资源，以便提高性能</li>
<li>线上日志记录</li>
</ul>
<p>PM2 功能：</p>
<ul>
<li>进程守护，系统崩溃自动重启</li>
<li>启动多进程，充分利用 CPU 和内存</li>
<li>自带日志记录功能</li>
</ul>
<h4 id="下载安装"><a href="#下载安装" class="headerlink" title="下载安装"></a>下载安装</h4><ul>
<li><code>npm install pm2 -g</code></li>
<li><code>pm2 --version</code></li>
</ul>
<h4 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h4><ul>
<li><p><code>pm2 start &lt;配置或者文件&gt;</code> 启动 pm2</p>
</li>
<li><p><code>pm2 list</code> 查看所有 pm2 进程</p>
</li>
<li><p><code>pm2 restart &lt;Appname&gt;/&lt;id&gt;</code></p>
</li>
<li><p><code>pm2 stop &lt;AppName&gt;/&lt;id&gt;</code></p>
</li>
<li><p><code>pm2 delete &lt;AppName&gt;/&lt;id&gt;</code></p>
</li>
<li><p><code>pm2 info &lt;AppName&gt;/&lt;id&gt;</code> 查看进程详细信息</p>
</li>
<li><p><code>pm2 log &lt;AppName&gt;/&lt;id&gt;</code> 查看进程日志</p>
</li>
<li><p><code>pm2 monit &lt;AppName&gt;/&lt;id&gt;</code> 查看 CPU 内存信息</p>
</li>
</ul>
<pre class=" language-shell"><code class="language-shell">  $ pm2 start app.js              # 启动app.js应用程序

  $ pm2 start app.js -i 4         # cluster mode 模式启动4个app.js的应用实例     # 4个应用程序会自动进行负载均衡

  $ pm2 start app.js --name="api" # 启动应用程序并命名为 "api"

  $ pm2 start app.js --watch      # 当文件变化时自动重启应用

  $ pm2 start script.sh           # 启动 bash 脚本


  $ pm2 list                      # 列表 PM2 启动的所有的应用程序

  $ pm2 monit                     # 显示每个应用程序的CPU和内存占用情况

  $ pm2 show [app-name]           # 显示应用程序的所有信息


  $ pm2 logs                      # 显示所有应用程序的日志

  $ pm2 logs [app-name]           # 显示指定应用程序的日志

  $ pm2 flush


  $ pm2 stop all                  # 停止所有的应用程序

  $ pm2 stop 0                    # 停止 id为 0的指定应用程序

  $ pm2 restart all               # 重启所有应用

  $ pm2 reload all                # 重启 cluster mode下的所有应用

  $ pm2 gracefulReload all        # Graceful reload all apps in cluster mode

  $ pm2 delete all                # 关闭并删除所有应用

  $ pm2 delete 0                  # 删除指定应用 id 0

  $ pm2 scale api 10              # 把名字叫api的应用扩展到10个实例

  $ pm2 reset [app-name]          # 重置重启数量


  $ pm2 startup                   # 创建开机自启动命令

  $ pm2 save                      # 保存当前应用列表

  $ pm2 resurrect                 # 重新加载保存的应用列表

  $ pm2 update                    # Save processes, kill PM2 and restore processes

  $ pm2 generate                  # Generate a sample json configuration file


  $ pm2 deploy app.json prod setup    # Setup "prod" remote server

  $ pm2 deploy app.json prod          # Update "prod" remote server

  $ pm2 deploy app.json prod revert 2 # Revert "prod" remote server by 2


  $ pm2 module:generate [name]    # Generate sample module with name [name]

  $ pm2 install pm2-logrotate     # Install module (here a log rotation system)

  $ pm2 uninstall pm2-logrotate   # Uninstall module

  $ pm2 publish                   # Increment version, git push and npm publish</code></pre>
<pre class=" language-shell"><code class="language-shell">windows 报错无法显示和解决方法：

PS E:\web\node\JStest\JStest\Node\node_blog\pm2-test> pm2 monit
pm2 : 无法加载文件 C:\Users\kishe\AppData\Roaming\npm\pm2.ps1，因为在此系统上禁止运行脚本。有关详细信息，请参阅 https:/
go.microsoft.com/fwlink/?LinkID=135170 中的 about_Execution_Policies。
所在位置 行:1 字符: 1
+ pm2 monit
+ ~~~
    + CategoryInfo          : SecurityError: (:) []，PSSecurityException
    + FullyQualifiedErrorId : UnauthorizedAccess
PS E:\web\node\JStest\JStest\Node\node_blog\pm2-test> set-ExecutionPolicy

位于命令管道位置 1 的 cmdlet Set-ExecutionPolicy
请为以下参数提供值:
ExecutionPolicy: RemoteSigned

执行策略更改
执行策略可帮助你防止执行不信任的脚本。更改执行策略可能会产生安全风险，如 https:/go.microsoft.com/fwlink/?LinkID=135170
中的 about_Execution_Policies 帮助主题所述。是否要更改执行策略?
[Y] 是(Y)  [A] 全是(A)  [N] 否(N)  [L] 全否(L)  [S] 暂停(S)  [?] 帮助 (默认值为“N”): y
PS E:\web\node\JStest\JStest\Node\node_blog\pm2-test> get-ExecutionPolicy
RemoteSigned
PS E:\web\node\JStest\JStest\Node\node_blog\pm2-test></code></pre>
<h4 id="进程守护"><a href="#进程守护" class="headerlink" title="进程守护"></a>进程守护</h4><ul>
<li>node app.js 和 nodemon app.js , 进程崩溃则不能访问</li>
<li>pm2 遇到进程崩溃，会自动重启</li>
</ul>
<p>代码演示：</p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// ./pm2-test/app.js</span>
<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 模拟日志</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'cur time'</span><span class="token punctuation">,</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// 模拟错误</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'假装出错了'</span><span class="token punctuation">,</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// 模拟一个错误</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>url <span class="token operator">===</span> <span class="token string">'/err'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'/err 出错了'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-type'</span><span class="token punctuation">,</span> <span class="token string">'application/json'</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>
        JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            errno<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            msg<span class="token punctuation">:</span> <span class="token string">'pm2 test server 2'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'server is runnig on port 8000...'</span><span class="token punctuation">)</span></code></pre>
<h4 id="常用配置和日志记录"><a href="#常用配置和日志记录" class="headerlink" title="常用配置和日志记录"></a>常用配置和日志记录</h4><ul>
<li>新建 PM2 配置文件（包括进程数量，日志文件目录等）</li>
<li>修改 PM2 启动命令，重启</li>
<li>访问 server ，检查日志文件的内容（日志记录是否生效）</li>
</ul>
<p>配置文件：</p>
<pre class=" language-json"><code class="language-json"><span class="token punctuation">{</span>
    <span class="token property">"apps"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"pm2-test-server"</span><span class="token punctuation">,</span>
        <span class="token property">"script"</span><span class="token operator">:</span> <span class="token string">"app.js"</span><span class="token punctuation">,</span>
        <span class="token property">"watch"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token property">"ingnore_watch"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token string">"node_modules"</span><span class="token punctuation">,</span>
            <span class="token string">"logs"</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token property">"instances"</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
        <span class="token property">"error_file"</span><span class="token operator">:</span> <span class="token string">"logs/err.log"</span><span class="token punctuation">,</span>
        <span class="token property">"out_file"</span><span class="token operator">:</span> <span class="token string">"logs/out.log"</span><span class="token punctuation">,</span>
        <span class="token property">"log_date_format"</span><span class="token operator">:</span> <span class="token string">"YYYY-MM-DD HH:mm:ss"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>启动方式：</p>
<pre class=" language-cmd"><code class="language-cmd">{
  "name": "pm2-test",
  "version": "1.0.0",
  "description": "",
  "main": "app.js",
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1",
    "dev": "cross-env NODE_ENV=dev nodemon app.js",
    "prd": "cross-env NODE_ENV=production pm2 start pm2.conf.json"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "dependencies": {
    "pm2": "^4.2.0"
  }
}
</code></pre>
<h4 id="多进程"><a href="#多进程" class="headerlink" title="多进程"></a>多进程</h4><ul>
<li>为何使用多进程？<ul>
<li>回顾之前讲 session 时说过， 操作系统限制一个进程的内存</li>
<li>内存：无法充分利用机器全部内存</li>
<li>CPU：无法充分利用多核CPU</li>
</ul>
</li>
<li>多进程和 redis<ul>
<li>多进程之间，内存无法共享</li>
<li>多进程访问一个 redis ，实现数据共享</li>
</ul>
</li>
</ul>
<h4 id="关于服务器运维"><a href="#关于服务器运维" class="headerlink" title="关于服务器运维"></a>关于服务器运维</h4><ul>
<li>服务器运维，一般都由专业的 OP 人员和部门来处理</li>
<li>大公司都有自己的运维团队</li>
<li>中小型工期推荐使用一些云服务，如阿里云的 node 平台</li>
</ul>
<h4 id="总结-8"><a href="#总结-8" class="headerlink" title="总结"></a>总结</h4><ul>
<li>PM2 的核心价值</li>
<li>PM2 的常用命令和配置，日志记录</li>
<li>多进程</li>
</ul>
<h2 id="课程总结"><a href="#课程总结" class="headerlink" title="课程总结"></a>课程总结</h2>
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">Eish</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://eish.top/2020/06/03/node-js-da-jian-bo-ke/">https://eish.top/2020/06/03/node-js-da-jian-bo-ke/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">Eish</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/JavaScript/">
                                    <span class="chip bg-color">JavaScript</span>
                                </a>
                            
                                <a href="/tags/Node-js/">
                                    <span class="chip bg-color">Node.js</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,qq,qzone,wechat,weibo" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    
        <link rel="stylesheet" href="/libs/gitalk/gitalk.css">
<link rel="stylesheet" href="/css/my-gitalk.css">

<div class="card gitalk-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; padding-left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="gitalk-container" class="card-content"></div>
</div>

<script src="/libs/gitalk/gitalk.min.js"></script>
<script>
    let gitalk = new Gitalk({
        clientID: 'b9cda0c484bb0e96f9b3',
        clientSecret: 'bdebd1183e2a88dcbac10b64c14d5d1da391c07b',
        repo: 'Eished.github.io',
        owner: 'Eished',
        admin: "Eished",
        id: '2020-06-03T22-50-45',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');
</script>

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="far fa-dot-circle"></i>&nbsp;本篇
            </div>
            <div class="card">
                <a href="/2020/06/03/node-js-da-jian-bo-ke/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/6.jpg" class="responsive-img" alt="Node.js搭建博客">
                        
                        <span class="card-title">Node.js搭建博客</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            Node.js搭建博客开发接口（不用框架）http请求概述
DNS 解析，建立 TCP 连接，发送 http 请求
server 接收到 http 请求，处理并返回数据
客户端接收到返回数据，处理数据（例如渲染、执行JS）

Node.js
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2020-06-03
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Node-js/" class="post-category">
                                    Node.js
                                </a>
                            
                            
                        </span>
                    </div>
                </div>

                
                <div class="card-action article-tags">
                    
                    <a href="/tags/JavaScript/">
                        <span class="chip bg-color">JavaScript</span>
                    </a>
                    
                    <a href="/tags/Node-js/">
                        <span class="chip bg-color">Node.js</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2020/06/02/vue2-5-cong-ling-ji-chu-ru-men-dao-shi-zhan-xiang-mu-kai-fa-qu-na-er-wang-app/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/12.jpg" class="responsive-img" alt="Vue2.5从零基础入门到实战项目开发去哪儿网App">
                        
                        <span class="card-title">Vue2.5从零基础入门到实战项目开发去哪儿网App</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            项目代码
第1章 课程介绍本章主要介绍课程的知识大纲，学习前提，讲授方式及预期收获。1-1 课程简介课程流程
知识点
课程安排
学习前提
讲授方式
通俗易懂的案例讲解
借助基础知识实现项目
带着你编写每一行代码
图文讲解复杂知识点

课程收
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2020-06-02
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Vue/" class="post-category">
                                    Vue
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Web/">
                        <span class="chip bg-color">Web</span>
                    </a>
                    
                    <a href="/tags/Vue/">
                        <span class="chip bg-color">Vue</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


<!-- 代码块折行 -->

<style type="text/css">
code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }
</style>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            <span id="year">2019</span>
            <a href="/about" target="_blank">Eish</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/Eished" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:sueis@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>













</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/search.xml", 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
