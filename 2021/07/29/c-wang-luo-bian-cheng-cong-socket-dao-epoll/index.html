<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
    <meta name="keywords" content="C/C++网络编程，从socket到epoll, Web, technology, CSS, HTML, JavaScript, Vue, C, C++, cpp">
    <meta name="description" content="虚拟机安装 ssh1.安装命令：
sudo apt-get install openssh-server
安装完成，服务默认已经开启，可以远程ssh连接了。

2.查看ssh服务状态：
sudo service ssh status

3.">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>C/C++网络编程，从socket到epoll | iKnow&#39;s blog</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    


    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/css/matery.css">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<link rel="stylesheet" type="text/css" href="/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="/css/post.css">




    



    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="iKnow's blog" type="application/atom+xml"><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>


<body>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">iKnow&#39;s blog</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a target="_blank" rel="noopener" href="https://run.iknow.fun" class="waves-effect waves-light">
      
      <span>Running</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">iKnow&#39;s blog</div>
        <div class="logo-desc">
            
            Web technology CSS HTML JavaScript Vue Node.js C++
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a target="_blank" rel="noopener" href="https://run.iknow.fun" class="waves-effect waves-light">
			
				<i class="fas fa-fw fa-link"></i>
			
			Running
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/Eished" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/Eished" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/8.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">C/C++网络编程，从socket到epoll</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/C/">
                                <span class="chip bg-color">C</span>
                            </a>
                        
                            <a href="/tags/C/">
                                <span class="chip bg-color">C++</span>
                            </a>
                        
                            <a href="/tags/socket/">
                                <span class="chip bg-color">socket</span>
                            </a>
                        
                            <a href="/tags/epoll/">
                                <span class="chip bg-color">epoll</span>
                            </a>
                        
                            <a href="/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/">
                                <span class="chip bg-color">网络编程</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/C-C/" class="post-category">
                                C/C++
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2021-07-29
                </div>
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    7.2k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    28 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.min.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="虚拟机安装-ssh"><a href="#虚拟机安装-ssh" class="headerlink" title="虚拟机安装 ssh"></a>虚拟机安装 ssh</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">1</span>.安装命令：
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> openssh-server
安装完成，服务默认已经开启，可以远程ssh连接了。

<span class="token number">2</span>.查看ssh服务状态：
<span class="token function">sudo</span> <span class="token function">service</span> <span class="token function">ssh</span> status

<span class="token number">3</span>.ssh服务重启命令：
<span class="token function">sudo</span> <span class="token function">service</span> <span class="token function">ssh</span> restart

<span class="token number">4</span>.ssh服务的配置文件，可以修改服务端口，权限控制等
<span class="token function">sudo</span> gedit /etc/ssh/sshd_config<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="vi-常用命令"><a href="#vi-常用命令" class="headerlink" title="vi 常用命令"></a><a target="_blank" rel="noopener" href="https://www.freecplus.net/28096d085cbe471c986d246b43ac4fe4.html">vi 常用命令</a></h2><h3 id="一、关于-vi"><a href="#一、关于-vi" class="headerlink" title="一、关于 vi"></a>一、关于 vi</h3><p>vi 是最强大的文本编辑器，没有之一。尽管 vi 已经是古董级的软件，但还是有无数新人迎着困难去<a target="_blank" rel="noopener" href="https://www.iplaysoft.com/tag/%E5%AD%A6%E4%B9%A0">学习</a>使用，可见其经典与受欢迎的程度。</p>
<p>无论是小说中还是电视剧，真正强大的武器都不容易驾驭，需要付出一些努力才能收获到更加强大的力量，对于 vi 这种**上古<a target="_blank" rel="noopener" href="https://www.iplaysoft.com/tag/%E7%A5%9E%E5%99%A8">神器</a>**来说更是如此。由于它全程使用键盘操作，很多首次接触 vi 的人会觉得不习惯而中途放弃。然而，坚持下来的朋友就会渐渐地发现这种键盘操作的设计绝妙，经典之所以能成为经典，必然有它的道理，不用解释太多。</p>
<p>观察一个程序员对 vi 的熟练程度，可以判断它的技术水平，如果他对 vi 不熟悉，就肯定不是 Linux 平台下的程序员，说 vi 不好用的人也肯定不熟悉 vi 和 Linux，没有例外。</p>
<h3 id="二、创建-x2F-打开文件"><a href="#二、创建-x2F-打开文件" class="headerlink" title="二、创建&#x2F;打开文件"></a>二、创建&#x2F;打开文件</h3><p>vi 文件名</p>
<p>打开一个文件，如果文件不存在，就创建它。</p>
<p>示例：</p>
<p>vi book.c</p>
<h3 id="三、vi-的三种模式"><a href="#三、vi-的三种模式" class="headerlink" title="三、vi 的三种模式"></a>三、vi 的三种模式</h3><p>vi 有三种模式，命令行模式、插入模式和替换模式，在命令行模式下，任何键盘输入都是命令，在插入模式和替换模式下，键盘输入的才是字符。</p>
<p>插入模式和替换模式也合称为编辑模式。</p>
<h3 id="四、vi-的常用命令"><a href="#四、vi-的常用命令" class="headerlink" title="四、vi 的常用命令"></a>四、vi 的常用命令</h3><p>Esc 从编辑模式切换到命令行模式。</p>
<p>i 在光标所在位置前面开始插入。</p>
<p>a 在光标所在的位置后面开始插入。</p>
<p>o 在光标所在位置行的下面插入空白行。</p>
<p>O 在光标所在位置行的上面插入空白行。</p>
<p>I 在光标所在位置行的行首开始插入。</p>
<p>A 在光标所在位置行的行末开始插入。</p>
<p>k 类似方向键上。</p>
<p>j 类似方向键下。</p>
<p>h 类似方向键左。</p>
<p>l 类是方向键右。</p>
<p>Ctrl+u 向上翻半页。</p>
<p>Ctrl+d 向下翻页。</p>
<p>Ctrl+g 显示光标所在位置的行号和文件的总行数。</p>
<p>nG 光标跳到文件的第 n 行行首。</p>
<p>G 光标跳到文件最后一行。</p>
<p>:5 回车 光标跳到第 5 行。</p>
<p>:n 回车 光标跳到第 n 行。</p>
<p>0 光标跳到当前行的行首。</p>
<p>$ 光标跳到当前行的行尾。</p>
<p>w 光标跳到下个单词的开头。</p>
<p>b 光标跳到上个单词的开头。</p>
<p>e 光标跳到本单词的尾部。</p>
<p>x 每按一次，删除光标所在位置的一个字符。</p>
<p>nx 如”3x”表示删除光标所在位置开始的 3 个字符。</p>
<p>dw 删除光标所在位置到本单词结尾的字符。</p>
<p>D 删除本行光标所在位置后面全部的内容。</p>
<p>dd 删除光标所在位置的一行。</p>
<p>ndd 如”3dd”表示删除光标所在位置开始的 3 行。</p>
<p>yy 将光标所在位置的一行复制到缓冲区。</p>
<p>nyy 将光标所在位置的 n 行复制到缓冲区。</p>
<p>p 将缓冲区里的内容粘贴到光标所在位置。</p>
<p>r 替换光标所在位置的一个字符 replace。</p>
<p>R 从光标所在位置开始替换，直到按下”Esc”。</p>
<p>cw 从光标所在位置开始替换单词，直到按下”Esc”。</p>
<p>u 撤销命令，可多次撤销。</p>
<p>J 把当前行的下一行接到当前行的尾部。</p>
<p>&#x2F;abcd 在当前打开的文件中查找“abcd”文本内容。</p>
<p>n 查找下一个。</p>
<p>N 查找上一下。</p>
<p>. 重复执行上一次执行的 vi 命令。</p>
<p>~ 对光标当前所在的位置的字符进行大小写转换。</p>
<p>列操作</p>
<p>Ctrl+V 光标上或下 大写的 I 输入内容 Esc</p>
<p>:w 回车 存盘。</p>
<p>:w!回车 强制存盘。</p>
<p>:wq 回车 存盘退出。</p>
<p>:x 回车 存盘退出。</p>
<p>:q 回车 不存盘退出。</p>
<p>:q!回车 不存盘强制退出。</p>
<p>:g&#x2F;aaaaaaaaa&#x2F;s&#x2F;&#x2F;bbbbbb&#x2F;g 回车 把文件中全部的 aaaaaaaaa 替换成 bbbbbb。</p>
<p>Ctl+insert 复制鼠标选中的文本，相当于 Ctl+c。</p>
<p>Shift+insert 输出鼠标选中的文本，相当于 Ctl+v。</p>
<p>以上两个命令在 windows 和 UNIX 中是通用的。</p>
<h3 id="vim-粘贴时取消自动换行"><a href="#vim-粘贴时取消自动换行" class="headerlink" title="vim 粘贴时取消自动换行"></a>vim 粘贴时取消自动换行</h3><p>当 vim 开启 smartindent 时，对于代码会有自动换行的功效。但是，有时候我们需要在向 vim 中粘贴代码时，需要暂时关闭自动换行的功能。</p>
<p><strong>解决方法：</strong></p>
<p>:set paste</p>
<p>之后进行插入操作，vim 提示变为： – INSERT (paste) –</p>
<p>这时就不再有自动换行。</p>
<p><strong>恢复：</strong></p>
<p>:set nopaste</p>
<p>vim 提示变为：– INSERT –</p>
<h3 id="vim-支持-c-x2F-c-STL-即标准库关键字高亮"><a href="#vim-支持-c-x2F-c-STL-即标准库关键字高亮" class="headerlink" title="vim 支持 c&#x2F;c++ STL 即标准库关键字高亮"></a>vim 支持 c&#x2F;c++ STL 即标准库关键字高亮</h3><p><strong>手动复制进去</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> clone https://github.com/octol/vim-cpp-enhanced-highlight.git /tmp/vim-cpp-enhanced-highlight
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> ~/.vim/after/syntax/
<span class="token function">mv</span> /tmp/vim-cpp-enhanced-highlight/after/syntax/cpp.vim ~/.vim/after/syntax/cpp.vim
<span class="token function">rm</span> <span class="token parameter variable">-rf</span> /tmp/vim-cpp-enhanced-highlight<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="mac-x2F-linux-中-vim-永久显示行号、开启语法高亮"><a href="#mac-x2F-linux-中-vim-永久显示行号、开启语法高亮" class="headerlink" title="mac&#x2F;linux 中 vim 永久显示行号、开启语法高亮"></a><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000024433066">mac&#x2F;linux 中 vim 永久显示行号、开启语法高亮</a></h3><pre class="line-numbers language-none"><code class="language-none">cp &#x2F;usr&#x2F;share&#x2F;vim&#x2F;vimrc ~&#x2F;.vimrc<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>先复制一份 vim 配置模板到个人目录下</p>
<p>注：redhat 改成 cp &#x2F;etc&#x2F;vimrc ~&#x2F;.vimrc</p>
<p><strong>步骤 2</strong>：</p>
<pre class="line-numbers language-none"><code class="language-none">vi ~&#x2F;.vimrc<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>进入 insert 模式，在最后加二行</p>
<pre class="line-numbers language-none"><code class="language-none">syntax on

set nu!<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>保存收工。</p>
<pre class="line-numbers language-none"><code class="language-none">set nocompatible                 &quot;去掉有关vi一致性模式，避免以前版本的bug和局限

set nu!                                    &quot;显示行号

set guifont&#x3D;Luxi&#x2F; Mono&#x2F; 9   &quot; 设置字体，字体名称和字号

filetype on                              &quot;检测文件的类型

set history&#x3D;1000                  &quot;记录历史的行数

set background&#x3D;dark          &quot;背景使用黑色

syntax on                                &quot;语法高亮度显示

set autoindent                       &quot;vim使用自动对齐，也就是把当前行的对齐格式应用到下一行(自动缩进）

set cindent                             &quot;（cindent是特别针对 C语言语法自动缩进）

set smartindent                    &quot;依据上面的对齐格式，智能的选择对齐方式，对于类似C语言编写上有用

set tabstop&#x3D;4                        &quot;设置tab键为4个空格，

set shiftwidth &#x3D;4                   &quot;设置当行之间交错时使用4个空格

set ai!                                      &quot; 设置自动缩进

set showmatch                     &quot;设置匹配模式，类似当输入一个左括号时会匹配相应的右括号

set guioptions-&#x3D;T                 &quot;去除vim的GUI版本中得toolbar

set vb t_vb&#x3D;                            &quot;当vim进行编辑时，如果命令错误，会发出警报，该设置去掉警报

set ruler                                  &quot;在编辑过程中，在右下角显示光标位置的状态行

set nohls                                &quot;默认情况下，寻找匹配是高亮度显示，该设置关闭高亮显示

set incsearch                        &quot;在程序中查询一单词，自动匹配单词的位置；如查询desk单词，当输到&#x2F;d时，会自动找到第一个d开头的单词，当输入到&#x2F;de时，会自动找到第一个以ds开头的单词，以此类推，进行查找；当找到要匹配的单词时，别忘记回车

set backspace&#x3D;2           &quot; 设置退格键可用<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>注：如果是 mac，更好的办法是直接换掉默认的终端，改用 zsh</p>
<h3 id="vim-显示行号、语法高亮、自动缩进的设置"><a href="#vim-显示行号、语法高亮、自动缩进的设置" class="headerlink" title="vim 显示行号、语法高亮、自动缩进的设置"></a>vim 显示行号、语法高亮、自动缩进的设置</h3><p>在 UBUNTU 中 vim 的配置文件存放在&#x2F;etc&#x2F;vim 目录中，配置文件名为 vimrc</p>
<p>在 Fedora 中 vim 的配置文件存放在&#x2F;etc 目录中，配置文件名为 vimrc</p>
<p>在 Red Hat Linux 中 vim 的配置文件存放在&#x2F;etc 目录中，配置文件名为 vimrc</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">set</span> nocompatible                 "去掉有关vi一致性模式，避免以前版本的bug和局限
<span class="token keyword">set</span> nu<span class="token operator">!</span>                                    "显示行号
<span class="token keyword">set</span> guifont<span class="token operator">=</span>Luxi<span class="token operator">/</span> Mono<span class="token operator">/</span> <span class="token number">9</span>   " 设置字体，字体名称和字号
filetype on                              "检测文件的类型
<span class="token keyword">set</span> history<span class="token operator">=</span><span class="token number">1000</span>                  "记录历史的行数
<span class="token keyword">set</span> background<span class="token operator">=</span>dark          "背景使用黑色
syntax on                                "语法高亮度显示
<span class="token keyword">set</span> autoindent                       "<span class="token function">vim使用自动对齐，也就是把当前行的对齐格式应用到下一行</span><span class="token punctuation">(</span>自动缩进）
<span class="token keyword">set</span> cindent                             "（cindent是特别针对 <span class="token constant">C</span>语言语法自动缩进）
<span class="token keyword">set</span> smartindent                    "依据上面的对齐格式，智能的选择对齐方式，对于类似<span class="token constant">C</span>语言编写上有用
<span class="token keyword">set</span> tabstop<span class="token operator">=</span><span class="token number">4</span>                        "设置tab键为<span class="token number">4</span>个空格，
<span class="token keyword">set</span> shiftwidth <span class="token operator">=</span><span class="token number">4</span>                   "设置当行之间交错时使用<span class="token number">4</span>个空格
<span class="token keyword">set</span> ai<span class="token operator">!</span>                                      " 设置自动缩进
<span class="token keyword">set</span> showmatch                     "设置匹配模式，类似当输入一个左括号时会匹配相应的右括号
<span class="token keyword">set</span> guioptions<span class="token operator">-=</span><span class="token constant">T</span>                 "去除vim的<span class="token constant">GUI</span>版本中得toolbar
<span class="token keyword">set</span> vb t_vb<span class="token operator">=</span>                            "当vim进行编辑时，如果命令错误，会发出警报，该设置去掉警报
<span class="token keyword">set</span> ruler                                  "在编辑过程中，在右下角显示光标位置的状态行
<span class="token keyword">set</span> nohls                                "默认情况下，寻找匹配是高亮度显示，该设置关闭高亮显示
<span class="token keyword">set</span> incsearch                        "在程序中查询一单词，自动匹配单词的位置；如查询desk单词，当输到<span class="token operator">/</span>d时，会自动找到第一个d开头的单词，当输入到<span class="token operator">/</span>de时，会自动找到第一个以ds开头的单词，以此类推，进行查找；当找到要匹配的单词时，别忘记回车
<span class="token keyword">set</span> backspace<span class="token operator">=</span><span class="token number">2</span>           " 设置退格键可用
修改一个文件后，自动进行备份，备份的文件名为原文件名加“<span class="token operator">~</span>”后缀
      <span class="token keyword">if</span> <span class="token function">has</span><span class="token punctuation">(</span><span class="token string">"vms"</span><span class="token punctuation">)</span>
      <span class="token keyword">set</span> nobackup
      <span class="token keyword">else</span>
      <span class="token keyword">set</span> backup
      endif<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>如果设置完成后，发现功能没有起作用，检查一下系统下是否安装了 vim-enhanced 包，查询命令为：</p>
<p>​ $rpm -q vim-enhanced 注意：如果设置好以上设置后，VIM 没有作出相应的动作，那么请你把你的 VIM 升级到最新版，一般只要在终端输入以下命令即可：sudo apt-get install vim</p>
<p>转自：<a target="_blank" rel="noopener" href="https://blog.csdn.net/chuanj1985/article/details/6873830">https://blog.csdn.net/chuanj1985/article/details/6873830</a></p>
<h2 id="C-语言-makefile-文件"><a href="#C-语言-makefile-文件" class="headerlink" title="C 语言 makefile 文件"></a><a target="_blank" rel="noopener" href="https://www.freecplus.net/b7a1c199959f4349b2a98874864a2000.html">C 语言 makefile 文件</a></h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">apt</span> <span class="token function">install</span> <span class="token function">make</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>在软件的工程中的源文件是很多的，其按照类型、功能、模块分别放在若干个目录和文件中，哪些文件需要编译，那些文件需要后编译，那些文件需要重新编译，甚至进行更复杂的功能操作，这就有了我们的系统编译的工具。</p>
<p>在 linux 和 unix 中，有一个强大的实用程序，叫 make，可以用它来管理多模块程序的编译和链接，直至生成可执行文件。</p>
<p>make 程序需要一个编译规则说明文件，称为 makefile，makefile 文件中描述了整个软件工程的编译规则和各个文件之间的依赖关系。</p>
<p>makefile 就像是一个 shell 脚本一样，其中可以执行操作系统的命令，它带来的好处就是我们能够实现“自动化编译”，一旦写好，只要一个 make 命令，整个软件功能就完全自动编译，提高了软件开发的效率。</p>
<p>make 是一个命令工具，是一个解释 makefile 中指令的命令工具，一般来说大多数编译器都有这个命令，使用 make 可以是重新编译的次数达到最小化。</p>
<h3 id="一、makefile-的编写"><a href="#一、makefile-的编写" class="headerlink" title="一、makefile 的编写"></a>一、makefile 的编写</h3><p>makefile 文件的规则可以非常复杂，比 C 程序还要复杂，我通过示例来介绍它的简单用法。</p>
<p>文件名：makefile，内容如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">all:book1 book46

book1:book1.c
        gcc <span class="token parameter variable">-o</span> book1 book1.c

book46:book46.c _public.h _public.c
        gcc <span class="token parameter variable">-o</span> book46 book46.c _public.c

clean:
        <span class="token function">rm</span> <span class="token parameter variable">-f</span> book1 book46<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>第一行</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">all:book book46<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>all: 这是固定的写法。</p>
<p>book1 book46 表示需要编译目标程序的清单，中间用空格分隔开，如果清单很长，可以用\换行。</p>
<p><strong>第二行</strong></p>
<p>makefile 文件中的空行就像 C 程序中的空行一样，只是为了书写整洁，没有什么意义。</p>
<p><strong>第三行</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">book1:book1.c<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>book1:表示需要编译的目标程序。</p>
<p>如果要编译目标程序 book1，需要依赖源程序 book1.c，当 book1.c 的内容发生了变化，执行 make 的时候就会重新编译 book1。</p>
<p><strong>第四行</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gcc <span class="token parameter variable">-o</span> book1 book1.c<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这是一个编译命令，和在操作系统命令行输入的命令一样，但是要注意一个问题，在 gcc 之前要用 tab 键，看上去像 8 个空格，实际不是，一定要用 tab，空格不行。</p>
<p><strong>第六行</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">book46:book46.c _public.h _public.c<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>与第三行的含义相同。</p>
<p>book46:表示编译的目标程序。</p>
<p>如果要编译目标程序 book46，需要依赖源程序 book46.c、_public.h 和_public.c 三个文件，只要任何一个的内容发生了变化，执行 make 的时候就会重新编译 book46。</p>
<p><strong>第七行</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gcc <span class="token parameter variable">-o</span> book46 book46.c _public.c<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>与第四行的含义相同。</p>
<p><strong>第九行</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">clean:<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>清除目标文件，清除的命令由第十行之后的脚本来执行。</p>
<p><strong>第十行</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">rm</span>  <span class="token parameter variable">-f</span>  book1 book46<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>清除目标文件的脚本命令，注意了，rm 之前也是一个 tab 键，不是空格。</p>
<h3 id="二、make-命令"><a href="#二、make-命令" class="headerlink" title="二、make 命令"></a>二、make 命令</h3><p>makefile 准备好了，在命令提示符下执行 make 就可以编译 makefile 中 all 参数指定的目标文件。</p>
<p>执行 make 编译目标程序：</p>
<p><img src="https://www.freecplus.net/runoobFiles/ueditor/image/20200318/1584536443451006468.png" alt="image.png"></p>
<p>再执行一次 make：</p>
<p><img src="https://www.freecplus.net/runoobFiles/ueditor/image/20200318/1584536454572081980.png" alt="image.png"></p>
<p>因为全部的目标程序都是最新的，所以提示没有目标可以编译。</p>
<p>执行 make clean，执行清除目标文件的指令。</p>
<p><img src="https://www.freecplus.net/runoobFiles/ueditor/image/20200318/1584536467750040871.png" alt="image.png"></p>
<p>再执行 make 重新编译。</p>
<p><img src="https://www.freecplus.net/runoobFiles/ueditor/image/20200318/1584536479435025308.png" alt="image.png"></p>
<p>修改_public.c 程序，随便改点什么，只要改了就行。</p>
<p>然后再执行 make：</p>
<p><img src="https://www.freecplus.net/runoobFiles/ueditor/image/20200318/1584536490024019135.png" alt="image.png"></p>
<p>注意了，因为 book46 依赖的源程序之一_public.c 改变了，所以 book46 重新编译。</p>
<p>book1 没有重新编译，因为 book1 依赖的源文件并没有改变。</p>
<h3 id="三、makefile-文件中的变量"><a href="#三、makefile-文件中的变量" class="headerlink" title="三、makefile 文件中的变量"></a>三、makefile 文件中的变量</h3><p>makefile 中，变量就是一个名字，变量的值就是一个文本字符串。在 makefile 中的目标，依赖，命令或其他地方引用变量时，变量会被它的值替代。</p>
<p>我通过示例来介绍它的简单用法。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">CC</span><span class="token operator">=</span>gcc
<span class="token assign-left variable">FLAG</span><span class="token operator">=</span>-g

all:book1 book46

book1:book1.c
        <span class="token variable"><span class="token variable">$(</span>CC<span class="token variable">)</span></span> <span class="token variable"><span class="token variable">$(</span>FLAG<span class="token variable">)</span></span> <span class="token parameter variable">-o</span> book1 book1.c

book46:book46.c _public.h _public.c
        <span class="token variable"><span class="token variable">$(</span>CC<span class="token variable">)</span></span> <span class="token variable"><span class="token variable">$(</span>FLAG<span class="token variable">)</span></span> <span class="token parameter variable">-o</span> book46 book46.c _public.c

clean:
        <span class="token function">rm</span> <span class="token parameter variable">-f</span> book1 book46<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>第一行</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">CC</span><span class="token operator">=</span>gcc<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>定义变量 CC，赋值 gcc。</p>
<p><strong>第二行</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">FLAG</span><span class="token operator">=</span>-g<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>定义变量 FLAG，赋值-g。</p>
<p><strong>第七行</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token variable"><span class="token variable">$(</span>CC<span class="token variable">)</span></span>  <span class="token variable"><span class="token variable">$(</span>FLAG<span class="token variable">)</span></span> <span class="token parameter variable">-o</span> book1 book1.c<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><code>$(CC)和$(FLAG)</code>就是使用变量 CC 和 FLAG 的值，类似于 C 语言的宏定义，替换后的结果是：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gcc <span class="token parameter variable">-g</span> <span class="token parameter variable">-o</span> book1 book1.c<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>编译效果：</p>
<p><img src="https://www.freecplus.net/runoobFiles/ueditor/image/20200318/1584536550181088438.png" alt="image.png"></p>
<p>在 makefile 文件中，使用变量的好处有两个：</p>
<p>​ 1）如果在很多编译指令采用了变量，只要修改变量的值，就相当于修改全部的编译指令；</p>
<p>​ 2）把比较长的、公共的编译指令采用变量来表示，可以让 makefile 更简洁。</p>
<p>四、应用经验</p>
<p>makefile 文件的编写可以很复杂，复杂到我不想看，在实际开发中，用不着那么复杂的 makefile，我追求简单实用的方法，腾出更多的时间和精力去做更重要的事情，那些把 makefile 文件写得很复杂的程序员在我看来是吃饱了撑的。</p>
<p>五、课后作业</p>
<p>把您这段时间写的程序全部编写到 makefile 中，以后再也不要在命令提示符下用 gcc 了。</p>
<p>六、版权声明</p>
<p>C 语言技术网原创文章，转载请说明文章的来源、作者和原文的链接。</p>
<p>来源：C 语言技术网（<a target="_blank" rel="noopener" href="http://www.freecplus.net/">www.freecplus.net</a>）</p>
<p>作者：码农有道</p>
<p>如果文章有错别字，或者内容有错误，或其他的建议和意见，请您联系我们指正，非常感谢！！！</p>
<h2 id="C-C-网络编程，从-socket-到-epoll"><a href="#C-C-网络编程，从-socket-到-epoll" class="headerlink" title="C\C++网络编程，从 socket 到 epoll"></a>C\C++网络编程，从 socket 到 epoll</h2><h3 id="学习-Linux-编程前的准备"><a href="#学习-Linux-编程前的准备" class="headerlink" title="学习 Linux 编程前的准备"></a><a target="_blank" rel="noopener" href="https://www.freecplus.net/d08d40bbe87e4ff3bdcab956fdfca6f8.html">学习 Linux 编程前的准备</a></h3><p>编译器</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">apt</span> <span class="token function">install</span> gcc-c++<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>编译 C 程序的命令是 gcc，编译 C++程序的命令是 g++，g++命令和 gcc 命令的用法相同，把 gcc 改为 g++就可以了，我们在学习 C 语言时编写的那些示例程序，基本上都可以用 g++来编译。</p>
<pre class="line-numbers language-none"><code class="language-none">g++ -o book1 book1.c<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>XSHELL ssh vim 語法高亮配置</strong></p>
<p>文件, 默认&#x2F;当前会话属性, 终端, 终端类型：linux</p>
<p>文件, 默认&#x2F;当前会话属性, 终端, 键盘, 功能键类型：linux</p>
<p><strong>如何对 xshell 中的输入命令的那一行进行高亮显示呢</strong></p>
<p>修改你登录用户目录下的.bashrc 文件，把 46 行的注释去掉保存后重新登录即可</p>
<p>（如果使用其他用户登录，其下的.bashrc 也要修改，和 xshell 无关）</p>
<p><img src="https://img3.sycdn.imooc.com/5e5d2d2c0001168204690193.jpg" alt="//img1.sycdn.imooc.com/5e5d2d2c0001168204690193.jpg"></p>
<p>重新登录后</p>
<p><img src="https://img1.sycdn.imooc.com/5e5d2d9b00015d9804510114.jpg" alt="//img4.sycdn.imooc.com/5e5d2d9b00015d9804510114.jpg"></p>
<h3 id="一、网络通信-socket"><a href="#一、网络通信-socket" class="headerlink" title="一、网络通信 socket"></a>一、网络通信 socket</h3><p>socket 就是插座（中文翻译成套接字有点莫名其妙），运行在计算机中的两个程序通过 socket 建立起一个通道，数据在通道中传输。</p>
<p><img src="https://www.freecplus.net/runoobFiles/ueditor/image/20200922/1600759995760026651.png" alt="image.png"></p>
<p>socket 把复杂的 TCP&#x2F;IP 协议族隐藏了起来，对程序员来说，只要用好 socket 相关的函数，就可以完成网络通信。</p>
<h3 id="二、socket-的分类"><a href="#二、socket-的分类" class="headerlink" title="二、socket 的分类"></a>二、socket 的分类</h3><p>socket 提供了流（stream）和数据报（datagram）两种通信机制，即流 socket 和数据报 socket。</p>
<p>流 socket 基于 TCP 协议，是一个有序、可靠、双向字节流的通道，传输数据不会丢失、不会重复、顺序也不会错乱。就像两个人在打电话，接通后就在线了，您一句我一句的聊天。</p>
<p>数据报 socket 基于 UDP 协议，不需要建立和维持连接，可能会丢失或错乱。UDP 不是一个可靠的协议，对数据的长度有限制，但是它的速度比较高。就像短信功能，一个人向另一个人发短信，对方不一定能收到。</p>
<p>在实际开发中，数据报 socket 的应用场景极少，本教程只介绍流 socket。</p>
<h3 id="三、客户-x2F-服务端模式"><a href="#三、客户-x2F-服务端模式" class="headerlink" title="三、客户&#x2F;服务端模式"></a>三、客户&#x2F;服务端模式</h3><p>在 TCP&#x2F;IP 网络应用中，两个程序之间通信模式是客户&#x2F;服务端模式（client&#x2F;server），客户&#x2F;服务端也叫作客户&#x2F;服务器，各人习惯。</p>
<p><img src="https://www.freecplus.net/runoobFiles/ueditor/image/20200922/1600758212122001314.png" alt="image.png"></p>
<h4 id="1、服务端的工作流程"><a href="#1、服务端的工作流程" class="headerlink" title="1、服务端的工作流程"></a>1、服务端的工作流程</h4><p>1）创建服务端的 socket。</p>
<p>2）把服务端用于通信的地址和端口绑定到 socket 上。</p>
<p>3）把 socket 设置为监听模式。</p>
<p>4）接受客户端的连接。</p>
<p>5）与客户端通信，接收客户端发过来的报文后，回复处理结果。</p>
<p>6）不断的重复第 5）步，直到客户端断开连接。</p>
<p>7）关闭 socket，释放资源。</p>
<p><strong>服务端示例（server.cpp）</strong></p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">/*
 * 程序名：server.cpp，此程序用于演示socket通信的服务端
 * 作者：C语言技术网(www.freecplus.net) 日期：20190525
*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netdb.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span><span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>argc<span class="token operator">!=</span><span class="token number">2</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Using:./server port\nExample:./server 5005\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// 第1步：创建服务端的socket。</span>
  <span class="token keyword">int</span> listenfd<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>listenfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span>SOCK_STREAM<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>

  <span class="token comment">// 第2步：把服务端用于通信的地址和端口绑定到socket上。</span>
  <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> servaddr<span class="token punctuation">;</span>    <span class="token comment">// 服务端地址信息的数据结构。</span>
  <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>servaddr<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>servaddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  servaddr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>  <span class="token comment">// 协议族，在socket编程中只能是AF_INET。</span>
  servaddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">htonl</span><span class="token punctuation">(</span>INADDR_ANY<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// 任意ip地址。</span>
  <span class="token comment">//servaddr.sin_addr.s_addr = inet_addr("192.168.190.134"); // 指定ip地址。</span>
  servaddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 指定通信端口。</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">bind</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>servaddr<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>servaddr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span> <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"bind"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">close</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>

  <span class="token comment">// 第3步：把socket设置为监听模式。</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">listen</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"listen"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">close</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>

  <span class="token comment">// 第4步：接受客户端的连接。</span>
  <span class="token keyword">int</span>  clientfd<span class="token punctuation">;</span>                  <span class="token comment">// 客户端的socket。</span>
  <span class="token keyword">int</span>  socklen<span class="token operator">=</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// struct sockaddr_in的大小</span>
  <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> clientaddr<span class="token punctuation">;</span>  <span class="token comment">// 客户端的地址信息。</span>
  clientfd<span class="token operator">=</span><span class="token function">accept</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>clientaddr<span class="token punctuation">,</span><span class="token punctuation">(</span>socklen_t<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>socklen<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"客户端（%s）已连接。\n"</span><span class="token punctuation">,</span><span class="token function">inet_ntoa</span><span class="token punctuation">(</span>clientaddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 第5步：与客户端通信，接收客户端发过来的报文后，回复ok。</span>
  <span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> iret<span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>iret<span class="token operator">=</span><span class="token function">recv</span><span class="token punctuation">(</span>clientfd<span class="token punctuation">,</span>buffer<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// 接收客户端的请求报文。</span>
    <span class="token punctuation">&#123;</span>
       <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"iret=%d\n"</span><span class="token punctuation">,</span>iret<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"接收：%s\n"</span><span class="token punctuation">,</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">strcpy</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span><span class="token string">"ok"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>iret<span class="token operator">=</span><span class="token function">send</span><span class="token punctuation">(</span>clientfd<span class="token punctuation">,</span>buffer<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// 向客户端发送响应结果。</span>
    <span class="token punctuation">&#123;</span> <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"send"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"发送：%s\n"</span><span class="token punctuation">,</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// 第6步：关闭socket，释放资源。</span>
  <span class="token function">close</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">close</span><span class="token punctuation">(</span>clientfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="2、客户端的工作流程"><a href="#2、客户端的工作流程" class="headerlink" title="2、客户端的工作流程"></a>2、客户端的工作流程</h4><p>1）创建客户端的 socket。</p>
<p>2）向服务器发起连接请求。</p>
<p>3）与服务端通信，发送一个报文后等待回复，然后再发下一个报文。</p>
<p>4）不断的重复第 3）步，直到全部的数据被发送完。</p>
<p>5）第 4 步：关闭 socket，释放资源。</p>
<p><strong>客户端示例（client.cpp）</strong></p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">/*
 * 程序名：client.cpp，此程序用于演示socket的客户端
 * 作者：C语言技术网(www.freecplus.net) 日期：20190525
*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netdb.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span><span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>argc<span class="token operator">!=</span><span class="token number">3</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Using:./client ip port\nExample:./client 127.0.0.1 5005\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// 第1步：创建客户端的socket。</span>
  <span class="token keyword">int</span> sockfd<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>sockfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span>SOCK_STREAM<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>

  <span class="token comment">// 第2步：向服务器发起连接请求。</span>
  <span class="token keyword">struct</span> <span class="token class-name">hostent</span><span class="token operator">*</span> h<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>h <span class="token operator">=</span> <span class="token function">gethostbyname</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span>   <span class="token comment">// 指定服务端的ip地址。</span>
  <span class="token punctuation">&#123;</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"gethostbyname failed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
  <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> servaddr<span class="token punctuation">;</span>
  <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>servaddr<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>servaddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  servaddr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
  servaddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 指定服务端的通信端口。</span>
  <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>servaddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">,</span>h<span class="token operator">-></span>h_addr<span class="token punctuation">,</span>h<span class="token operator">-></span>h_length<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 不能直接赋值</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">connect</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>servaddr<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>servaddr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment">// 向服务端发起连接清求。</span>
  <span class="token punctuation">&#123;</span> <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"connect"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>

  <span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token comment">// 第3步：与服务端通信，发送一个报文后等待回复，然后再发下一个报文。</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> ii<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>ii<span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">;</span>ii<span class="token operator">++</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> iret<span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sprintf</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span><span class="token string">"这是第%d个超级女生，编号%03d。"</span><span class="token punctuation">,</span>ii<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>ii<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>iret<span class="token operator">=</span><span class="token function">send</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span>buffer<span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// 向服务端发送请求报文。</span>
    <span class="token punctuation">&#123;</span> <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"send"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"发送：%s\n"</span><span class="token punctuation">,</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">memset</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>iret<span class="token operator">=</span><span class="token function">recv</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span>buffer<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// 接收服务端的回应报文。</span>
    <span class="token punctuation">&#123;</span>
       <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"iret=%d\n"</span><span class="token punctuation">,</span>iret<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"接收：%s\n"</span><span class="token punctuation">,</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// 第4步：关闭socket，释放资源。</span>
  <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>在运行程序之前，必须保证服务器的防火墙已经开通了网络访问策略（云服务器还需要登录云控制平台开通访问策略）。</strong></p>
<p>先启动服务端程序 server，服务端启动后，进入等待客户端连接状态，然后启动客户端。</p>
<p>客户端的输出如下：</p>
<p><img src="https://www.freecplus.net/runoobFiles/ueditor/image/20200922/1600748091684066055.png" alt="image.png"></p>
<p>服务端的输出如下：</p>
<p><img src="https://www.freecplus.net/runoobFiles/ueditor/image/20200922/1600748125501002008.png" alt="image.png"></p>
<h3 id="四、注意事项"><a href="#四、注意事项" class="headerlink" title="四、注意事项"></a>四、注意事项</h3><p>在 socket 通信的客户端和服务器的程序里，出现了多种数据结构，调用了多个函数，涉及到很多方面的知识，对初学者来说，更重要的是了解 socket 通信的过程、每段代码的用途和函数调用的功能，不要去纠缠这些结构体和函数的参数，这些函数和参数虽然比较多，但可以修改的非常少，别抄错就可以了，需要注意的地方我会提出。</p>
<h4 id="1、socket-文件描述符"><a href="#1、socket-文件描述符" class="headerlink" title="1、socket 文件描述符"></a>1、socket 文件描述符</h4><p>在 UNIX 系统中，一切输入输出设备皆文件，socket()函数的返回值其本质是一个文件描述符，是一个整数。</p>
<h4 id="2、服务端程序绑定地址"><a href="#2、服务端程序绑定地址" class="headerlink" title="2、服务端程序绑定地址"></a>2、服务端程序绑定地址</h4><p>如果服务器有多个网卡，多个 IP 地址，socket 通信可以指定用其中一个地址来进行通信，也可以任意 ip 地址。</p>
<p>1）指定 ip 地址的代码</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">m_servaddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span><span class="token string">"192.168.149.129"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 指定ip地址</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>2）任意 ip 地址的代码</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">m_servaddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">htonl</span><span class="token punctuation">(</span>INADDR_ANY<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 本主机的任意ip地址</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>在实际开发中，采用任意 ip 地址的方式比较多。</p>
<h4 id="3、服务端程序绑定的通信端口"><a href="#3、服务端程序绑定的通信端口" class="headerlink" title="3、服务端程序绑定的通信端口"></a>3、服务端程序绑定的通信端口</h4><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">m_servaddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 通信端口</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="4、客户端程序指定服务端的-ip-地址"><a href="#4、客户端程序指定服务端的-ip-地址" class="headerlink" title="4、客户端程序指定服务端的 ip 地址"></a>4、客户端程序指定服务端的 ip 地址</h4><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">struct</span> <span class="token class-name">hostent</span><span class="token operator">*</span> h<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>h <span class="token operator">=</span> <span class="token function">gethostbyname</span><span class="token punctuation">(</span><span class="token string">"118.89.50.198"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span>   <span class="token comment">// 指定服务端的ip地址。</span>
<span class="token punctuation">&#123;</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"gethostbyname failed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h4 id="5、客户端程序指定服务端的通信端口"><a href="#5、客户端程序指定服务端的通信端口" class="headerlink" title="5、客户端程序指定服务端的通信端口"></a>5、客户端程序指定服务端的通信端口</h4><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">servaddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="6、send-函数"><a href="#6、send-函数" class="headerlink" title="6、send 函数"></a>6、send 函数</h4><p>send 函数用于把数据通过 socket 发送给对端。不论是客户端还是服务端，应用程序都用 send 函数来向 TCP 连接的另一端发送数据。</p>
<p>函数声明：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">ssize_t <span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> size_t len<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>sockfd 为已建立好连接的 socket。</p>
<p>buf 为需要发送的数据的内存地址，可以是 C 语言基本数据类型变量的地址，也可以数组、结构体、字符串，内存中有什么就发送什么。</p>
<p>len 需要发送的数据的长度，为 buf 中有效数据的长度。</p>
<p>flags 填 0, 其他数值意义不大。</p>
<p>函数返回已发送的字符数。出错时返回-1，错误信息 errno 被标记。</p>
<p>注意，就算是网络断开，或 socket 已被对端关闭，send 函数不会立即报错，要过几秒才会报错。</p>
<p>如果 send 函数返回的错误（&lt;&#x3D;0），表示通信链路已不可用。</p>
<h4 id="7、recv-函数"><a href="#7、recv-函数" class="headerlink" title="7、recv 函数"></a>7、recv 函数</h4><p>recv 函数用于接收对端 socket 发送过来的数据。</p>
<p>recv 函数用于接收对端通过 socket 发送过来的数据。不论是客户端还是服务端，应用程序都用 recv 函数接收来自 TCP 连接的另一端发送过来数据。</p>
<p>函数声明：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">ssize_t <span class="token function">recv</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> size_t len<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>sockfd 为已建立好连接的 socket。</p>
<p>buf 为用于接收数据的内存地址，可以是 C 语言基本数据类型变量的地址，也可以数组、结构体、字符串，只要是一块内存就行了。</p>
<p>len 需要接收数据的长度，不能超过 buf 的大小，否则内存溢出。</p>
<p>flags 填 0, 其他数值意义不大。</p>
<p>函数返回已接收的字符数。出错时返回-1，失败时不会设置 errno 的值。</p>
<p>如果 socket 的对端没有发送数据，recv 函数就会等待，如果对端发送了数据，函数返回接收到的字符数。出错时返回-1。如果 socket 被对端关闭，返回值为 0。</p>
<p>如果 recv 函数返回的错误（&lt;&#x3D;0），表示通信通道已不可用。</p>
<h4 id="8、服务端有两个-socket"><a href="#8、服务端有两个-socket" class="headerlink" title="8、服务端有两个 socket"></a>8、服务端有两个 socket</h4><p>对服务端来说，有两个 socket，一个是用于监听的 socket，还有一个就是客户端连接成功后，由 accept 函数创建的用于与客户端收发报文的 socket。</p>
<h4 id="9、程序退出时先关闭-socket"><a href="#9、程序退出时先关闭-socket" class="headerlink" title="9、程序退出时先关闭 socket"></a>9、程序退出时先关闭 socket</h4><p>socket 是系统资源，操作系统打开的 socket 数量是有限的，在程序退出之前必须关闭已打开的 socket，就像关闭文件指针一样，就像 delete 已分配的内存一样，极其重要。</p>
<p>值得注意的是，关闭 socket 的代码不能只在 main 函数的最后，那是程序运行的理想状态，还应该在 main 函数的每个 return 之前关闭。</p>
<h3 id="五、相关的库函数"><a href="#五、相关的库函数" class="headerlink" title="五、相关的库函数"></a>五、相关的库函数</h3><h4 id="1、socket-函数"><a href="#1、socket-函数" class="headerlink" title="1、socket 函数"></a>1、socket 函数</h4><p>socket 函数用于创建一个新的 socket，也就是向系统申请一个 socket 资源。socket 函数用户客户端和服务端。</p>
<p>函数声明：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">socket</span><span class="token punctuation">(</span><span class="token keyword">int</span> domain<span class="token punctuation">,</span> <span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">int</span> protocol<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>参数说明：</p>
<p>domain：协议域，又称协议族（family）。常用的协议族有 AF_INET、AF_INET6、AF_LOCAL（或称 AF_UNIX，Unix 域 Socket）、AF_ROUTE 等。协议族决定了 socket 的地址类型，在通信中必须采用对应的地址，如 AF_INET 决定了要用 ipv4 地址（32 位的）与端口号（16 位的）的组合、AF_UNIX 决定了要用一个绝对路径名作为地址。</p>
<p>type：指定 socket 类型。常用的 socket 类型有 SOCK_STREAM、SOCK_DGRAM、SOCK_RAW、SOCK_PACKET、SOCK_SEQPACKET 等。流式 socket（SOCK_STREAM）是一种面向连接的 socket，针对于面向连接的 TCP 服务应用。数据报式 socket（SOCK_DGRAM）是一种无连接的 socket，对应于无连接的 UDP 服务应用。</p>
<p>protocol：指定协议。常用协议有 IPPROTO_TCP、IPPROTO_UDP、IPPROTO_STCP、IPPROTO_TIPC 等，分别对应 TCP 传输协议、UDP 传输协议、STCP 传输协议、TIPC 传输协议。</p>
<p>说了一大堆废话，第一个参数只能填 AF_INET，第二个参数只能填 SOCK_STREAM，第三个参数只能填 0。</p>
<p>除非系统资料耗尽，socket 函数一般不会返回失败。</p>
<p>返回值：成功则返回一个 socket，失败返回-1，错误原因存于 errno 中。</p>
<h4 id="2、gethostbyname-函数"><a href="#2、gethostbyname-函数" class="headerlink" title="2、gethostbyname 函数"></a>2、gethostbyname 函数</h4><p>把 ip 地址或域名转换为 hostent 结构体表达的地址。</p>
<p>函数声明：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">struct</span> <span class="token class-name">hostent</span> <span class="token operator">*</span><span class="token function">gethostbyname</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>参数 name，域名或者主机名，例如”192.168.1.3”、”<a target="_blank" rel="noopener" href="http://www.freecplus.net"等./">www.freecplus.net&quot;等。</a></p>
<p>返回值：如果成功，返回一个 hostent 结构指针，失败返回 NULL。</p>
<p>gethostbyname 只用于客户端。</p>
<p>gethostbyname 只是把字符串的 ip 地址转换为结构体的 ip 地址，只要地址格式没错，一般不会返回错误。失败时不会设置 errno 的值。</p>
<h4 id="3、connect-函数"><a href="#3、connect-函数" class="headerlink" title="3、connect 函数"></a>3、connect 函数</h4><p>向服务器发起连接请求。</p>
<p>函数声明：</p>
<pre class="line-numbers language-none"><code class="language-none">int connect(int sockfd, struct sockaddr * serv_addr, int addrlen);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>函数说明：connect 函数用于将参数 sockfd 的 socket 连至参数 serv_addr 指定的服务端，参数 addrlen 为 sockaddr 的结构长度。</p>
<p>返回值：成功则返回 0，失败返回-1，错误原因存于 errno 中。</p>
<p>connect 函数只用于客户端。</p>
<p>如果服务端的地址错了，或端口错了，或服务端没有启动，connect 一定会失败。</p>
<h4 id="4、bind-函数"><a href="#4、bind-函数" class="headerlink" title="4、bind 函数"></a>4、bind 函数</h4><p>服务端把用于通信的地址和端口绑定到 socket 上。</p>
<p>函数声明：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span>socklen_t addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>参数 sockfd，需要绑定的 socket。</p>
<p>参数 addr，存放了服务端用于通信的地址和端口。</p>
<p>参数 addrlen 表示 addr 结构体的大小。</p>
<p>返回值：成功则返回 0，失败返回-1，错误原因存于 errno 中。</p>
<p>如果绑定的地址错误，或<strong>端口已被占用</strong>，bind 函数一定会报错，否则一般不会返回错误。</p>
<h4 id="5、listen-函数"><a href="#5、listen-函数" class="headerlink" title="5、listen 函数"></a>5、listen 函数</h4><p>listen 函数把主动连接 socket 变为被动连接的 socket，使得这个 socket 可以接受其它 socket 的连接请求，从而成为一个服务端的 socket。</p>
<p>函数声明：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">listen</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">int</span> backlog<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>返回：0-成功， -1-失败</p>
<p>参数 sockfd 是已经被 bind 过的 socket。socket 函数返回的 socket 是一个主动连接的 socket，在服务端的编程中，程序员希望这个 socket 可以接受外来的连接请求，也就是被动等待客户端来连接。由于系统默认时认为一个 socket 是主动连接的，所以需要通过某种方式来告诉系统，程序员通过调用 listen 函数来完成这件事。</p>
<p>参数 backlog，这个参数涉及到一些网络的细节，比较麻烦，填 5、10 都行，一般不超过 30。</p>
<p>当调用 listen 之后，服务端的 socket 就可以调用 accept 来接受客户端的连接请求。</p>
<p>返回值：成功则返回 0，失败返回-1，错误原因存于 errno 中。</p>
<p>listen 函数一般不会返回错误。</p>
<h4 id="6、accept-函数"><a href="#6、accept-函数" class="headerlink" title="6、accept 函数"></a>6、accept 函数</h4><p>服务端接受客户端的连接。</p>
<p>函数声明：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">accept</span><span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span>socklen_t <span class="token operator">*</span>addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>参数 sockfd 是已经被 listen 过的 socket。</p>
<p>参数 addr 用于存放客户端的地址信息，用 sockaddr 结构体表达，如果不需要客户端的地址，可以填 0。</p>
<p>参数 addrlen 用于存放 addr 参数的长度，如果 addr 为 0，addrlen 也填 0。</p>
<p>accept 函数等待客户端的连接，如果没有客户端连上来，它就一直等待，这种方式称之为阻塞。</p>
<p>accept 等待到客户端的连接后，创建一个新的 socket，函数返回值就是这个新的 socket，服务端使用这个新的 socket 和客户端进行报文的收发。</p>
<p>返回值：成功则返回 0，失败返回-1，错误原因存于 errno 中。</p>
<p>accept 在等待的过程中，如果被中断或其它的原因，函数返回-1，表示失败，如果失败，可以重新 accept。</p>
<h4 id="7、函数小结"><a href="#7、函数小结" class="headerlink" title="7、函数小结"></a>7、函数小结</h4><p>服务端函数调用的流程是：socket-&gt;bind-&gt;listen-&gt;accept-&gt;<strong>recv&#x2F;send</strong>-&gt;close</p>
<p>客户端函数调用的流程是：socket-&gt;connect-&gt;<strong>send&#x2F;recv</strong>-&gt;close</p>
<p>其中<strong>send&#x2F;recv</strong>可以进行多次交互。</p>
<p>六、课后作业</p>
<p>1）把 client.cpp 和 server.cpp 抄下来，编译运行，试试修改参数再运行。</p>
<p>2）client.cpp 和 server.cpp 程序中，有些代码不能动，有些代码可以动，把能动的都动一下，就算是抄代码，也要抄个明白。</p>
<p>3）服务端的 accept 函数会阻塞，阻塞是专业名词，即等待，可以用代码测试一下。</p>
<p>4）不管是服务端还是客户端 recv 函数也会阻塞，可以用代码测试一下。</p>
<p>5）修改 client.cpp 和 server.cpp，实现点对点的聊天功能，用户在客户端输入一个字符串，然后发送给服务端，服务端收到客户端的报文后，也提示用户输入一个字符串，返回给客户端，如果服务端收到客户端的报文是“bye”通信结束。</p>
<p>6）如果以上作业都能完成，建议再把本文章的内容再看一次，对文章开始部分的理论知识将有新的理解。</p>
<p>七、版权声明</p>
<p>C 语言技术网原创文章，转载请说明文章的来源、作者和原文的链接。</p>
<p>来源：C 语言技术网（<a target="_blank" rel="noopener" href="http://www.freecplus.net/">www.freecplus.net</a>）</p>
<p>作者：码农有道</p>
<h4 id="8、经验分享"><a href="#8、经验分享" class="headerlink" title="8、经验分享"></a>8、经验分享</h4><h5 id="可以打开多少个-sock"><a href="#可以打开多少个-sock" class="headerlink" title="可以打开多少个 sock"></a>可以打开多少个 sock</h5><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">// <span class="token builtin class-name">ulimit</span> <span class="token parameter variable">-a</span> <span class="token number">1024</span> 个
ubuntu@ubuntu:~/Desktop$ <span class="token builtin class-name">ulimit</span> <span class="token parameter variable">-a</span>
core <span class="token function">file</span> size          <span class="token punctuation">(</span>blocks, -c<span class="token punctuation">)</span> <span class="token number">0</span>
data seg size           <span class="token punctuation">(</span>kbytes, -d<span class="token punctuation">)</span> unlimited
scheduling priority             <span class="token punctuation">(</span>-e<span class="token punctuation">)</span> <span class="token number">0</span>
<span class="token function">file</span> size               <span class="token punctuation">(</span>blocks, -f<span class="token punctuation">)</span> unlimited
pending signals                 <span class="token punctuation">(</span>-i<span class="token punctuation">)</span> <span class="token number">15399</span>
max locked memory       <span class="token punctuation">(</span>kbytes, -l<span class="token punctuation">)</span> <span class="token number">65536</span>
max memory size         <span class="token punctuation">(</span>kbytes, -m<span class="token punctuation">)</span> unlimited
<span class="token function">open</span> files                      <span class="token punctuation">(</span>-n<span class="token punctuation">)</span> <span class="token number">1024</span>
pipe size            <span class="token punctuation">(</span><span class="token number">512</span> bytes, -p<span class="token punctuation">)</span> <span class="token number">8</span>
POSIX message queues     <span class="token punctuation">(</span>bytes, -q<span class="token punctuation">)</span> <span class="token number">819200</span>
real-time priority              <span class="token punctuation">(</span>-r<span class="token punctuation">)</span> <span class="token number">0</span>
stack size              <span class="token punctuation">(</span>kbytes, -s<span class="token punctuation">)</span> <span class="token number">8192</span>
cpu <span class="token function">time</span>               <span class="token punctuation">(</span>seconds, -t<span class="token punctuation">)</span> unlimited
max user processes              <span class="token punctuation">(</span>-u<span class="token punctuation">)</span> <span class="token number">15399</span>
virtual memory          <span class="token punctuation">(</span>kbytes, -v<span class="token punctuation">)</span> unlimited
<span class="token function">file</span> locks                      <span class="token punctuation">(</span>-x<span class="token punctuation">)</span> unlimited

// 修改为 <span class="token number">2000</span> 个
ubuntu@ubuntu:~/Desktop$ <span class="token builtin class-name">ulimit</span> <span class="token parameter variable">-HSn</span> <span class="token number">2000</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="设置服务端-socket-的-SO-REUSEADDR-属性"><a href="#设置服务端-socket-的-SO-REUSEADDR-属性" class="headerlink" title="设置服务端 socket 的 SO_REUSEADDR 属性"></a>设置服务端 socket 的 SO_REUSEADDR 属性</h5><p>服努端程序的端口释放后可能会处于 TIME WAIT 状态，等待两分钟之后才能再被使用 SO_REUSEADDR 是让端口释放后立即就可以被再次使用。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// 设置 SO_REUSEADDR选项</span>
<span class="token keyword">int</span> opt<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">int</span> len<span class="token operator">=</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>opt<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setsockopt</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> SOL_SOCKET<span class="token punctuation">,</span> SO_REUSEADDR<span class="token punctuation">,</span> <span class="token operator">&amp;</span>opt<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="查看系统进程连接情况"><a href="#查看系统进程连接情况" class="headerlink" title="查看系统进程连接情况"></a>查看系统进程连接情况</h5><p><code>netstat -na</code></p>
<h3 id="六、主机字节序与网络字节序"><a href="#六、主机字节序与网络字节序" class="headerlink" title="六、主机字节序与网络字节序"></a>六、主机字节序与网络字节序</h3><ul>
<li><p><strong>字节顺序</strong>：</p>
<ul>
<li>是指占内存多于一个字节类型的数据在内存中的存放顺序，一个 32 位整数由 4 个字节组成。內存中存储这 4 个字节有两种方法：一种是将低序字节存储在起始地址，这称为小端（little-endian）字节序；另一种方法是将高序字节存储在起始地址，这称为大端（big-endian）字节序。</li>
</ul>
<p><img src="/C_C++%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%EF%BC%8C%E4%BB%8Esocket%E5%88%B0epoll.assets/image-20210705144109361.png" alt="image-20210705144109361"></p>
<ul>
<li>这两种字节序之间没有标准可循，两种格式都有系统使用。比如，Inter x86、ARM 核采用的是小端模式，Power pc、MIPS UNIX 和 HP-PA UNIX 釆用大端模式。<br>大于一个字节类型的数据在内存中的存放有顺序，一个字节的数据没有顺序的问题</li>
</ul>
</li>
<li><p><strong>网络字节序</strong>：网络字节序是 TCP&#x2F;P 中规定好的一种数据表示格式，它与具体的 CPU 类型、操作系统等无关，从而可以保证数据在不同主机之间传输时能够被正确解释。网络字节序采用 big endian 排序方式</p>
</li>
<li><p><strong>主机字节序</strong>：不同的机器主机字节序不相同，与 CPU 设计有关，数据的顺序是由 cpu 决定的，而与操作系统无关。</p>
</li>
<li><p>由于这个原因不同体系结构的机器之间无法通信，所以要转换成一种约定的字节序，也就是网络字节序。即使是同一台机器上的两个进程（比如一个由 C 语言，另一个由 Java 编写）通信，也要考虑字节序的问题（VM 采用大端字节序）。</p>
</li>
<li><p>网络字节序与主机字节序之间的转换函数：</p>
<ul>
<li><code>hons()，、ntohs()、htonl()、ntohl()</code></li>
<li>htons 和 ntohs 完成 16 位无符号数的相互转换，</li>
<li>htonl 和 ntohl 完成 32 位无符号数的相互转换。host to network short long</li>
</ul>
</li>
</ul>
<h3 id="七、结构体"><a href="#七、结构体" class="headerlink" title="七、结构体"></a>七、结构体</h3><h4 id="socket"><a href="#socket" class="headerlink" title="socket"></a>socket</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">short</span> sa_family<span class="token punctuation">;</span>
  <span class="token keyword">char</span> sa_data<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">short</span> <span class="token keyword">int</span> sin_family<span class="token punctuation">;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token keyword">int</span> sin_port<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">in</span> addr sin_addr<span class="token punctuation">;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> sin_zero<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span>
<span class="token keyword">struct</span> <span class="token class-name">in</span> addr<span class="token punctuation">&#123;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> s_addr<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="bind"><a href="#bind" class="headerlink" title="bind"></a>bind</h4><p>强制转换为老的 sockaddr</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">bind</span> <span class="token punctuation">(</span><span class="token keyword">int</span> sockfd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> <span class="token class-name">socklen_t</span> addr len<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="gethostbyname"><a href="#gethostbyname" class="headerlink" title="gethostbyname"></a>gethostbyname</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">hostent</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">char</span><span class="token operator">*</span> h_name<span class="token punctuation">;</span> <span class="token comment">//主机名</span>
	<span class="token keyword">char</span><span class="token operator">*</span>h_aliases<span class="token punctuation">;</span> <span class="token comment">//主机所有别名构成的字符串数组，同一P可绑定多个域名int h 		int h_addrtype; //主机P地址的类型，例如PV4（AF INET）还是PV6</span>
	<span class="token keyword">int</span> h_length<span class="token punctuation">;</span> <span class="token comment">//主机IP地址长度，IPV4地址为4，IPV6地址则为16</span>
 	<span class="token keyword">char</span><span class="token operator">*</span>h addr_list<span class="token punctuation">;</span> <span class="token comment">//主机的jp地址，以网络字节序存储。</span>
<span class="token punctuation">&#125;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">h_addr</span> <span class="token expression">h_addr_list<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></span><span class="token comment">/*for backward compatibility*/</span></span>

<span class="token comment">// gethostbyname函数可以利用字符串格式的域名获得IP网络字节顺序地址。</span>
<span class="token keyword">struct</span> <span class="token class-name">hostent</span><span class="token operator">*</span><span class="token function">gethostbyname</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span>name<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol>
<li>将一个字符串 IP 地址转换为一个 32 位的网络字节序 IP 地址。如果这个函数成功，函数的返回值非零，如果输入地址不正确则会返回零。使用这个函数并没有错误码存放在 errno 中，所以它的值会被忽略</li>
<li>把网络字节序 IP 地址转换成字符串的 IP 地址。</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> inet_aton（<span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span>cp，<span class="token keyword">struct</span> <span class="token class-name">in_addr</span><span class="token operator">*</span>inp）<span class="token punctuation">;</span>

<span class="token keyword">char</span><span class="token operator">*</span>inet_ntoa（<span class="token keyword">struct</span> <span class="token class-name">in_addr</span> in）；

<span class="token class-name">in_addr_t</span> inet_addr（<span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span>cp）；<span class="token comment">// 和第一个相同</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="listen、connect、accept"><a href="#listen、connect、accept" class="headerlink" title="listen、connect、accept"></a>listen、connect、accept</h4><p>返回新的 socket，生成队列。</p>
<p>accept 从队列中获取一个</p>
<p>1）服务端在调用 llisten0 之前，客户端不能向服务端发起连接请求的</p>
<p>2）服务端调用 listen0 函数后，服务端的 socke 开始监听客户端的连接</p>
<p>3）客户端调用 connect0 函数向服务端发起连接请求</p>
<p>4）在 cP 底层，客户端和服务端握手后建立起通信通道，如果有多个客户端请求，在服务端就会形成一个已准备好的连接的队列</p>
<p>5）服务端调用 accept0 函数从队列中获取一个已准备好的连接，函数返回一个新的 socket，新的 socket 用于与客户端通信，listen 的 socket 只负责监听客户端的连接请求。</p>
<h4 id="listen-的-socket-队列"><a href="#listen-的-socket-队列" class="headerlink" title="listen 的 socket 队列"></a>listen 的 socket 队列</h4><ul>
<li>内核会为 ten 状态的 socket 维护两个队列：不完全连接请求队列（SYN RECV 状态）<br>和等待 acep 建立 socke 的队列（ESTABLISHED 状态）</li>
<li>在 linux 内核 22 之后，backlog 参数的形为改变了，现在它指等待 accept 的完全建立的 socket 的队列长度，而不是不完全连接请求的数量。不完全连接队列的长度可以使用<br>&#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_max_syn_backlog 设置（缺省值 128）</li>
<li>backlog 参数如果比&#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp max syn backlog，则截断</li>
</ul>
<h3 id="八、TCP-报文分包和粘包"><a href="#八、TCP-报文分包和粘包" class="headerlink" title="八、TCP 报文分包和粘包"></a>八、TCP 报文分包和粘包</h3><p>分包：发送方发送字符串”helloworld”，接收方却接收到了两个字符串”hello 和”world 粘包：发送方发送两个字符串”hello”+”world”，接收方却一次性接收到了”helloworld”<br>但是 TcP 传输数据能保证几点：<br>1）顺序不变，例如发送方发送 hell，接收方也一定顺序接收到 helo，这个是 TCP 协议承诺的，因此这点成为我们解决分包和粘包问题的关键</p>
<p>2）分割的包中间不会插入其他数据。<br>在实际开发中，为了解决分包和粘包的问题，就一定要自定义一份协议，最常用的方一法是<br>报文长度+报文内容<code>0010helloworld</code> 报文长度 asci 码，二进制的数字</p>
<h3 id="九、socket-封装"><a href="#九、socket-封装" class="headerlink" title="九、socket 封装"></a>九、socket 封装</h3><p>用于解决分包和粘包，封装成类。</p>
<h3 id="十、多进程的-socket-服务端"><a href="#十、多进程的-socket-服务端" class="headerlink" title="十、多进程的 socket 服务端"></a>十、多进程的 socket 服务端</h3><p>基础：</p>
<ol>
<li>信号；</li>
<li>多进程；</li>
</ol>
<h4 id="一、搭建"><a href="#一、搭建" class="headerlink" title="一、搭建"></a>一、搭建</h4><h4 id="二、僵尸进程"><a href="#二、僵尸进程" class="headerlink" title="二、僵尸进程"></a>二、僵尸进程</h4><h4 id="三、增加业务逻辑"><a href="#三、增加业务逻辑" class="headerlink" title="三、增加业务逻辑"></a>三、增加业务逻辑</h4><ol>
<li>xml 登录和身份验证</li>
</ol>
<h4 id="四、TCP-长连接与短连接"><a href="#四、TCP-长连接与短连接" class="headerlink" title="四、TCP 长连接与短连接"></a>四、TCP 长连接与短连接</h4><ol>
<li>client 与 server 建立连接进行通信，通信完成后释放连接，建立连接时需要 3 次握手，释放连接需要 4 次挥手，连接的建立和释放都需要时间，server 还有创建新进程或线程的开销。<ol>
<li>短连接：client&#x2F;server 间只进行一次或连续多次通信，通信完成后马上断开了。管理起来比较简单，不需要额外的控制手段。</li>
<li>长连接：client&#x2F;server 间需要多次通信，通信的频率和次数不确定，所以 client 和 server 需要保持这个连接。<br>根据不同的应用场景采用不同的策略，没有十全十美的选择，只有合适的选择</li>
</ol>
</li>
</ol>
<h3 id="十一、网络服务端性能测试"><a href="#十一、网络服务端性能测试" class="headerlink" title="十一、网络服务端性能测试"></a>十一、网络服务端性能测试</h3><ol>
<li><p>在实际项目开发中，除了完成程序的功能，还需要测试性能。</p>
<ol>
<li>在充分了解服务端的性能后，才能决定如何选择服务端的架构，还有网络带宽、硬件配置等。</li>
<li>服务端的性能指标是面试中必问的。</li>
<li>如果不了解系统的性能指标，面试官会认为您没有实际项目开发经验或对网络编程是一知半解。主要的性能指标如下：<ol>
<li>1）服务端的并发能力；</li>
<li>2）服务端的业务处理能力</li>
<li>3）客户端业务响应时效；</li>
<li>4）网络带宽。</li>
</ol>
</li>
</ol>
<p>重要的业务系统，最好是与系统管理员和网络管理员一起测试。</p>
</li>
</ol>
<h4 id="一、并发性能测试"><a href="#一、并发性能测试" class="headerlink" title="一、并发性能测试"></a>一、并发性能测试</h4><h4 id="二、业务性能测试"><a href="#二、业务性能测试" class="headerlink" title="二、业务性能测试"></a>二、业务性能测试</h4><h4 id="三、多进程与多线程性能差异"><a href="#三、多进程与多线程性能差异" class="headerlink" title="三、多进程与多线程性能差异"></a>三、多进程与多线程性能差异</h4><h4 id="四、响应时间"><a href="#四、响应时间" class="headerlink" title="四、响应时间"></a>四、响应时间</h4><h4 id="五、带宽"><a href="#五、带宽" class="headerlink" title="五、带宽"></a>五、带宽</h4><h3 id="十二、I-x2F-O-复用"><a href="#十二、I-x2F-O-复用" class="headerlink" title="十二、I&#x2F;O 复用"></a>十二、I&#x2F;O 复用</h3><ol>
<li>多进程&#x2F;线程并发模型，为每个 socket 分配一个进程&#x2F;线程。</li>
<li>I&#x2F;O（多路）复用，采用单个进&#x2F;线程就可以管理多个 socket<ol>
<li>网络设备（交换机、路由器）；</li>
<li>大型游戏的后台</li>
<li>nginx、redis</li>
</ol>
</li>
<li>l&#x2F;O 复用有三种方案：select、poll、epoll，各有优缺点，select 并不是一定就不行，epoll 也不是什么都好，各有应用场景，必须全部掌握。</li>
</ol>
<h4 id="一、select"><a href="#一、select" class="headerlink" title="一、select"></a>一、select</h4><p><img src="/C_C++%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%EF%BC%8C%E4%BB%8Esocket%E5%88%B0epoll.assets/image-20210705224417795.png" alt="image-20210705224417795"></p>
<p><img src="/C_C++%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%EF%BC%8C%E4%BB%8Esocket%E5%88%B0epoll.assets/image-20210705235241828.png" alt="image-20210705235241828"></p>
<ul>
<li>select 的水平触发<ul>
<li>selec 采用“水平触发”的方式，如果报告了 fd 后事件没有被处理或数据没有被全部读取，那么下次 select 时会再次报告该 fd。</li>
</ul>
</li>
<li>select 的缺点<ol>
<li>1）select 支持的文件描述符数量太小了，默认是 1024，虽然可以调整，但是，描述符数量越大，效率将更低，调整的意义不大。</li>
<li>2）每次调用 select，都需要把 fdset 从用户态拷贝到内核。</li>
<li>3）同时在线的大量客户端有事件发生的可能很少，但还是需要遍历 feet，因此随着监视的描述符数量的增长，其效率也会线性下降。</li>
</ol>
</li>
<li>select 的其它用途<ul>
<li>在 unⅸ（Linux）世界里，一切皆文件，文件就是一串二进制流，不管 socket、管道、終端、设备等都是文件，一切都是流。在信息交换的过程中，都是对这些流进行数据的收发操作，简称为 Ⅳ◎ 操作 input and output），往流中读出数据，系统调用 read，写入数据，系统调用 write</li>
<li>select 是 io 复用函数，除了用于网络通信，还可以用于文件、管道、终端、设备等操作，但开发场景比较少。<br>了解 pselect 函数。</li>
</ul>
</li>
</ul>
<h4 id="二、poll"><a href="#二、poll" class="headerlink" title="二、poll"></a>二、poll</h4><ol>
<li><p>poll 模型</p>
<ul>
<li>poll 和 select 在本质上没有差别，管理多个描述符也是进行轮询，根据描述符的状态进行处理，但是 poll 没有最大文件描述符数量的限制。</li>
<li>select 用 fdset 采用 bitmap，poll 用了<strong>数组</strong>。</li>
<li>poll 和 select 同样存在一个缺点就是，文件描述符的数组被整体复制于用户态和内核态的地址空间之间，而不论这些文件描述符是否有事件，它的开销随着文件描述符数量的增加而线性增大。</li>
<li>还有 poll 返回后，也需要历遍整个描述符的数组才能得到有事件的描述符。</li>
</ul>
</li>
<li><p>poll 函数和参数</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;poll.h></span></span>
<span class="token keyword">int</span> <span class="token function">poll</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pollfd</span> <span class="token operator">*</span>fdarray<span class="token punctuation">,</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> nfds<span class="token punctuation">,</span><span class="token keyword">int</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">pollfd</span><span class="token punctuation">&#123;</span>
 <span class="token keyword">int</span> fd<span class="token punctuation">;</span>                  <span class="token comment">//需要检测的文件描述符</span>
 <span class="token keyword">short</span> events<span class="token punctuation">;</span>            <span class="token comment">//请求的事件</span>
 <span class="token keyword">short</span> revents<span class="token punctuation">;</span>           <span class="token comment">//返回的事件</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol>
<li><p>返回：若有就绪描述符则为其数目，若超时返回 0，出错返回-1</p>
<p>第一个参数是指向一个结构体数组第一个元素的指针。每个元素都是一个 pollfd 结构，用于指定测试某个给定描述符 fd 的条件</p>
</li>
</ol>
</li>
<li><p>下表说明了能够作为 events 和 revents 的常量</p>
<p><img src="https://pic4.zhimg.com/80/v2-ffc0e68af82b0873a6794a4296e602eb_720w.jpg" alt="img"></p>
<p>结构体数组中元素的个数是由 nfds 参数指定。</p>
<p>timeout 参数指定 poll 函数返回前等待多长时间。它是一个指定应等待毫秒数的正值。取值如下表：</p>
<p>timeout 值说明-1 永远等待，直到有描述符就绪 0 立即返回，不阻塞进程&gt;0 等待指定的毫秒数</p>
<p>使用 poll 函数建立的服务器端如下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//</span>
<span class="token comment">// Created by silver on 2020/8/23.</span>
<span class="token comment">//</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/unistd.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/select.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;poll.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stropts.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAXLINE</span> <span class="token expression"><span class="token number">4096</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PORT</span> <span class="token expression"><span class="token number">9873</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LISTQUE</span> <span class="token expression"><span class="token number">1024</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OPEN_MAX</span> <span class="token expression"><span class="token number">256</span></span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> listenfd<span class="token punctuation">,</span>confd<span class="token punctuation">,</span>sockfd<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">pollfd</span> client<span class="token punctuation">[</span>OPEN_MAX<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> nready<span class="token punctuation">;</span>
    <span class="token keyword">int</span> maxcount <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span>MAXLINE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> SerAddr<span class="token punctuation">,</span>Cliaddr<span class="token punctuation">;</span>
    <span class="token class-name">socklen_t</span> Clilen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>Cliaddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//initializer</span>
    <span class="token function">bzero</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>SerAddr<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>SerAddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">bzero</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Cliaddr<span class="token punctuation">,</span>Clilen<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">bzero</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span>MAXLINE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    listenfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span>SOCK_STREAM<span class="token punctuation">,</span>IPPROTO_IP<span class="token punctuation">)</span><span class="token punctuation">;</span>
    SerAddr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    SerAddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>PORT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    SerAddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">htonl</span><span class="token punctuation">(</span>INADDR_ANY<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">bind</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>SerAddr<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>SerAddr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"Bind error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">listen</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span>LISTQUE<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"listen error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    client<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> listenfd<span class="token punctuation">;</span>
    client<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">=</span> POLLRDNORM<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>count <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> count <span class="token operator">&lt;</span> OPEN_MAX<span class="token punctuation">;</span> count<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        client<span class="token punctuation">[</span>count<span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    maxcount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">ssize_t</span>  n<span class="token punctuation">;</span>
    <span class="token function">fputs</span><span class="token punctuation">(</span><span class="token string">"server waiting...."</span><span class="token punctuation">,</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>true<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        nready <span class="token operator">=</span> <span class="token function">poll</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span>maxcount <span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>client<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>revents <span class="token operator">&amp;</span> POLLRDNORM<span class="token punctuation">)</span> <span class="token comment">// new client connection</span>
        <span class="token punctuation">&#123;</span>
            confd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>Cliaddr<span class="token punctuation">,</span><span class="token operator">&amp;</span>Clilen<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"client address: %s\n"</span><span class="token punctuation">,</span><span class="token function">inet_ntoa</span><span class="token punctuation">(</span>Cliaddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>confd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"accept error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span>count <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  count<span class="token operator">&lt;</span>OPEN_MAX <span class="token punctuation">;</span> count<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>client<span class="token punctuation">[</span>count<span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">&#123;</span>
                    client<span class="token punctuation">[</span>count<span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> confd<span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> OPEN_MAX<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"too many clients"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>

            client<span class="token punctuation">[</span>count<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">=</span> POLLRDNORM<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">></span> maxcount<span class="token punctuation">)</span> maxcount <span class="token operator">=</span> count<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>nready <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span> <span class="token comment">//no more readable descriptions</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>count <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> count <span class="token operator">&lt;=</span>maxcount <span class="token punctuation">;</span> count<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sockfd <span class="token operator">=</span> client<span class="token punctuation">[</span>maxcount<span class="token punctuation">]</span><span class="token punctuation">.</span>fd<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token keyword">continue</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>client<span class="token punctuation">[</span>count<span class="token punctuation">]</span><span class="token punctuation">.</span>revents <span class="token operator">&amp;</span> <span class="token punctuation">(</span>POLLRDNORM <span class="token operator">|</span> POLLERR<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                n <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span>buf<span class="token punctuation">,</span>MAXLINE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> ECONNRESET<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        client<span class="token punctuation">[</span>count<span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"read error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                    <span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    client<span class="token punctuation">[</span>count<span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span><span class="token punctuation">&#123;</span>
                    <span class="token function">writen</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span>buf<span class="token punctuation">,</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>nready <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">//no more readable descriptions</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>编辑于 2020-09-12</p>
</li>
</ol>
<h4 id="三、epoll"><a href="#三、epoll" class="headerlink" title="三、epoll"></a>三、epoll</h4><p>epoll 解决了 select 和 poll 所有的问题（fdset 拷贝和轮询），采用了最合理的设计和实现方案。</p>
<p>epoll 在现在的软件中占据了很大的分量，nginx，libuv 等单线程事件循环的软件都使用了 epoll。之前分析过 select，今天分析一下 epoll。</p>
<p>们按照 epoll 三部曲的顺序进行分析。</p>
<h5 id="epoll-create"><a href="#epoll-create" class="headerlink" title="epoll_create"></a><strong>epoll_create</strong></h5><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">asmlinkage <span class="token keyword">long</span> <span class="token function">sys_epoll_create</span><span class="token punctuation">(</span><span class="token keyword">int</span> size<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> error<span class="token punctuation">,</span> fd<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">;</span>

    error <span class="token operator">=</span> <span class="token function">ep_getfd</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>inode<span class="token punctuation">,</span> <span class="token operator">&amp;</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
    error <span class="token operator">=</span> <span class="token function">ep_file_init</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> fd<span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>我们发现 create 函数似乎很简单。<br>1 操作系统中，进程和文件系统是通过 fd&#x3D;&gt;file&#x3D;&gt;node 联系起来的。ep_getfd 就是在建立这个联系。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ep_getfd</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span>efd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span><span class="token operator">*</span>einode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token operator">*</span>efile<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>

    <span class="token comment">// 获取一个file结构体</span>
    file <span class="token operator">=</span> <span class="token function">get_empty_filp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// epoll在底层本身对应一个文件系统，从这个文件系统中获取一个inode</span>
    inode <span class="token operator">=</span> <span class="token function">ep_eventpoll_inode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取一个文件描述符</span>
    fd <span class="token operator">=</span> <span class="token function">get_unused_fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">sprintf</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">"[%lu]"</span><span class="token punctuation">,</span> inode<span class="token operator">-></span>i_ino<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>hash <span class="token operator">=</span> inode<span class="token operator">-></span>i_ino<span class="token punctuation">;</span>
    <span class="token comment">// 申请一个entry</span>
    dentry <span class="token operator">=</span> <span class="token function">d_alloc</span><span class="token punctuation">(</span>eventpoll_mnt<span class="token operator">-></span>mnt_sb<span class="token operator">-></span>s_root<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dentry<span class="token operator">-></span>d_op <span class="token operator">=</span> <span class="token operator">&amp;</span>eventpollfs_dentry_operations<span class="token punctuation">;</span>
    file<span class="token operator">-></span>f_dentry <span class="token operator">=</span> dentry<span class="token punctuation">;</span>

    <span class="token comment">// 建立file和inode的联系</span>
    <span class="token function">d_add</span><span class="token punctuation">(</span>dentry<span class="token punctuation">,</span> inode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 建立fd=>file的关联</span>
    <span class="token function">fd_install</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token operator">*</span>efd <span class="token operator">=</span> fd<span class="token punctuation">;</span>
    <span class="token operator">*</span>einode <span class="token operator">=</span> inode<span class="token punctuation">;</span>
    <span class="token operator">*</span>efile <span class="token operator">=</span> file<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>形成一个这种的结构。</p>
<p>2 通过 ep_file_init 建立 file 和 epoll 的关联。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ep_file_init</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">struct</span> <span class="token class-name">eventpoll</span> <span class="token operator">*</span>ep<span class="token punctuation">;</span>

    ep <span class="token operator">=</span> <span class="token function">kmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">eventpoll</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>ep<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>ep<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 一系列初始化</span>
    file<span class="token operator">-></span>private_data <span class="token operator">=</span> ep<span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>epoll_create 函数主要是建立一个数据结构。并返回一个文件描述符供后面使用。</p>
<h5 id="epoll-ctl"><a href="#epoll-ctl" class="headerlink" title="epoll_ctl"></a><strong>epoll_ctl</strong></h5><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">asmlinkage <span class="token keyword">long</span>
<span class="token function">sys_epoll_ctl</span><span class="token punctuation">(</span><span class="token keyword">int</span> epfd<span class="token punctuation">,</span> <span class="token keyword">int</span> op<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> __user <span class="token operator">*</span>event<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> error<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">,</span> <span class="token operator">*</span>tfile<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">eventpoll</span> <span class="token operator">*</span>ep<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">epitem</span> <span class="token operator">*</span>epi<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> epds<span class="token punctuation">;</span>

    error <span class="token operator">=</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
    <span class="token comment">// 不是删除操作则复制用户数据到内核</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
        <span class="token function">EP_OP_HASH_EVENT</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token function">copy_from_user</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>epds<span class="token punctuation">,</span> event<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">epoll_event</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
        <span class="token keyword">goto</span> eexit_1<span class="token punctuation">;</span>

    <span class="token comment">// 根据一种的图，拿到epoll对应的file结构体</span>
    file <span class="token operator">=</span> <span class="token function">fget</span><span class="token punctuation">(</span>epfd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 拿到操作的文件的file结构体</span>
    tfile <span class="token operator">=</span> <span class="token function">fget</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 通过file拿到epoll_event结构体，见上面的图</span>
    ep <span class="token operator">=</span> file<span class="token operator">-></span>private_data<span class="token punctuation">;</span>
    <span class="token comment">// 看这个文件描述符是否已经存在，epoll用红黑树维护这个数据</span>
    epi <span class="token operator">=</span> <span class="token function">ep_find</span><span class="token punctuation">(</span>ep<span class="token punctuation">,</span> tfile<span class="token punctuation">,</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>op<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 新增</span>
    <span class="token keyword">case</span> EPOLL_CTL_ADD<span class="token operator">:</span>
        <span class="token comment">// 还没有则新增，有则报错</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>epi<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            epds<span class="token punctuation">.</span>events <span class="token operator">|=</span> POLLERR <span class="token operator">|</span> POLLHUP<span class="token punctuation">;</span>
            <span class="token comment">// 插入红黑树</span>
            error <span class="token operator">=</span> <span class="token function">ep_insert</span><span class="token punctuation">(</span>ep<span class="token punctuation">,</span> <span class="token operator">&amp;</span>epds<span class="token punctuation">,</span> tfile<span class="token punctuation">,</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span>
            error <span class="token operator">=</span> <span class="token operator">-</span>EEXIST<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token comment">// 删除</span>
    <span class="token keyword">case</span> EPOLL_CTL_DEL<span class="token operator">:</span>
        <span class="token comment">// 存在则删除，否则报错</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>epi<span class="token punctuation">)</span>
            error <span class="token operator">=</span> <span class="token function">ep_remove</span><span class="token punctuation">(</span>ep<span class="token punctuation">,</span> epi<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            error <span class="token operator">=</span> <span class="token operator">-</span>ENOENT<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token comment">// 修改</span>
    <span class="token keyword">case</span> EPOLL_CTL_MOD<span class="token operator">:</span>
        <span class="token comment">// 存在则修改，否则报错</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>epi<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            epds<span class="token punctuation">.</span>events <span class="token operator">|=</span> POLLERR <span class="token operator">|</span> POLLHUP<span class="token punctuation">;</span>
            error <span class="token operator">=</span> <span class="token function">ep_modify</span><span class="token punctuation">(</span>ep<span class="token punctuation">,</span> epi<span class="token punctuation">,</span> <span class="token operator">&amp;</span>epds<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span>
            error <span class="token operator">=</span> <span class="token operator">-</span>ENOENT<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>epoll_ctl 函数看起来也没有很复杂，就是根据用户传进来的信息去操作红黑树。对于红黑树的增删改查，查和删除就不分析了。就是去操作红黑树。增和改是类似的逻辑，所以我们只分析增操作就可以了。在此之前，我们先了解一些 epoll 中其他的数据结构。</p>
<p>当我们新增一个需要监听的文件描述符的时候，系统会申请一个 epitem 去表示。epitem 是保存了文件描述符、事件等信息的结构体。然后把 epitem 插入到 eventpoll 结构体维护的红黑树中。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ep_insert</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">eventpoll</span> <span class="token operator">*</span>ep<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> <span class="token operator">*</span>event<span class="token punctuation">,</span>
             <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>tfile<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> error<span class="token punctuation">,</span> revents<span class="token punctuation">,</span> pwake <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> flags<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">epitem</span> <span class="token operator">*</span>epi<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">ep_pqueue</span> epq<span class="token punctuation">;</span>

    <span class="token comment">// 申请一个epitem</span>
    epi <span class="token operator">=</span> <span class="token function">EPI_MEM_ALLOC</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 省略一系列初始化工作</span>
    <span class="token comment">// 记录所属的epoll</span>
    epi<span class="token operator">-></span>ep <span class="token operator">=</span> ep<span class="token punctuation">;</span>
    <span class="token comment">// 在epitem中保存文件描述符fd和file</span>
    <span class="token function">EP_SET_FFD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>epi<span class="token operator">-></span>ffd<span class="token punctuation">,</span> tfile<span class="token punctuation">,</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 监听的事件</span>
    epi<span class="token operator">-></span>event <span class="token operator">=</span> <span class="token operator">*</span>event<span class="token punctuation">;</span>
    epi<span class="token operator">-></span>nwait <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    epq<span class="token punctuation">.</span>epi <span class="token operator">=</span> epi<span class="token punctuation">;</span>
    <span class="token function">init_poll_funcptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>epq<span class="token punctuation">.</span>pt<span class="token punctuation">,</span> ep_ptable_queue_proc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    revents <span class="token operator">=</span> tfile<span class="token operator">-></span>f_op<span class="token operator">-></span><span class="token function">poll</span><span class="token punctuation">(</span>tfile<span class="token punctuation">,</span> <span class="token operator">&amp;</span>epq<span class="token punctuation">.</span>pt<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 把epitem插入红黑树</span>
    <span class="token function">ep_rbtree_insert</span><span class="token punctuation">(</span>ep<span class="token punctuation">,</span> epi<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 如果监听的事件在新增的时候就已经触发，则直接插入到epoll就绪队列</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>revents <span class="token operator">&amp;</span> event<span class="token operator">-></span>events<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">EP_IS_LINKED</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>epi<span class="token operator">-></span>rdllink<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 把epitem插入就绪队列rdllist</span>
        <span class="token function">list_add_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>epi<span class="token operator">-></span>rdllink<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ep<span class="token operator">-></span>rdllist<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//  有事件触发，唤醒阻塞在epoll_wait的进程队列</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">waitqueue_active</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ep<span class="token operator">-></span>wq<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">wake_up</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ep<span class="token operator">-></span>wq<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">waitqueue_active</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ep<span class="token operator">-></span>poll_wait<span class="token punctuation">)</span><span class="token punctuation">)</span>
            pwake<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>新增操作的大致流程是<br>1 申请了一个新的 epitem 表示待观察的实体。他保存了文件描述符、感兴趣的事件等信息。<br>2 插入红黑树<br>3 判断新增的节点中对应的文件描述符和事件是否已经触发了，是则加入到就绪队列（由 eventpoll-&gt;rdllist 维护的一个队列）<br>下面具体看一下如何判断感兴趣的事件在对应的文件描述符中是否已经触发。相关代码在 ep_insert 中。下面单独拎出来。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">/*
    struct ep_pqueue &#123;
        // 函数指针
        poll_table pt;
        // epitem
        struct epitem *epi;
    &#125;;
*/</span>
<span class="token keyword">struct</span> <span class="token class-name">ep_pqueue</span> epq<span class="token punctuation">;</span>
epq<span class="token punctuation">.</span>epi <span class="token operator">=</span> epi<span class="token punctuation">;</span>
<span class="token function">init_poll_funcptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>epq<span class="token punctuation">.</span>pt<span class="token punctuation">,</span> ep_ptable_queue_proc<span class="token punctuation">)</span><span class="token punctuation">;</span>
revents <span class="token operator">=</span> tfile<span class="token operator">-></span>f_op<span class="token operator">-></span><span class="token function">poll</span><span class="token punctuation">(</span>tfile<span class="token punctuation">,</span> <span class="token operator">&amp;</span>epq<span class="token punctuation">.</span>pt<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">init_poll_funcptr</span><span class="token punctuation">(</span>poll_table <span class="token operator">*</span>pt<span class="token punctuation">,</span> poll_queue_proc qproc<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    pt<span class="token operator">-></span>qproc <span class="token operator">=</span> qproc<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上面的代码是定义了一个 struct ep_pqueue 结构体，然后设置他的一个字段为 ep_ptable_queue_proc。然后执行 tfile-&gt;f_op-&gt;poll。poll 函数由各个文件系统或者网络协议实现。我们以管道为例。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span>
<span class="token function">pipe_poll</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> poll_table <span class="token operator">*</span>wait<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> mask<span class="token punctuation">;</span>
    <span class="token comment">// 监听的文件描述符对应的inode</span>
    <span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>inode <span class="token operator">=</span> filp<span class="token operator">-></span>f_dentry<span class="token operator">-></span>d_inode<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">pipe_inode_info</span> <span class="token operator">*</span>info <span class="token operator">=</span> inode<span class="token operator">-></span>i_pipe<span class="token punctuation">;</span>
    <span class="token keyword">int</span> nrbufs<span class="token punctuation">;</span>
    <span class="token comment">/*
    static inline void poll_wait(struct file * filp, wait_queue_head_t * wait_address, poll_table *p)
    &#123;
        if (p &amp;&amp; wait_address)
            p->qproc(filp, wait_address, p);
    &#125;
    */</span>
    <span class="token function">poll_wait</span><span class="token punctuation">(</span>filp<span class="token punctuation">,</span> <span class="token function">PIPE_WAIT</span><span class="token punctuation">(</span><span class="token operator">*</span>inode<span class="token punctuation">)</span><span class="token punctuation">,</span> wait<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 判断哪些事件触发了</span>
    nrbufs <span class="token operator">=</span> info<span class="token operator">-></span>nrbufs<span class="token punctuation">;</span>
    mask <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>filp<span class="token operator">-></span>f_mode <span class="token operator">&amp;</span> FMODE_READ<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        mask <span class="token operator">=</span> <span class="token punctuation">(</span>nrbufs <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> POLLIN <span class="token operator">|</span> POLLRDNORM <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">PIPE_WRITERS</span><span class="token punctuation">(</span><span class="token operator">*</span>inode<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> filp<span class="token operator">-></span>f_version <span class="token operator">!=</span> <span class="token function">PIPE_WCOUNTER</span><span class="token punctuation">(</span><span class="token operator">*</span>inode<span class="token punctuation">)</span><span class="token punctuation">)</span>
            mask <span class="token operator">|=</span> POLLHUP<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>filp<span class="token operator">-></span>f_mode <span class="token operator">&amp;</span> FMODE_WRITE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        mask <span class="token operator">|=</span> <span class="token punctuation">(</span>nrbufs <span class="token operator">&lt;</span> PIPE_BUFFERS<span class="token punctuation">)</span> <span class="token operator">?</span> POLLOUT <span class="token operator">|</span> POLLWRNORM <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">PIPE_READERS</span><span class="token punctuation">(</span><span class="token operator">*</span>inode<span class="token punctuation">)</span><span class="token punctuation">)</span>
            mask <span class="token operator">|=</span> POLLERR<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> mask<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>我们看到具体的 poll 函数里会首先执行 poll_wait 函数。这个函数只是简单执行 struct ep_pqueue epq 结构体中的函数，即刚才设置的 ep_ptable_queue_proc。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">//  监听的文件描述符对应的file结构体，whead是等待监听的文件描述符对应的inode可用的队列</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ep_ptable_queue_proc</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">,</span> wait_queue_head_t <span class="token operator">*</span>whead<span class="token punctuation">,</span>
                 poll_table <span class="token operator">*</span>pt<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">struct</span> <span class="token class-name">epitem</span> <span class="token operator">*</span>epi <span class="token operator">=</span> <span class="token function">EP_ITEM_FROM_EPQUEUE</span><span class="token punctuation">(</span>pt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">eppoll_entry</span> <span class="token operator">*</span>pwq<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>epi<span class="token operator">-></span>nwait <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>pwq <span class="token operator">=</span> <span class="token function">PWQ_MEM_ALLOC</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        pwq<span class="token operator">-></span>wait<span class="token operator">-></span>flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        pwq<span class="token operator">-></span>wait<span class="token operator">-></span>task <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置回调</span>
        pwq<span class="token operator">-></span>wait<span class="token operator">-></span>func <span class="token operator">=</span> ep_poll_callback<span class="token punctuation">;</span>
        pwq<span class="token operator">-></span>whead <span class="token operator">=</span> whead<span class="token punctuation">;</span>
        pwq<span class="token operator">-></span>base <span class="token operator">=</span> epi<span class="token punctuation">;</span>
        <span class="token comment">// 插入等待监听的文件描述符的inode可用的队列，回调函数是ep_poll_callback</span>
        <span class="token function">add_wait_queue</span><span class="token punctuation">(</span>whead<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pwq<span class="token operator">-></span>wait<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">list_add_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pwq<span class="token operator">-></span>llink<span class="token punctuation">,</span> <span class="token operator">&amp;</span>epi<span class="token operator">-></span>pwqlist<span class="token punctuation">)</span><span class="token punctuation">;</span>
        epi<span class="token operator">-></span>nwait<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">/* We have to signal that an error occurred */</span>
        epi<span class="token operator">-></span>nwait <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>主要的逻辑是把当前进程插入监听的文件的等待队列中，等待唤醒。</p>
<h5 id="epoll-wait"><a href="#epoll-wait" class="headerlink" title="epoll_wait"></a><strong>epoll_wait</strong></h5><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">asmlinkage <span class="token keyword">long</span> <span class="token function">sys_epoll_wait</span><span class="token punctuation">(</span><span class="token keyword">int</span> epfd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> __user <span class="token operator">*</span>events<span class="token punctuation">,</span>
                   <span class="token keyword">int</span> maxevents<span class="token punctuation">,</span> <span class="token keyword">int</span> timeout<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> error<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">eventpoll</span> <span class="token operator">*</span>ep<span class="token punctuation">;</span>
    <span class="token comment">// 通过epoll的fd拿到对应的file结构体</span>
    file <span class="token operator">=</span> <span class="token function">fget</span><span class="token punctuation">(</span>epfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 通过file结构体拿到eventpoll结构体</span>
    ep <span class="token operator">=</span> file<span class="token operator">-></span>private_data<span class="token punctuation">;</span>
    error <span class="token operator">=</span> <span class="token function">ep_poll</span><span class="token punctuation">(</span>ep<span class="token punctuation">,</span> events<span class="token punctuation">,</span> maxevents<span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> error<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ep_poll</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">eventpoll</span> <span class="token operator">*</span>ep<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> __user <span class="token operator">*</span>events<span class="token punctuation">,</span>
           <span class="token keyword">int</span> maxevents<span class="token punctuation">,</span> <span class="token keyword">long</span> timeout<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> res<span class="token punctuation">,</span> eavail<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> flags<span class="token punctuation">;</span>
    <span class="token keyword">long</span> jtimeout<span class="token punctuation">;</span>
    wait_queue_t wait<span class="token punctuation">;</span>

    <span class="token comment">// 计算超时时间</span>
    jtimeout <span class="token operator">=</span> timeout <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> timeout <span class="token operator">></span> <span class="token punctuation">(</span>MAX_SCHEDULE_TIMEOUT <span class="token operator">-</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">/</span> HZ <span class="token operator">?</span>
        MAX_SCHEDULE_TIMEOUT<span class="token operator">:</span> <span class="token punctuation">(</span>timeout <span class="token operator">*</span> HZ <span class="token operator">+</span> <span class="token number">999</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">;</span>

retry<span class="token operator">:</span>

    res <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// 就绪队列为空</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">list_empty</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ep<span class="token operator">-></span>rdllist<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 加入阻塞队列</span>
        <span class="token function">init_waitqueue_entry</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wait<span class="token punctuation">,</span> current<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">add_wait_queue</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ep<span class="token operator">-></span>wq<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wait<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 挂起</span>
            <span class="token function">set_current_state</span><span class="token punctuation">(</span>TASK_INTERRUPTIBLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 超时或者有就绪事件了，则跳出返回</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">list_empty</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ep<span class="token operator">-></span>rdllist<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>jtimeout<span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token comment">// 被信号唤醒返回EINTR</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">signal_pending</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                res <span class="token operator">=</span> <span class="token operator">-</span>EINTR<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token comment">// 设置定时器，然后进程挂起，等待超时唤醒（超时或者信号唤醒）</span>
            jtimeout <span class="token operator">=</span> <span class="token function">schedule_timeout</span><span class="token punctuation">(</span>jtimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// 移出阻塞队列</span>
        <span class="token function">remove_wait_queue</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ep<span class="token operator">-></span>wq<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wait<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置就绪</span>
        <span class="token function">set_current_state</span><span class="token punctuation">(</span>TASK_RUNNING<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 是否有事件就绪，唤醒的原因有几个，被唤醒不代表就有就绪事件</span>
    eavail <span class="token operator">=</span> <span class="token operator">!</span><span class="token function">list_empty</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ep<span class="token operator">-></span>rdllist<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">write_unlock_irqrestore</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ep<span class="token operator">-></span>lock<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 处理就绪事件返回</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>res <span class="token operator">&amp;&amp;</span> eavail <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span><span class="token punctuation">(</span>res <span class="token operator">=</span> <span class="token function">ep_events_transfer</span><span class="token punctuation">(</span>ep<span class="token punctuation">,</span> events<span class="token punctuation">,</span> maxevents<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> jtimeout<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> retry<span class="token punctuation">;</span>

    <span class="token keyword">return</span> res<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>总的来说 epoll_wait 的逻辑主要是处理就绪队列的节点。<br>1 如果就绪队列为空，则根据 timeout 做下一步处理，可能定时阻塞。<br>2 如果就绪队列非空则处理就绪队列，返回给用户。处理就绪队列的函数是 ep_events_transfer。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ep_events_transfer</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">eventpoll</span> <span class="token operator">*</span>ep<span class="token punctuation">,</span>
                  <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> __user <span class="token operator">*</span>events<span class="token punctuation">,</span> <span class="token keyword">int</span> maxevents<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> eventcnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">list_head</span> txlist<span class="token punctuation">;</span>

    <span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>txlist<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ep_collect_ready_items</span><span class="token punctuation">(</span>ep<span class="token punctuation">,</span> <span class="token operator">&amp;</span>txlist<span class="token punctuation">,</span> maxevents<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        eventcnt <span class="token operator">=</span> <span class="token function">ep_send_events</span><span class="token punctuation">(</span>ep<span class="token punctuation">,</span> <span class="token operator">&amp;</span>txlist<span class="token punctuation">,</span> events<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">ep_reinject_items</span><span class="token punctuation">(</span>ep<span class="token punctuation">,</span> <span class="token operator">&amp;</span>txlist<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> eventcnt<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>主要是三个函数，我们一个个看。<br>1 ep_collect_ready_items 收集就绪事件</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ep_collect_ready_items</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">eventpoll</span> <span class="token operator">*</span>ep<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">list_head</span> <span class="token operator">*</span>txlist<span class="token punctuation">,</span> <span class="token keyword">int</span> maxevents<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> nepi<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> flags<span class="token punctuation">;</span>
    <span class="token comment">// 就绪事件的队列</span>
    <span class="token keyword">struct</span> <span class="token class-name">list_head</span> <span class="token operator">*</span>lsthead <span class="token operator">=</span> <span class="token operator">&amp;</span>ep<span class="token operator">-></span>rdllist<span class="token punctuation">,</span> <span class="token operator">*</span>lnk<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">epitem</span> <span class="token operator">*</span>epi<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>nepi <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> lnk <span class="token operator">=</span> lsthead<span class="token operator">-></span>next<span class="token punctuation">;</span> lnk <span class="token operator">!=</span> lsthead <span class="token operator">&amp;&amp;</span> nepi <span class="token operator">&lt;</span> maxevents<span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 通过结构体字段的地址拿到结构体首地址</span>
        epi <span class="token operator">=</span> <span class="token function">list_entry</span><span class="token punctuation">(</span>lnk<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">epitem</span><span class="token punctuation">,</span> rdllink<span class="token punctuation">)</span><span class="token punctuation">;</span>

        lnk <span class="token operator">=</span> lnk<span class="token operator">-></span>next<span class="token punctuation">;</span>

        <span class="token comment">/* If this file is already in the ready list we exit soon */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">EP_IS_LINKED</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>epi<span class="token operator">-></span>txlink<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

            epi<span class="token operator">-></span>revents <span class="token operator">=</span> epi<span class="token operator">-></span>event<span class="token punctuation">.</span>events<span class="token punctuation">;</span>
            <span class="token comment">// 插入txlist队列，然后处理完再返回给用户</span>
            <span class="token function">list_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>epi<span class="token operator">-></span>txlink<span class="token punctuation">,</span> txlist<span class="token punctuation">)</span><span class="token punctuation">;</span>
            nepi<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token comment">// 从就绪队列中删除</span>
            <span class="token function">EP_LIST_DEL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>epi<span class="token operator">-></span>rdllink<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> nepi<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>2 ep_send_events 判断哪些事件触发了</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ep_send_events</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">eventpoll</span> <span class="token operator">*</span>ep<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">list_head</span> <span class="token operator">*</span>txlist<span class="token punctuation">,</span>
              <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> __user <span class="token operator">*</span>events<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> eventcnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> revents<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">list_head</span> <span class="token operator">*</span>lnk<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">epitem</span> <span class="token operator">*</span>epi<span class="token punctuation">;</span>
    <span class="token comment">// 遍历就绪队列，记录触发的事件</span>
    <span class="token function">list_for_each</span><span class="token punctuation">(</span>lnk<span class="token punctuation">,</span> txlist<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        epi <span class="token operator">=</span> <span class="token function">list_entry</span><span class="token punctuation">(</span>lnk<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">epitem</span><span class="token punctuation">,</span> txlink<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 判断哪些事件触发了</span>
        revents <span class="token operator">=</span> epi<span class="token operator">-></span>ffd<span class="token punctuation">.</span>file<span class="token operator">-></span>f_op<span class="token operator">-></span><span class="token function">poll</span><span class="token punctuation">(</span>epi<span class="token operator">-></span>ffd<span class="token punctuation">.</span>file<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        epi<span class="token operator">-></span>revents <span class="token operator">=</span> revents <span class="token operator">&amp;</span> epi<span class="token operator">-></span>event<span class="token punctuation">.</span>events<span class="token punctuation">;</span>
        <span class="token comment">// 复制到用户空间</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>epi<span class="token operator">-></span>revents<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__put_user</span><span class="token punctuation">(</span>epi<span class="token operator">-></span>revents<span class="token punctuation">,</span>
                       <span class="token operator">&amp;</span>events<span class="token punctuation">[</span>eventcnt<span class="token punctuation">]</span><span class="token punctuation">.</span>events<span class="token punctuation">)</span> <span class="token operator">||</span>
                <span class="token function">__put_user</span><span class="token punctuation">(</span>epi<span class="token operator">-></span>event<span class="token punctuation">.</span>data<span class="token punctuation">,</span>
                       <span class="token operator">&amp;</span>events<span class="token punctuation">[</span>eventcnt<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
            <span class="token comment">// 只监听一次，触发完设置成对任何事件都不感兴趣</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>epi<span class="token operator">-></span>event<span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLONESHOT<span class="token punctuation">)</span>
                epi<span class="token operator">-></span>event<span class="token punctuation">.</span>events <span class="token operator">&amp;=</span> EP_PRIVATE_BITS<span class="token punctuation">;</span>
            eventcnt<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> eventcnt<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>3 ep_reinject_items 重新插入就绪队列</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ep_reinject_items</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">eventpoll</span> <span class="token operator">*</span>ep<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">list_head</span> <span class="token operator">*</span>txlist<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> ricnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> pwake <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> flags<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">epitem</span> <span class="token operator">*</span>epi<span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">list_empty</span><span class="token punctuation">(</span>txlist<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        epi <span class="token operator">=</span> <span class="token function">list_entry</span><span class="token punctuation">(</span>txlist<span class="token operator">-></span>next<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">epitem</span><span class="token punctuation">,</span> txlink<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">EP_LIST_DEL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>epi<span class="token operator">-></span>txlink<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//  水平触发模式则一直通知，即重新加入就绪队列</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">EP_RB_LINKED</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>epi<span class="token operator">-></span>rbn<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>epi<span class="token operator">-></span>event<span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLET<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
            <span class="token punctuation">(</span>epi<span class="token operator">-></span>revents <span class="token operator">&amp;</span> epi<span class="token operator">-></span>event<span class="token punctuation">.</span>events<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">EP_IS_LINKED</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>epi<span class="token operator">-></span>rdllink<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">list_add_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>epi<span class="token operator">-></span>rdllink<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ep<span class="token operator">-></span>rdllist<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ricnt<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>我们发现，并有没有在 epoll_wait 的时候去收集就绪事件，那么就绪队列是谁处理的呢？我们回顾一下插入红黑树的时候，做了一个事情，就是在文件对应的 inode 上注册一个回调。当文件满足条件的时候，就会唤醒因为 epoll_wait 而阻塞的进程。epoll_wait 会收集事件返回给用户。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ep_poll_callback</span><span class="token punctuation">(</span>wait_queue_t <span class="token operator">*</span>wait<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> mode<span class="token punctuation">,</span> <span class="token keyword">int</span> sync<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> pwake <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> flags<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">epitem</span> <span class="token operator">*</span>epi <span class="token operator">=</span> <span class="token function">EP_ITEM_FROM_WAIT</span><span class="token punctuation">(</span>wait<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">eventpoll</span> <span class="token operator">*</span>ep <span class="token operator">=</span> epi<span class="token operator">-></span>ep<span class="token punctuation">;</span>
    <span class="token comment">// 插入就绪队列</span>
    <span class="token function">list_add_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>epi<span class="token operator">-></span>rdllink<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ep<span class="token operator">-></span>rdllist<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 唤醒因epoll_wait而阻塞的进程</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">waitqueue_active</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ep<span class="token operator">-></span>wq<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">wake_up</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ep<span class="token operator">-></span>wq<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">waitqueue_active</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ep<span class="token operator">-></span>poll_wait<span class="token punctuation">)</span><span class="token punctuation">)</span>
        pwake<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>epoll 的实现涉及的内容比较多，先分析一下大致的原理。有机会再深入分析。</p>
<p>发布于 2020-03-28</p>
<h4 id="四、IO-复用中写的问题"><a href="#四、IO-复用中写的问题" class="headerlink" title="四、IO 复用中写的问题"></a>四、IO 复用中写的问题</h4>
                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">iKnow</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://iknow.fun/2021/07/29/c-wang-luo-bian-cheng-cong-socket-dao-epoll/">https://iknow.fun/2021/07/29/c-wang-luo-bian-cheng-cong-socket-dao-epoll/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">iKnow</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/C/">
                                    <span class="chip bg-color">C</span>
                                </a>
                            
                                <a href="/tags/C/">
                                    <span class="chip bg-color">C++</span>
                                </a>
                            
                                <a href="/tags/socket/">
                                    <span class="chip bg-color">socket</span>
                                </a>
                            
                                <a href="/tags/epoll/">
                                    <span class="chip bg-color">epoll</span>
                                </a>
                            
                                <a href="/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/">
                                    <span class="chip bg-color">网络编程</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,qq,qzone,wechat,weibo" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2021/08/03/dou-yu-zhi-bo-cha-jian-zi-dong-qie-huan-zui-gao-hua-zhi-huo-zui-di-hua-zhi/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/12.jpg" class="responsive-img" alt="斗鱼直播油猴脚本：自动切换最高画质或最低画质">
                        
                        <span class="card-title">斗鱼直播油猴脚本：自动切换最高画质或最低画质</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2021-08-03
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/JavaScript/" class="post-category">
                                    JavaScript
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/HTML5/">
                        <span class="chip bg-color">HTML5</span>
                    </a>
                    
                    <a href="/tags/Web/">
                        <span class="chip bg-color">Web</span>
                    </a>
                    
                    <a href="/tags/%E5%89%8D%E7%AB%AF/">
                        <span class="chip bg-color">前端</span>
                    </a>
                    
                    <a href="/tags/JavaScript/">
                        <span class="chip bg-color">JavaScript</span>
                    </a>
                    
                    <a href="/tags/Tampermonkey/">
                        <span class="chip bg-color">Tampermonkey</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2021/07/29/promise-bing-fa-xia-zai/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/21.jpg" class="responsive-img" alt="JavaScript Promise 并发控制下载文件的实现">
                        
                        <span class="card-title">JavaScript Promise 并发控制下载文件的实现</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-07-29
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/JavaScript/" class="post-category">
                                    JavaScript
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Web/">
                        <span class="chip bg-color">Web</span>
                    </a>
                    
                    <a href="/tags/%E5%89%8D%E7%AB%AF/">
                        <span class="chip bg-color">前端</span>
                    </a>
                    
                    <a href="/tags/JavaScript/">
                        <span class="chip bg-color">JavaScript</span>
                    </a>
                    
                    <a href="/tags/Promise/">
                        <span class="chip bg-color">Promise</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>


  <!-- 是否加载使用自带的 prismjs. -->
  <script type="text/javascript" src="/libs/prism/prism.min.js"></script>


<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('3'),
            headingSelector: 'h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2023</span>
            
            <a href="/about" target="_blank">iKnow</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            
            <br>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
<a href="https://space.bilibili.com/588239166" class="tooltipped" target="_blank" data-tooltip="在B站上关注我" data-position="top"
    data-delay="50">
    <i class="fas fa-play-circle"></i>
</a>



<a href="https://github.com/Eished" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub"
    data-position="top" data-delay="50">
    <i class="fab fa-github"></i>
</a>



<a href="mailto:kished@outlook.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我"
    data-position="top" data-delay="50">
    <i class="fas fa-envelope-open"></i>
</a>












</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    
    
    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->
    

</body>

</html>
